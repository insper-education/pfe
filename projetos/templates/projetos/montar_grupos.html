{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 20 de Junho de 2020
{% endcomment %}

{% block head %}
  {% load static %}
  {% load aderencia_aluno %}
  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>
  
  <style>

    body {
      line-height: normal;
    }

    .proposta {
        border: solid;
        width: 100%;
        padding-top: 2px;
        padding-bottom: 2px;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        -ms-flex-pack: distribute;
            justify-content: space-around;
    
    }

    .titulo {
        color: black;
        width: 99%;
        text-align: left;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        margin-bottom: 3px;
    }

    .estudante {
        font-size: 12px;
        font-family: Arial, Helvetica, sans-serif;
        padding-left: 3px;
        width: 24%;
        height: 34px;
        background-color: #F0F0F0;
        border: 2px blue solid;
        color: #000;
        text-align: left;
        -webkit-user-select: none;
        -moz-user-select: none;
            -ms-user-select: none;
                user-select: none;
        margin-bottom: 2px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;

    }
    .dragging {
        background-color: gold;
    }
  </style>

{% endblock %}

{% block content %}
  <h3>Montar Grupos</h3>
  <br>

  {% comment %}
  <label for="filter">Edição:</label>
  <select id="filter" onchange="location = this.options[this.selectedIndex].value;">
    {% for loop in loop_anos %}
      <option value="{{loop}}.2" {% if ano == loop and semestre == 2 %}selected{% endif %}>{{loop}}.2</option>
      <option value="{{loop|add:1}}.1" {% if ano == loop|add:1 and semestre == 1 %}selected{% endif %}>{{loop|add:1}}.1</option>
    {% endfor %}
  </select>
  {% endcomment %}

  {% if propostas %}

    {% for proposta in propostas %}   
      <div id="proposta{{proposta.id}}" class="proposta">
        <div id="titulo{{proposta.id}}" class="titulo">
          <a class="ancora" href="{% url 'proposta_completa' proposta.id %}" style="color: #000062;">{{proposta.titulo}}</a>&nbsp;
          {% if proposta.organizacao and proposta.organizacao.nome %}
            <a class="ancora" href="{% url 'organizacao_completo' proposta.organizacao.id %}" style="color: darkblue;">
              ({{ proposta.organizacao.nome }})
            </a>
          {% elif proposta.nome_organizacao %}
            <a  class="ancora" style="color: darkblue;">({{ proposta.nome_organizacao }})</a>
          {% else %}
            PROBLEMA EM RECUPERAR ORGANIZAÇÃO DA PROPOSTA
          {% endif %}
        </div>
      </div>
      <br><br>
    {% endfor %}

  {% else %}
    <p>Não existem propostas de projetos disponíveis.</p>
  {% endif %}
  <p>&nbsp;</p>


  <script>

    {% for estudante, opcoes in estudantes_opcoes %}
      $("#proposta{{opcoes.0.proposta.id}}").append(`
      <div id="estudante{{estudante.id}}" draggable="true" class="estudante">
      <a class="ancora" href="{% url 'aluno_detail' estudante.id %}"
      data-toggle="tooltip" data-html="true" animation="true"
        title="
        {% for opcao in opcoes %}
          <b>#{{ opcao.prioridade }} :</b>
          {{opcao.proposta.titulo}}
          ({{opcao.proposta.organizacao.nome}})
          |{% mede_aderencia estudante opcao.proposta %}%|
          <br>
        {% empty %}
          Estudante não escolheu opções de proposta de projetos
        {% endfor %}  
        ">
        {{estudante.user.get_full_name}}</a><br>
      [{{estudante.get_curso}}]&nbsp;&nbsp;&nbsp;CR:&nbsp;{{estudante.cr}}
      </div>
      `);
    {% endfor %}


    /* ------- */

    var $draggedItem;

    $(document).ready(function() {
        $('.estudante').on('dragstart', dragging);
        $('.estudante').on('dragend', draggingEnded);
        $('.proposta').on('dragenter', preventDefault);
        $('.proposta').on('dragover', preventDefault);
        $('.proposta').on('drop', dropAluno);
    });

    function colorir_proposta(target) {
        qtd_estudantes = $(target).children('div').length - 1
        if(qtd_estudantes == 0) {
            $(target).css("background-color", "tomato");
        } else if(qtd_estudantes > 4 || qtd_estudantes < 3) {
            $(target).css("background-color", "yellow");
        }
        else {
            $(target).css("background-color", "lime");
        }
    }

    var observer_proposta = new MutationObserver(function( mutations ) {
        mutations.forEach(function( mutation ) {
            target = $(mutation.target)
            colorir_proposta(target);
        });    
    });

    // Configuration of the observer:
    var config = { 
        childList: true
    };

    var propostas = $('.proposta');
    for (var i = 0; i < propostas.length; i++) {
        colorir_proposta(propostas[i]);
        observer_proposta.observe(propostas[i], config);
    }

    // observer_proposta.disconnect();


    function dropAluno(e) {
      if($draggedItem) {
        var target = $(e.target);
        if (target.attr('class')=="proposta") {
            $draggedItem.detach();
            $draggedItem.appendTo(target);
        } else
        if (target.attr('class')=="titulo" || target.attr('class')=="estudante" ) {
            $draggedItem.detach();
            $draggedItem.appendTo(target.parent());
        } else
        if (target.attr('class')=="ancora") {
            $draggedItem.detach();
            $draggedItem.appendTo(target.parent().parent());
        }
      }
    }

    function dragging(e) {
      var target = $(e.target);
      if (target.attr('class')=="estudante") {
        $draggedItem = target;
        $draggedItem.addClass('dragging');
      } else if (target.parent().attr('class')=="estudante") {
        $draggedItem = target.parent();
        $draggedItem.addClass('dragging');
      }
    }

    function draggingEnded(e) {
        $draggedItem.removeClass('dragging');
        $draggedItem = null
    }

    function preventDefault(e) {
        e.preventDefault();
    }

  </script>

{% endblock %}