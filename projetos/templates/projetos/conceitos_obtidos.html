{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 22 de Abril de 2020
{% endcomment %}

{% block head %}
  {% load rubricas %}

  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      text-align: left;
      padding: 8px;
    }

    table, th, td {
      border: 1px solid lightgrey;
    }

    tr:nth-child(even) {background-color: #f2f2f2;}
  </style>

  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>
  <script>
    class Objetivo {
      constructor() { 
        this.avaliacoes = 0;
        this.titulo = "";
        this.rubrica = "";
        this.total = 0;
      }
      soma_conceito(conceito){
        this.avaliacoes += 1
        if(conceito=="A"||conceito=="A ") this.total += 10
        if(conceito=="B"||conceito=="B ") this.total += 8
        if(conceito=="C"||conceito=="C ") this.total += 6
        if(conceito=="D"||conceito=="D ") this.total += 4
        if(conceito=="I"||conceito=="I ") this.total += 0
      }
      media(){
        let nota = (this.total/this.avaliacoes).toPrecision(2)
        if( nota >= 9 ) return ("A")
        if( nota >= 7 ) return ("B")
        if( nota >= 5 ) return ("C")
        if( nota >= 4 ) return ("D")
        return ("I")
      }
      texto() {
        let descricao = ""
        descricao += "<li>"
        descricao += this.titulo
        descricao += ': <span data-toggle="tooltip" data-html="true" animation="true" title="'+this.rubrica+'">'
        descricao += this.media()
        descricao += "</span></li>"
        return (descricao)
      }
    }
    class Banca { 
      constructor() { 
        this.objetivo1 = new Objetivo();
        this.objetivo2 = new Objetivo();
        this.objetivo3 = new Objetivo();
        this.objetivo4 = new Objetivo();
        this.objetivo5 = new Objetivo();
      } 
    }
    let intermediaria = new Banca(); 
    let final = new Banca(); 
  </script>
{% endblock %}

{% block content %}
  {% if projeto.titulo_final %}
    <style>
        h5 {display: inline;}
    </style>
    <h5>Título: {{projeto.titulo_final}}</h5>
    <small> <br>&nbsp;&nbsp;&nbsp;&nbsp;Título Provisório: {{projeto.titulo}}</small><br>
  {% else %}
    <h5>Título: {{projeto.titulo}}</h5>
  {% endif %}
  <strong>Semestre:</strong> {{projeto.ano}}.{{projeto.semestre}}<br>

  {% if projeto.orientador %}
    <strong>Orientador{% if projeto.orientador.user.genero == "F" %}a{% endif %}: </strong>
    <a href="{% url 'professor_detail' projeto.orientador.id %}">
      {{projeto.orientador.user.get_full_name}}
    </a>
    <br>
  {% endif %}
  <strong>Organização: </strong>
    <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">
      {{projeto.organizacao}}
    </a><br>
  
  {% if projeto.avancado %}
    <strong style="color:red"><u>PFE Avançado</u></strong><br>
  {% endif %}
  <strong>Alunos:</strong>
  <ul>
  {% for alocacao in projeto.alocacao_set.all %}
    <a href="{% url 'aluno_detail' alocacao.aluno.id %}">
      <li>
        {{alocacao.aluno.user.get_full_name}} 
        &lt;{{alocacao.aluno.user.email}}&gt; 
        [{{ alocacao.aluno.get_curso_display }}]
      </li>
    </a>
  {% endfor %}
  </ul>
  
  {% if banca_inter %}
    {% for banca in projeto.banca_set.all %}
      {% if banca.tipo_de_banca == 1 %}
        <h5>
          <a href="{% url 'banca_ver' banca.id %}">
            Banca Intermediária
          </a>
        </h5>
      {% endif %}
    {% endfor %}
    <table>
      {% for avaliacao in banca_inter %}
        {% ifchanged avaliacao.avaliador %}
          <tr><td>
            <strong>Avaliador{% if avaliacao.avaliador.genero == "F" %}a{% endif %}: </strong>
              <a href="{% url 'professor_detail' avaliacao.avaliador.professor.id %}">
                {{avaliacao.avaliador.get_full_name}}
              </a>
            <br>
            <strong>Avaliado em: </strong>{{avaliacao.momento}}<br>
            <strong>Conceitos:</strong><br>
            <ul>
            {% if avaliacao.objetivo1 %}
              <li>{{avaliacao.objetivo1.titulo}}: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo1.id|get_texto:avaliacao.objetivo1_conceito}}">
                  {{avaliacao.objetivo1_conceito}}</span></li>
              <script>
                intermediaria.objetivo1.titulo = "{{avaliacao.objetivo1.titulo}}"
                intermediaria.objetivo1.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo1.id|get_texto:avaliacao.objetivo1_conceito}}"
                intermediaria.objetivo1.soma_conceito("{{avaliacao.objetivo1_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo2 %}
              <li>{{avaliacao.objetivo2.titulo}}: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo2.id|get_texto:avaliacao.objetivo2_conceito}}">
                {{avaliacao.objetivo2_conceito}}</span></li>
              <script>
                intermediaria.objetivo2.titulo = "{{avaliacao.objetivo2.titulo}}"
                intermediaria.objetivo2.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo2.id|get_texto:avaliacao.objetivo2_conceito}}"
                intermediaria.objetivo2.soma_conceito("{{avaliacao.objetivo2_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo3 %}
              <li>{{avaliacao.objetivo3.titulo}}: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo3.id|get_texto:avaliacao.objetivo3_conceito}}">
                {{avaliacao.objetivo3_conceito}}</span></li>
              <script>
                intermediaria.objetivo3.titulo = "{{avaliacao.objetivo3.titulo}}"
                intermediaria.objetivo3.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo3.id|get_texto:avaliacao.objetivo3_conceito}}"
                intermediaria.objetivo3.soma_conceito("{{avaliacao.objetivo3_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo4 %}
              <li>{{avaliacao.objetivo4.titulo}}: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo4.id|get_texto:avaliacao.objetivo4_conceito}}">
                {{avaliacao.objetivo4_conceito}}</span></li>
              <script>
                intermediaria.objetivo4.titulo = "{{avaliacao.objetivo4.titulo}}"
                intermediaria.objetivo4.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo4.id|get_texto:avaliacao.objetivo4_conceito}}"
                intermediaria.objetivo4.soma_conceito("{{avaliacao.objetivo4_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo5 %}
              <li>{{avaliacao.objetivo5.titulo}}: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo5.id|get_texto:avaliacao.objetivo5_conceito}}">
                {{avaliacao.objetivo5_conceito}}</span></li>
              <script>
                intermediaria.objetivo5.titulo = "{{avaliacao.objetivo5.titulo}}"
                intermediaria.objetivo5.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo5.id|get_texto:avaliacao.objetivo5_conceito}}"
                intermediaria.objetivo5.soma_conceito("{{avaliacao.objetivo5_conceito}}")
              </script>
            {% endif %}

            {% if avaliacao.observacoes %}
              <li>Observações: {{avaliacao.observacoes}}</li>
            {% endif %}
            </ul>
          </td></tr>
        {% endifchanged %}
      {% endfor %}

      <tr style="background-color: #6060E0; color: white"><td>
        Média das avaliações intermediárias:
        <ul>
        <script>
          if(intermediaria.objetivo1.avaliacoes>0) document.write(intermediaria.objetivo1.texto());
          if(intermediaria.objetivo2.avaliacoes>0) document.write(intermediaria.objetivo2.texto());
          if(intermediaria.objetivo3.avaliacoes>0) document.write(intermediaria.objetivo3.texto());
          if(intermediaria.objetivo4.avaliacoes>0) document.write(intermediaria.objetivo4.texto());
          if(intermediaria.objetivo5.avaliacoes>0) document.write(intermediaria.objetivo5.texto());
        </script>
        </ul>
      </td></tr>

    </table>
  {% endif %}

  <br>

  {% if banca_final %}
    {% for banca in projeto.banca_set.all %}
      {% if banca.tipo_de_banca == 0 %}
        <h5>
          <a href="{% url 'banca_ver' banca.id %}">
            Banca Final
          </a>
        </h5>
      {% endif %}
    {% endfor %}
    <table>
      {% for avaliacao in banca_final %}
        {% ifchanged avaliacao.avaliador %}
          <tr><td>
            <strong>Avaliador(a): </strong>
              <a href="{% url 'professor_detail' avaliacao.avaliador.professor.id %}">
                {{avaliacao.avaliador.get_full_name}}
              </a>
            <br>
            <strong>Avaliado em: </strong>{{avaliacao.momento}}<br>
            {% if avaliacao.objetivo1 %}
              &nbsp;&nbsp;<strong>{{avaliacao.objetivo1.titulo}}</strong>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo1.id|get_texto:avaliacao.objetivo1_conceito}}">
                  {{avaliacao.objetivo1_conceito}}</span><br>
              <script>
                final.objetivo1.titulo = "{{avaliacao.objetivo1.titulo}}"
                final.objetivo1.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo1.id|get_texto:avaliacao.objetivo1_conceito}}"
                final.objetivo1.soma_conceito("{{avaliacao.objetivo1_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo2 %}
              &nbsp;&nbsp;<strong>{{avaliacao.objetivo2.titulo}}</strong>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo2.id|get_texto:avaliacao.objetivo2_conceito}}">
                {{avaliacao.objetivo2_conceito}}</span><br>
              <script>
                final.objetivo2.titulo = "{{avaliacao.objetivo2.titulo}}"
                final.objetivo2.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo2.id|get_texto:avaliacao.objetivo2_conceito}}"
                final.objetivo2.soma_conceito("{{avaliacao.objetivo2_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo3 %}
              &nbsp;&nbsp;<strong>{{avaliacao.objetivo3.titulo}}</strong>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo3.id|get_texto:avaliacao.objetivo3_conceito}}">
                {{avaliacao.objetivo3_conceito}}</span><br>
              <script>
                final.objetivo3.titulo = "{{avaliacao.objetivo3.titulo}}"
                final.objetivo3.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo3.id|get_texto:avaliacao.objetivo3_conceito}}"
                final.objetivo3.soma_conceito("{{avaliacao.objetivo3_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo4 %}
              &nbsp;&nbsp;<strong>{{avaliacao.objetivo4.titulo}}</strong>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo4.id|get_texto:avaliacao.objetivo4_conceito}}">
                {{avaliacao.objetivo4_conceito}}</span><br>
              <script>
                final.objetivo4.titulo = "{{avaliacao.objetivo4.titulo}}"
                final.objetivo4.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo4.id|get_texto:avaliacao.objetivo4_conceito}}"
                final.objetivo4.soma_conceito("{{avaliacao.objetivo4_conceito}}")
              </script>
            {% endif %}
            {% if avaliacao.objetivo5 %}
              &nbsp;&nbsp;<strong>{{avaliacao.objetivo5.titulo}}</strong>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:avaliacao.objetivo5.id|get_texto:avaliacao.objetivo5_conceito}}">
                {{avaliacao.objetivo5_conceito}}</span><br>
              <script>
                final.objetivo5.titulo = "{{avaliacao.objetivo5.titulo}}"
                final.objetivo5.rubrica = "{{objetivos|get_rubrica:avaliacao.objetivo5.id|get_texto:avaliacao.objetivo5_conceito}}"
                final.objetivo5.soma_conceito("{{avaliacao.objetivo5_conceito}}")
              </script>
            {% endif %}

            {% if avaliacao.observacoes %}
              &nbsp;&nbsp;<strong>Observações</strong>: {{avaliacao.observacoes}}<br>
            {% endif %}

            <br>
          </td></tr>
        {% endifchanged %}
      {% endfor %}
      
      <tr style="background-color: #6060E0; color: white"><td>
        Média das avaliações finais:
        <ul>
        <script>
          if(final.objetivo1.avaliacoes>0) document.write(final.objetivo1.texto());
          if(final.objetivo2.avaliacoes>0) document.write(final.objetivo2.texto());
          if(final.objetivo3.avaliacoes>0) document.write(final.objetivo3.texto());
          if(final.objetivo4.avaliacoes>0) document.write(final.objetivo4.texto());
          if(final.objetivo5.avaliacoes>0) document.write(final.objetivo5.texto());
        </script>
        </ul>
      </td></tr>

    </table>
  {% endif %}




{% endblock %}