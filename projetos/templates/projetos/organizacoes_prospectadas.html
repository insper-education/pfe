{% extends "base.html" %}
{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 15 de Maio de 2020
{% endcomment %}

{% block head %}
  {% load static %}
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script>
      var todos_contactados = 0
      var so_contactados = 0
      var confirmados = 0
      var interessados = 0
      var recusados = 0
  </script>
  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>
{% endblock %}

{% block content %}
  <h3>Organizações prospectadas nos últimos 3 mêses</h3>
  <label for="filter">Filtrar:</label>
  <select id="filter" class="filter" data-tableId="OrganizacoesTable">
    <option value="todas">todas contactadas</option>
    <option value="contactadas" {% if filtro == "todas contactadas" %}selected="selected"{% endif %}>todas em contato</option>
    <option value="0" {% if filtro == "sem retorno" %}selected="selected"{% endif %}>sem retorno</option>
    <option value="1" {% if filtro == "confirmadas" %}selected="selected"{% endif %}>confirmadas</option>
    <option value="2" {% if filtro == "interessadas" %}selected="selected"{% endif %}>interessadas</option>
    <option value="3" {% if filtro == "recusaram" %}selected="selected"{% endif %}>recusaram</option>
  </select>

  <br><br>
  {% if organizacoes_list %}
    <table id="OrganizacoesTable">
      <tr>
        <th onclick="w3.sortHTML('#OrganizacoesTable', '.item', 'td:nth-child(1)')" style="cursor:pointer" class="text-center">
          Organização
        </th>

        <th onclick="w3.sortHTML('#OrganizacoesTable', '.item', 'td:nth-child(2)')" style="cursor:pointer" class="text-center">
          Último<br>Contato
        </th>
        
        <th onclick="w3.sortHTML('#OrganizacoesTable', '.item', 'td:nth-child(3)')" style="cursor:pointer" class="text-center">
          Mensagem
        </th>
        
        <th onclick="w3.sortHTML('#OrganizacoesTable', '.item', 'td:nth-child(4)')" style="cursor:pointer" class="text-center">
          <a data-toggle="tooltip" data-html="true" animation="true" title="Contando somente as propostas já autorizadas e disponibilizadas para os estudantes aplicarem"><small>Propostas<br>Disponíveis</small>
        </th>

        <th onclick="w3.sortHTML('#OrganizacoesTable', '.item', 'td:nth-child(5)')" style="cursor:pointer" class="text-center">
          <a data-toggle="tooltip" data-html="true" animation="true" title="Contando todas as propostas submetidas pela organização, mesmo aquelas que não estão disponibilizadas para os estudantes aplicarem"><small>Propostas<br>Enviadas</small>
        </th>
      </tr>
      {% for organizacao,disponiveis,submetidas,contato in organizacoes_list %} 
        <tr class="item" 
        {% if contato != '---------' %}
            style=
            {% if contato.tipo_de_retorno == 0 %}
              "background-color:lightblue" 
            {% elif contato.tipo_de_retorno == 1 %}
              "background-color:lightgreen"
            {% elif contato.tipo_de_retorno == 2 %}
              "background-color:lemonchiffon"
            {% elif contato.tipo_de_retorno == 3 %}
              "background-color:pink" 
            {% endif %}
            data-type="{{contato.tipo_de_retorno}}"
        {% endif %}
        >
          <td>
            <a href="{% url 'organizacao_completo' organizacao.id %}">
              {{organizacao.nome}}
            </a>
          </td>
          <td>
            {% if contato == '---------' %}
              ---------
            {% else %}
              {{contato.momento|date:"d/m/Y"}}
            {% endif %}
          </td>
          <td>
            {% if contato == '---------' %}
              ---------
            {% else %}
              {{contato.texto}}
            {% endif %}
          </td>
          <td class="text-center">
            {{disponiveis|stringformat:"03d"}}
          </td>
          <td class="text-center">
            {{submetidas|stringformat:"03d"}}
          </td>
        </tr>
        {% if contato != '---------' %}
          {% if contato.momento|date:'Ymd' > meses3|date:'Ymd' %}
            <script>todos_contactados += 1</script>
            {% if contato.tipo_de_retorno == 0 %}
              <script>so_contactados += 1</script>
            {% elif contato.tipo_de_retorno == 1 %}
              <script>confirmados += 1</script>
            {% elif contato.tipo_de_retorno == 2 %}
              <script>interessados += 1</script>
            {% elif contato.tipo_de_retorno == 3 %}
              <script>recusados += 1</script>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    </table>
    Organizações contactadas recentemente ({{total_organizacoes}}):<br>
    &nbsp;<span style="background-color:lightblue">&nbsp;&nbsp;&nbsp;&nbsp;</span> Sondada (<script>document.write(so_contactados);</script>)<br>
    &nbsp;<span style="background-color:pink">&nbsp;&nbsp;&nbsp;&nbsp;</span> Declinou (<script>document.write(recusados);</script>)<br>
    &nbsp;<span style="background-color:lemonchiffon">&nbsp;&nbsp;&nbsp;&nbsp;</span> Interessada (<script>document.write(interessados);</script>)<br>
    &nbsp;<span style="background-color:lightgreen">&nbsp;&nbsp;&nbsp;&nbsp;</span> Confirmada (<script>document.write(confirmados);</script>)<br>
    <p>&nbsp;</p>
    <strong>Total de Propostas Submetidas:</strong> {{ total_disponiveis }}
    <a data-toggle="tooltip" data-html="true" animation="true" title="Contando todas as propostas, incluindo as (ainda) não disponibilizadas para os estudantes.">
        ({{ total_submetidas }})
      </a><br>

    <br>
  {% else %}
    <p>Não existem organizações cadastradas.</p>
  {% endif %}

  <p>&nbsp;</p>

  <script type="text/javascript">

    function filtra_data() {  // REFERENTE AO SELETOR DE DATAS
      var filterValue = $('.filter').val();
      var row = $('.item'); 
      row.hide();

      row.each(function(i, el) {
        
        if( filterValue == "todas" || filterValue == $(el).attr('data-type') ) {
            $(el).show();
        }
        else if( filterValue == "contactadas" && $(el).attr('data-type') > 0 ) {
            $(el).show();
        }

      });
    }

    $(".filter").change(function(){
      filtra_data();
    });  

    $(document).ready(function(){
      filtra_data();
    });
  
  </script>

{% endblock %}