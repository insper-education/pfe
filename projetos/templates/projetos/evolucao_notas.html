{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 22 de Setembro de 2020
{% endcomment %}

{% block head %}

  {% load static %}
  {% load addstr %}
  {% load l10n %}

  <script src="{% static 'js/w3.js' %}"></script>
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>

  {% comment %} Para chamar os Tooltips {% endcomment %}
  <script>{% include "tooltip.js" %}</script>

  {% comment %} Para gerar as imagens {% endcomment %}
  <script src="{% static 'js/html2canvas.min.js' %}"></script>
  <script src="{% static 'js/jspdf.min.js' %}"></script>

  <style>
    .cabecalho {
      float: left;
      position: relative;
      margin-top: 0px;
      outline-width: 0;
      background-color: none;
    }
  </style>

{% endblock %}

{% block content %}

    <script>
        function ajusta() { }
        function reajusta() { }
    </script>

    <div id="tudo">

        <div class="cabecalho">

            <span class="titulo">Evolução por Notas/Conceitos</span>
            <small>(esta janela está muito lenta pela grande quantidade de cálculos)</small><br><br>
            
            {% comment %} Seletor da edição da pesquisa {% endcomment %}
            {% include "edicoes.html" with sem_edicao=True com_cursos=True %}
            
        </div>
    
    <div class="atualizar">

        {% if curso %}
            {% with file_name="evolucao_notas_"|addstr:curso %}
                {% include "save_image.html" %}
            {% endwith %}
        {% endif %}

        <div><br><br><br></div>{% comment %} Solução pouco elegante, mas funciona. {% endcomment %}

        <div class="container">

            <div style="width:860px;"> 
                <canvas id="chart-medias-individuais"></canvas>
                <br>
                <canvas id="chart-medias-gerais"></canvas>
            </div>

            <script>
        
                var config_medias_individuais = {
                    type: 'line',
                    data: {
                        labels: [
                            {% for edicao in edicoes %}"{{edicao}}",{% endfor %}
                        ],
                        datasets: [
                            {% for media in medias_individuais %}
                                { 
                                    data: [
                                        {% for nota in media.media %}
                                            {{nota|stringformat:".2f"|unlocalize}},
                                        {% endfor %}
                                    ],
                                    label: "{{media.curso.sigla}}",
                                    borderColor: "#{{media.curso.cor}}",
                                    fill: false,
                                    spanGaps: true,
                                },
                            {% endfor %}
                        ]
                    },
                    options: {
                        title: { display: true,
                                 text: 'Evolução de notas individuais'}, 
                    }
                }

        
                var config_medias_gerais = {
                    type: 'line',
                    data: {
                        labels: [{% for edicao in edicoes %}"{{edicao}}",{% endfor %}],
                        datasets: [
                            {% for media in medias_gerais %}
                                { 
                                    data: [
                                        {% for nota in media.media %}
                                            {{nota|stringformat:".2f"|unlocalize}},
                                        {% endfor %}
                                    ],
                                    label: "{{media.curso.sigla}}",
                                    borderColor: "#{{media.curso.cor}}",
                                    fill: false,
                                    spanGaps: true,
                                },
                            {% endfor %}
                        ]
                    },
                    options: {
                        title: { display: true,
                                 text: 'Evolução médias gerais'}, 
                    }
                }

                function carrega_pagina() {  

                    // Chart do média individuais
                    var chart_medias_individuais = document.getElementById('chart-medias-individuais').getContext('2d');
                    window.medias = new Chart(chart_medias_individuais, config_medias_individuais);

                    // Chart do média gerais
                    var chart_medias_gerais = document.getElementById('chart-medias-gerais').getContext('2d');
                    window.medias = new Chart(chart_medias_gerais, config_medias_gerais);

                }

                window.onload = carrega_pagina
            
            </script>

        </div>
    </div>
    </div>

    {% include "edicoes_ajax.html" with sem_edicao=True com_cursos=True %}

{% endblock %}