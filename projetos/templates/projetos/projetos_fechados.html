{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 21 de Junho de 2019
{% endcomment %}

{% block head %}
  {% load static %}
  {% comment %} Para desenhar gráficos na página {% endcomment %}
  <script src="{% static 'js/Chart.min.js' %}"/></script>

  <style>
    .prioridade {
      display: inline
    }

    .logotipo_left {
      max-height:64px;
      max-width:128px;
      height:auto;
      width:auto;
    }
    
  </style>


  <style>
    .arrow {
      border: solid black;
      border-width: 0px 2px 2px 0px;
      display: inline-block;
      padding: 2px;
      vertical-align: middle;
    }

    .right {
      transform: rotate(-45deg);
      -webkit-transform: rotate(-45deg);
    }

    #toggle {
      display:inline-block; 
    }

  </style>

{% endblock %}

{% block content %}

  {% include "impressora.html" %}

  <span class="titulo">Projetos</span>
  
  {% comment %} Seletor da edição da pesquisa {% endcomment %}
  {% include "edicoes.html" %}

  <script>
    $(document).on('click','#informacoes_tag',function(){
      $( "#toggle" ).toggle( "slide" );
    });
  </script>

  <span id="informacoes" style="border: 1px solid gray; border-radius: 2px; padding: 1px; margin-left: 20px;">
    <span id="informacoes_tag">&nbsp;Informações <i class="arrow right"></i>&nbsp;</span>
    <div id="toggle" style="display: none; height: 1em;">
      <label><input id="logo" onchange="($(this).prop('checked') ? $('.logo').show() : $('.logo').hide())" type="checkbox" checked /> Logo</label>&nbsp;&nbsp;&nbsp;
      <label><input id="descricao" onchange="($(this).prop('checked') ? $('.descricao').show() : $('.descricao').hide())" type="checkbox" checked /> Descrição</label>&nbsp;&nbsp;&nbsp;
      <label><input id="apresentacoes" onchange="($(this).prop('checked') ? $('.apresentacao').show() : $('.apresentacao').hide())" type="checkbox" checked /> Apresentações</label>&nbsp;&nbsp;&nbsp;
      <label><input id="orientador" onchange="($(this).prop('checked') ? $('.orientador').show() : $('.orientador').hide())" type="checkbox" checked /> Orientador</label>&nbsp;&nbsp;&nbsp;
      <label><input id="estudantes" onchange="($(this).prop('checked') ? $('.estudantes').show() : $('.estudantes').hide())" type="checkbox" checked /> Estudantes</label>&nbsp;&nbsp;&nbsp;
      <label><input id="curso" onchange="($(this).prop('checked') ? $('.curso').show() : $('.curso').hide())" type="checkbox" checked /> Cursos</label>&nbsp;&nbsp;&nbsp;
      <label><input id="organizacao" onchange="($(this).prop('checked') ? $('.organizacao').show() : $('.organizacao').hide())" type="checkbox" checked /> Organização</label>&nbsp;&nbsp;&nbsp;
      <label><input id="conexoes" onchange="($(this).prop('checked') ? $('.conexoes').show() : $('.conexoes').hide())" type="checkbox" checked /> Conexões</label>&nbsp;&nbsp;&nbsp;
      <label><input id="papeis" onchange="($(this).prop('checked') ? $('.papeis').show() : $('.papeis').hide())" type="checkbox" checked /> Papéis</label>&nbsp;&nbsp;&nbsp;
      <label><input id="totais" onchange="($(this).prop('checked') ? $('.totais').show() : $('.totais').hide())" type="checkbox" checked /> Totais</label>&nbsp;&nbsp;&nbsp;
      <label><input id="grafico" onchange="($(this).prop('checked') ? $('.grafico').show() : $('.grafico').hide())" type="checkbox" checked /> Gráfico</label>&nbsp;&nbsp;&nbsp;
      <label><input id="emails" onchange="($(this).prop('checked') ? $('.emails').show() : $('.emails').hide())" type="checkbox" checked /> e-mails</label>&nbsp;&nbsp;&nbsp;
    </div>
  </span>

  {% comment %} 
  <script>
    $("#informacoes").detach().appendTo("#lateral");
  </script>
  {% endcomment %}

  <br>
  
  {% comment %} Tabela com todos os projetos selecionados pelo filtro {% endcomment %}
  <div class="atualizar m-2">
    
    {% if projetos %}
      <table id="projetos">
      {% for projeto, prioridades, cooperacoes, conexoes in projetos %} 
        <tr id="two" class="row" data-type="{{projeto.ano}}.{{projeto.semestre}}">
        <td id="ptd" style="margin-bottom:3em;">
        <span class="logo">
          {% if projeto.organizacao.logotipo %}
            <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">
              <img class="logotipo_left" src="{{ projeto.organizacao.logotipo.url }}" alt="{{ projeto.organizacao.sigla }}">
            </a>
          {% endif %}
          {% for conexao in cooperacoes %}
            {% if conexao.parceiro and conexao.parceiro.organizacao and conexao.parceiro.organizacao.logotipo %}
              &nbsp;
              <a href="{% url 'organizacao_completo' conexao.parceiro.organizacao.id %}">
                <img class="logotipo_left" src="{{ conexao.parceiro.organizacao.logotipo.url }}" alt="{{ conexao.parceiro.organizacao.sigla }}">
              </a>
            {% endif %}
          {% endfor %}
          <br>
        </span>
        
        <b>Projeto:</b>
        <a class="imprimir" target="_blank" rel="noopener noreferrer" href="{% url 'projeto_completo' projeto.id %}" class="dark-blue-bold"> 
          {% if projeto.titulo_final %}
            {{projeto.titulo_final}}<br>
            <small>Título original: {{projeto.titulo}}</small><br>
          {% else %}
            {{projeto.titulo}}<br>
          {% endif %}
        </a>

        <p class="descricao">
          {% if projeto.descricao %}
            <small><b>Descrição projeto:</b> {{projeto.descricao}}</small><br>
          {% else %}
            <small><b>Descrição proposta:</b> {{projeto.proposta.descricao}}</small><br>
          {% endif %}
        </p>

        <p class="apresentacao_organizacao apresentacao">
          {% if projeto.proposta.descricao_organizacao %}
            <small><b>Apresentação da Organizaçã Parceira:</b> {{projeto.proposta.descricao_organizacao}}</small><br>
          {% endif %}
        </p>

        <p class="apresentacao_departamento apresentacao">
          {% if projeto.proposta.departamento %}
            <small><b>Apresentação do Departamento:</b> {{projeto.proposta.departamento}}</small><br>
          {% endif %}
        </p>

        {% if projeto.avancado or projeto.proposta.internacional %}
          <p style="margin-left:1em;">Tipo:

            {% if projeto.avancado %}
              <font color="red">PFE Avançado</font>
            {% endif %}

            {% if projeto.avancado and projeto.proposta.internacional %}
            /
            {% endif %}

            {% if projeto.proposta.internacional %}
              <font color="red">Internacional</font>
            {% endif %}
            
          </p>
        {% endif %}

        <p class="semestre" style="margin-left:1em; display: none;"><b>Semestre:</b>
          {{projeto.ano}}.{{projeto.semestre}}
        </p>

        <!-- <p style="margin-left:1em;">Edição: {{projeto.ano}}.{{projeto.semestre}}</p> -->
        <p class="orientador" style="margin-left:1em;"><b>Orientador:</b>
          {% if projeto.orientador %}
            <a class="imprimir" href="{% url 'professor_detail' projeto.orientador.id %}"> {{projeto.orientador.user.get_full_name}}</a>
            <span class="emails"><a href="mailto:{{projeto.orientador.user.email}}"> &lt;{{projeto.orientador.user.email}}&gt;</a></span>
          {% else %}
            Não definido
          {% endif %}
        </p>
        
        <p class="estudantes" style="margin-left:1em;"><b>Estudantes:</b></p>
        <ol class="estudantes" style="margin-bottom:5px;">
        {% for aluno,prioridade in prioridades %}
          <li><a class="imprimir" href="{% url 'estudante_detail' aluno.id %}"
              data-toggle="tooltip" data-html="true" animation="true" title="
              {% if prioridade == 0 %}
                opção não definida
              {% else %}
                opção #{{prioridade}}
              {% endif %}">
                {{aluno.user.get_full_name}}
                <span class="curso">[{{ aluno.get_curso_display }}]</span>
              </a>
              <span class="emails"><a href="mailto:{{aluno.user.email}}">&lt;{{aluno.user.email}}&gt;</a></span>
              <div class="prioridade" style="display: none;">{{prioridade}}</div> <!-- para mostrar no gráfico -->
              <!-- &nbsp; { {{ aluno.alocacao_set.first.get_conceito_display }} } -->
          </li>
        {% endfor %}
        </ol>

        <p class="organizacao" style="margin-left:1em;"><b>Organização:</b>
          <a class="imprimir" href="{% url 'organizacao_completo' projeto.organizacao.id %}">
            {{ projeto.organizacao.nome }}
          </a>
          {% for cooperacao in cooperacoes %}
            {% if cooperacao.parceiro and cooperacao.parceiro.organizacao %}
              &nbsp;&nbsp;&nbsp;&nbsp;colaboração:
              <a href="{% url 'organizacao_completo' cooperacao.parceiro.organizacao.id %}">
                {{ cooperacao.parceiro.organizacao.nome }}
              </a>
            {% endif %}
          {% endfor %}
        </p>

        <ol class="conexoes" style="margin-bottom:0px;">
        {% for conexao in conexoes %}
          <li>
          {% if conexao.parceiro.user.is_active %}
            <a class="imprimir" href="{% url 'parceiro_detail' conexao.parceiro.id %}">
              {{ conexao.parceiro.user.get_full_name }}
              <span class="papeis">
                {% if conexao.gestor_responsavel %}
                  [gestor responsavel]
                {% endif %}
                {% if conexao.mentor_tecnico %}
                  [mentoria técnica]
                {% endif %}
                {% if conexao.recursos_humanos %}
                  [recursos humanos]
                {% endif %}
                {% if conexao.colaboracao %}
                  [colaboração]
                {% endif %}
                {% if conexao.observacao %}
                  &nbsp;&nbsp;obs: {{conexao.observacao}}
                {% endif %}
              </span>
            </a>
            <span class="emails"><a href="mailto:{{conexao.parceiro.user.email}}"> &lt;{{conexao.parceiro.user.email}}&gt;</a></span>
          {% else %}
            <a class="imprimir" href="{% url 'parceiro_detail' conexao.parceiro.id %}" style="color: LightBlue;">
              {{ conexao.parceiro.user.get_full_name }}
              <span style="color: lightgrey;">
              {% if conexao.gestor_responsavel %}
                [gestor responsavel]
              {% endif %}
              {% if conexao.mentor_tecnico %}
                [mentoria técnica]
              {% endif %}
              {% if conexao.recursos_humanos %}
                [recursos humanos]
              {% endif %}
              {% if conexao.colaboracao %}
                [colaboração]
              {% endif %}
              {% if conexao.observacao %}
                &nbsp;&nbsp;obs: {{conexao.observacao}}
              {% endif %}
              </span>
            </a>
            <span class="emails"><a href="mailto:{{conexao.parceiro.user.email}}" style="color: LightBlue;"> &lt;{{conexao.parceiro.user.email}}&gt;</a></span>
            <br>
          {% endif %}
          </li>
        {% endfor %}
        </ol>
        </td></tr>
      {% endfor %}
      </table>


      <hr>
      <div class="totais">
        <b>Total de projetos = <span id="myCountProj">{{ numero_projetos }}</span> </b> <br>
        <b>Total de estudantes = <span id="myCountAlun">{{ numero_estudantes }}</span> </b> <br>    
        <br><br>
      </div>

      <div class="grafico" id="canvas-holder">
        <canvas id="chart-area"></canvas>
      </div>

    <br><br>
    
    <script>
      var count_projects = 0;
      var count_alunos = 0;
      var prioridade1 = 0;
      var prioridade2 = 0;
      var prioridade3 = 0;
      var prioridade4 = 0;
      var prioridade5 = 0;
      var prioridade6m = 0;
      var nao_definido = 0;
    </script>

    <script>

      function filtra_data() {  // REFERENTE AO SELETOR DE DATAS

        count_projects = 0;
        count_alunos = 0;
        prioridade1 = 0;
        prioridade2 = 0;
        prioridade3 = 0;
        prioridade4 = 0;
        prioridade5 = 0;
        prioridade6m = 0;
        nao_definido = 0;

        var row = $('.row'); 
        row.each(function(i, el) {

          count_projects = count_projects + 1;
          var alunos = $(el).find("TD").find("OL");
          count_alunos = count_alunos + alunos.children().length;

          $.each(alunos.children('li'), function() {
            var target = $(this)
            data = $(target).find('div.prioridade').text();
            if(data == 1) {prioridade1 += 1;}
            else if(data == 2) {prioridade2 += 1;}
            else if(data == 3) {prioridade3 += 1;}
            else if(data == 4) {prioridade4 += 1;}
            else if(data == 5) {prioridade5 += 1;}
            else if(data > 5) {prioridade6m += 1;}
            else {nao_definido +=1;}
          });

        });

      }

      function mostra_grafico() { // REFERENTE AO PIE CHART
        var config = {     // REFERENTE AO PIE CHART
          type: 'pie',
          data: {
            datasets: [{
              data: [
                prioridade1,
                prioridade2,
                prioridade3,
                prioridade4,
                prioridade5,
                prioridade6m,
              ],
              backgroundColor: [
                "#2ecc71",
                "#3498db",
                "#95a5a6",
                "#9b59b6",
                "#f1c40f",
                "#e74c3c",
                "#34495e"
              ],
            }],
            labels: [
              '#1 ['+parseInt(100*prioridade1/(count_alunos-nao_definido))+'%]',
              '#2 ['+parseInt(100*prioridade2/(count_alunos-nao_definido))+'%]',
              '#3 ['+parseInt(100*prioridade3/(count_alunos-nao_definido))+'%]',
              '#4 ['+parseInt(100*prioridade4/(count_alunos-nao_definido))+'%]',
              '#5 ['+parseInt(100*prioridade5/(count_alunos-nao_definido))+'%]',
              '#>=6 ['+parseInt(100*prioridade6m/(count_alunos-nao_definido))+'%]',
            ]
          },
          options: {
            responsive: true,
            title: {
                  display: true,
                  text: 'Proporção entre opção alocada dos alunos',
                  position: "top",
            },
            legend: {
              display: true,
              position: "bottom",
              labels: {
                fontColor: "#333",
                fontSize: 14
              }
            }
          }
        };

        var context = $("#chart-area").get(0).getContext('2d'); // REFERENTE AO PIE CHART
        window.myPie = new Chart(context, config); // REFERENTE AO PIE CHART
      }

      ($('#logo').prop('checked') ? $('.logo').show() : $('.logo').hide());
      ($('#descricao').prop('checked') ? $('.descricao').show() : $('.descricao').hide());
      ($('#organizacao').prop('checked') ? $('.organizacao').show() : $('.organizacao').hide());
      ($('#orientador').prop('checked') ? $('.orientador').show() : $('.orientador').hide());
      ($('#estudantes').prop('checked') ? $('.estudantes').show() : $('.estudantes').hide());
      ($('#totais').prop('checked') ? $('.totais').show() : $('.totais').hide());
      ($('#grafico').prop('checked') ? $('.grafico').show() : $('.grafico').hide());

      {% comment %} // Só mostra informação de semestre se edição é todas {% endcomment %}
      ($("#filterEdicao option:selected").attr("value") == "todas" ? $('.semestre').show() : $('.semestre').hide());

      filtra_data();
      mostra_grafico();

    </script>

    {% endif %}

    <script>
      function carrega_pagina() {
      };
      $(document).ready(carrega_pagina);
    </script>
    
  </div>
  <p>&nbsp;</p>

  {% include "edicoes_ajax.html" %}

{% endblock %}