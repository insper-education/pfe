{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Abril de 2020
{% endcomment %}

{% block head %}
  {% load static %}
  {% load aderencia_aluno %}
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>
  <script>
    var publicados = 0
    var fechados = 0
    var tmp_computacao = 0
    var tmp_mecatronica = 0
    var tmp_mecanica = 0
    var alunos_computacao = 0
    var alunos_mecatronica = 0
    var alunos_mecanica = 0
    var alunos_computacao_disponivel = 0
    var alunos_mecatronica_disponivel = 0
    var alunos_mecanica_disponivel = 0
    var proposta_computacao = 0
    var proposta_mecatronica = 0
    var proposta_mecanica = 0
    var proposta_multidisciplinar = 0
    var proposta_computacao_disponivel = 0
    var proposta_mecatronica_disponivel = 0
    var proposta_mecanica_disponivel = 0
    var proposta_multidisciplinar_disponivel = 0
  </script>
{% endblock %}

{% block content %}
  <h3>
    {% if periodo == "todos" %}
      Todos as Propostas
    {% else %}
      Propostas
      {% if periodo == "antigos" %}
        publicadas antes de 
      {% elif periodo == "atuais" %}
        disponíveis em
      {% elif periodo == "disponiveis" %}
        após
      {% endif %}
      {{configuracao.ano}}.{{configuracao.semestre}}
    {% endif %}
  </h3>

  <select onchange="location = this.options[this.selectedIndex].value;">
    <option value="todos" {% if periodo == "todos" %}selected="selected"{% endif %}>todos</option>
    <option value="antigos" {% if periodo == "antigos" %}selected="selected"{% endif %}>antigos</option>
    <option value="atuais" {% if periodo == "atuais" %}selected="atuais"{% endif %}>atuais</option>
    <option value="disponiveis" {% if periodo == "disponiveis" %}selected="disponiveis"{% endif %}>disponíveis</option>
  </select>
  <br><br>

  {% if propostas %}
    <table id="PropostasTable">
      <tr>
        <th class="text-center">Fechado</th>
        <th onclick="w3.sortHTML('#PropostasTable', '.item', 'td:nth-child(2)')" style="cursor:pointer" class="text-center">Projeto</th>
        <th onclick="w3.sortHTML('#PropostasTable', '.item', 'td:nth-child(3)')" style="cursor:pointer" class="text-center">Período</th>
        <th onclick="w3.sortHTML('#PropostasTable', '.item', 'td:nth-child(4)')" style="cursor:pointer" class="text-center">Organização</th>
        <th>Aluno1</th>
        <th>Aluno2</th>
        <th>Aluno3</th>
        <th>Aluno4</th>
      </tr>      
      {% for proposta in propostas %} 
      {% with disponivel=proposta.disponivel %}
      
        <tr class="item">

          {% if disponivel %}<script>publicados += 1</script>{% endif %}
          {% if proposta.fechada  %}
            <td class="text-success"  style="text-align:center">
              <script>fechados += 1</script>
          {% else %}
            <td class="text-danger"  style="text-align:center">
          {% endif %}
            &#x2B24;
          </td>
          <td>
          
            {% if not disponivel %}<del>{% endif %}
            <a href="{% url 'proposta_completa' proposta.id %}"
              data-toggle="tooltip" data-html="true" animation="true" title="
              {% for opcaop in proposta.opcao_set.all %}
                {% with alocacoes=opcaop.aluno.alocacao_set %}
                  {% if alocacoes.count %}
                    {% if opcaop.proposta == alocacoes.last.proposta %}
                      <u>
                      {% if opcaop.aluno %}
                        {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                      {% endif %}
                      #{{ opcaop.prioridade }}
                      </u>
                    {% else %}
                      {% if opcaop.aluno %}
                        {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                      {% endif %}
                      #{{ opcaop.prioridade }}
                    {% endif %}
                  {% else %}
                    {% if opcaop.aluno %}
                      {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                    {% endif %}
                    #{{ opcaop.prioridade }}
                  {% endif %}
                  |{% mede_aderencia opcaop.aluno proposta %}%|<br>
                {% endwith %}
              {% empty %}
                Nenhum aluno escolheu essa proposta
              {% endfor %}
              "            
            >
              {% if proposta.titulo_final %}
                {{proposta.titulo_final}}<br>
                <small>Título Provisório: {{proposta.titulo}}</small>
              {% else %}
                {{proposta.titulo}}
              {% endif %}
            </a>
            {% if not disponivel %}</del>{% endif %}
          </td>

          <td class="text-center">
            {% if not disponivel %}<del>{% endif %}
              {{proposta.ano}}.{{proposta.semestre}}
            {% if not disponivel %}</del>{% endif %}
          </td>
          <td>
            {% if not disponivel %}<del>{% endif %}
              {% if proposta.organizacao %}
                <a href="{% url 'organizacao_completo' proposta.organizacao.id %}">
                  {{ proposta.organizacao.nome }}
                </a>
              {% elif proposta.nome_organizacao %}
                {{ proposta.nome_organizacao }}
              {% else %}
                Organização não definida.
              {% endif %}
            {% if not disponivel %}</del>{% endif %}
          </td>
          <td class="text-center">
            {% if not disponivel %}
              <del>
            {% endif %}
            {% if proposta.perfil_aluno1_computacao %}C<script>tmp_computacao += 1</script>{% endif %}
            {% if proposta.perfil_aluno1_mecatronica %}X<script>tmp_mecatronica += 1</script>{% endif %}
            {% if proposta.perfil_aluno1_mecanica %}M<script>tmp_mecanica += 1</script>{% endif %}
            <!-- Se não defido conta para os 3 cursos -->
            {% if not proposta.perfil_aluno1_computacao and not proposta.perfil_aluno1_mecatronica and not proposta.perfil_aluno1_mecanica %}
              <script>tmp_computacao += 1</script>
              <script>tmp_mecatronica += 1</script>
              <script>tmp_mecanica += 1</script>
              {% if not disponivel %}
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              {% else %}
                ?
              {% endif %}
            {% endif %}
            {% if not disponivel %}
              </del>
            {% endif %}
          </td>
          <td class="text-center">
            {% if not disponivel %}
              <del>
            {% endif %}
            {% if proposta.perfil_aluno2_computacao %}C<script>tmp_computacao += 1</script>{% endif %}
            {% if proposta.perfil_aluno2_mecatronica %}X<script>tmp_mecatronica += 1</script>{% endif %}
            {% if proposta.perfil_aluno2_mecanica %}M<script>tmp_mecanica += 1</script>{% endif %}
            <!-- Se não defido conta para os 3 cursos -->
            {% if not proposta.perfil_aluno2_computacao and not proposta.perfil_aluno2_mecatronica and not proposta.perfil_aluno2_mecanica %}
              <script>tmp_computacao += 1</script>
              <script>tmp_mecatronica += 1</script>
              <script>tmp_mecanica += 1</script>
              {% if not disponivel %}
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              {% else %}
                ?
              {% endif %}
            {% endif %}
            {% if not disponivel %}
              </del>
            {% endif %}
          </td>
          <td class="text-center">
            {% if not disponivel %}
              <del>
            {% endif %}
            {% if proposta.perfil_aluno3_computacao %}C<script>tmp_computacao += 1</script>{% endif %}
            {% if proposta.perfil_aluno3_mecatronica %}X<script>tmp_mecatronica += 1</script>{% endif %}
            {% if proposta.perfil_aluno3_mecanica %}M<script>tmp_mecanica += 1</script>{% endif %}
            <!-- Se não defido conta para os 3 cursos -->
            {% if not proposta.perfil_aluno3_computacao and not proposta.perfil_aluno3_mecatronica and not proposta.perfil_aluno3_mecanica %}
              <script>tmp_computacao += 1</script>
              <script>tmp_mecatronica += 1</script>
              <script>tmp_mecanica += 1</script>
              {% if not disponivel %}
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              {% else %}
                ?
              {% endif %}
            {% endif %}
            {% if not disponivel %}
              </del>
            {% endif %}
          </td>
          <td class="text-center">
            {% if not disponivel %}
              <del>
            {% endif %}
            {% if proposta.perfil_aluno4_computacao %}C<script>tmp_computacao += 1</script>{% endif %}
            {% if proposta.perfil_aluno4_mecatronica %}X<script>tmp_mecatronica += 1</script>{% endif %}
            {% if proposta.perfil_aluno4_mecanica %}M<script>tmp_mecanica += 1</script>{% endif %}
            {% if not proposta.perfil_aluno4_computacao and not proposta.perfil_aluno4_mecatronica and not proposta.perfil_aluno4_mecanica %}
              <script>tmp_computacao += 1</script>
              <script>tmp_mecatronica += 1</script>
              <script>tmp_mecanica += 1</script>
              {% if not disponivel %}
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              {% else %}
                ?
              {% endif %}
            {% endif %}
            {% if not disponivel %}
              </del>
            {% endif %}
          </td>
        </tr>
        <script>
          alunos_computacao += tmp_computacao;
          alunos_mecatronica += tmp_mecatronica;
          alunos_mecanica += tmp_mecanica;

          {% if disponivel %}
            alunos_computacao_disponivel += tmp_computacao;
            alunos_mecatronica_disponivel += tmp_mecatronica;
            alunos_mecanica_disponivel += tmp_mecanica;
          {% endif %}

          if ( ( tmp_computacao >= 3 ) && (tmp_computacao >= tmp_mecatronica + tmp_mecanica ) ) {
            proposta_computacao += 1;
            {% if disponivel %}
              proposta_computacao_disponivel += 1;
            {% endif %}
          } else if ( ( tmp_mecatronica >= 3 ) && (tmp_mecatronica >= tmp_computacao + tmp_mecanica ) ) {
            proposta_mecatronica += 1;
            {% if disponivel %}
              proposta_mecatronica_disponivel += 1;
            {% endif %}
          } else if ( ( tmp_mecanica >= 3 ) && (tmp_mecanica >= tmp_mecatronica + tmp_computacao ) ) {
            proposta_mecanica += 1;
            {% if disponivel %}
              proposta_mecanica_disponivel += 1;
            {% endif %}
          } else {
            proposta_multidisciplinar += 1;
            {% if disponivel %}
              proposta_multidisciplinar_disponivel += 1;
            {% endif %}
          }

          tmp_computacao = 0;
          tmp_mecatronica = 0;
          tmp_mecanica = 0;
        </script>

      {% endwith %}
      {% endfor %}
      
      <tr><td colspan="8" style="text-align: right; border-left: hidden; border-right: hidden; border-bottom: hidden;">
        <small style="font-size:12px"><b>C</b>: Computação | <b>X</b>: Mecatrônica | <b>M</b>: Mecânica</small>
      </tr></td>
      
    </table>
    <p>&nbsp;</p>
    <strong>Número Total de Propostas Publicadas:</strong> <script>document.write(publicados);</script>
      <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        ({{ propostas.count }})
      </a><br>
    
    <strong>Número Total de Propostas Fechadas:</strong> <script>document.write(fechados);</script><br>
    <p>&nbsp;</p>
    <strong>Propostas nativamente multidisciplinar:</strong> <script>document.write(proposta_multidisciplinar_disponivel);</script>
          <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(proposta_multidisciplinar);</script>)
      </a><br>

    <strong>Propostas nativamente de computação:</strong> <script>document.write(proposta_computacao_disponivel);</script>
              <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(proposta_computacao);</script>)
      </a><br>

    <strong>Propostas nativamente de mecatrônica:</strong> <script>document.write(proposta_mecatronica_disponivel);</script>
              <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(proposta_mecatronica);</script>)
      </a><br>

    <strong>Propostas nativamente de mecânica:</strong> <script>document.write(proposta_mecanica_disponivel);</script>
              <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(proposta_mecanica);</script>)
      </a><br>

    <p>&nbsp;</p>
    <strong>Vagas para alunos de computação:</strong> <script>document.write(alunos_computacao_disponivel);</script>
              <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(alunos_computacao);</script>)
      </a><br>

    <strong>Vagas para alunos de mecatrônica:</strong> <script>document.write(alunos_mecatronica_disponivel);</script>
                  <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(alunos_mecatronica);</script>)
      </a><br>

    <strong>Vagas para alunos de mecânica:</strong> <script>document.write(alunos_mecanica_disponivel);</script>
                  <a data-toggle="tooltip" data-html="true" animation="true" title="Contando propostas que a organização desistiua após pubicação ou que não foram aprovados pelo comitê do PFE.">
        (<script>document.write(alunos_mecanica);</script>)
      </a><br>

  {% else %}
    <p>Não existem propostas disponíveis.</p>
  {% endif %}
  <p>&nbsp;</p>


{% endblock %}