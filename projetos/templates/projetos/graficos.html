{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 22 de Setembro de 2020
{% endcomment %}

{% block head %}

  {% load static %}
  
  {% load l10n %}

  <script src="{% static 'js/w3.js' %}"></script>
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>

  {% comment %} Para chamar os Tooltips {% endcomment %}
  <script>{% include "tooltip.js" %}</script>

{% endblock %}

{% block content %}

    <span class="titulo">Gráficos do PFE</span>

    {% comment %} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {% endcomment %}
    <label for="filter"><b>Edição:</b></label>
    <select class="filter" data-tableId="projetos">
        <option value="2020.2" selected>2020.2</option>
        <option value="todas">todas</option>
        {% comment %}
        {% for loop in loop_anos %}
            <option value="{{loop}}.2" {% if ano == loop and semestre == 2 %}selected{% endif %}>{{loop}}.2</option>
            <option value="{{loop|add:1}}.1" {% if ano == loop|add:1 and semestre == 1 %}selected{% endif %}>{{loop|add:1}}.1</option>
        {% endfor %}
        {% endcomment %}
    </select>

    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

    <label for="filter_curso"><b>Curso:</b></label>
    <select class="filter_curso" data-tableId="programa">
        <option value="todos">todos</option>
        <option value="computação" {% if curso == "computação" %}selected{% endif %}>computação</option>
        <option value="mecatrônica" {% if curso == "mecatrônica" %}selected{% endif %}>mecatrônica</option>
        <option value="mecânica" {% if curso == "mecânica" %}selected{% endif %}>mecânica</option>
    </select>

    <div class="container">

        <div style="width:500px;"> 
            <canvas id="horizontal-objetivos"></canvas>
            <br><br>
            <canvas id="chart-medias"></canvas>
        </div>

        <script>
    
    var config_objetivos = {
        type: 'horizontalBar',
        data: {
        labels: [
            {% for media in medias %}
                "{{media.objetivo}}",
            {% endfor %}
            ],
        datasets: [
            {
            label: "Objetivos de Aprendizagem",
            backgroundColor: [
                {% for media in medias %}
                    "{{media.cor}}",
                {% endfor %}
                ],
            data: [
                {% for media in medias %}
                    {{media.media|stringformat:".2f"|unlocalize}},
                {% endfor %}
                ]
            }
        ]
        },
        options: {
            legend: { display: false },
            title: {
                display: true,
                text: 'Médias obtidas nos Objetivos de Aprendizagem'
            },
            scales: {
                xAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    }

    var config_medias = {
        type: 'line',
        data: {
            labels: [
                {% for loop in loop_anos %}
                    "{{loop}}.2",
                    "{{loop|add:1}}.1",
                {% endfor %}
            ],
            datasets: [
                {% for media in medias %}
                    { 
                        data: [,,,,{{media.media|stringformat:".2f"|unlocalize}},],
                        label: "{{media.objetivo}}",
                        borderColor: "{{media.cor}}",
                        fill: false
                    },
                {% endfor %}
            ]
        },
        options: {
            title: {
                display: true,
                text: 'Evolução nos semestres'
            }, 
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        max: 10
                    }
                }]
            }

        }
    }


    function carrega_semestre() {  

      // Chart do nível nos objetivos de aprendizagem
      var horizontal_objetivos = document.getElementById('horizontal-objetivos').getContext('2d');
      window.objetivos = new Chart(horizontal_objetivos, config_objetivos);

      // Chart do média dos alunos
      var chart_medias = document.getElementById('chart-medias').getContext('2d');
      window.medias = new Chart(chart_medias, config_medias);

    }

    window.onload = carrega_semestre
  
  </script>


    </div>

    <script>
        $(".filter").change(function(){
            var topicId = $(".filter option:selected").attr("value");
            $.ajax({
                type: "POST",
                url: "{% url 'graficos' %}",
                data: {
                    topicId: topicId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(response){
                    $("div.2areas2").replaceWith($("div.2areas2",response));
                    carrega_semestre();
                },
                error: function(response) {
                    alert('error');
                }

            });
        });
    </script>

{% endblock %}