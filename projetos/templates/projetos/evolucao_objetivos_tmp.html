{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 22 de Setembro de 2020
{% endcomment %}

{% block head %}

  {% load static %}
  {% load addstr %}
  {% load l10n %}

  <script src="{% static 'js/w3.js' %}"></script>
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-annotation.min.js' %}"></script>

  {% comment %} Para chamar os Tooltips {% endcomment %}
  <script>{% include "tooltip.js" %}</script>

  {% comment %} Para gerar as imagens {% endcomment %}
  <script src="{% static 'js/html2canvas.min.js' %}"></script>
  <script src="{% static 'js/jspdf.min.js' %}"></script>

  <style>
    .cabecalho {
      float: left;
      position: relative;
      margin-top: 0px;
      outline-width: 0;
      background-color: none;
    }
    
    .resizable-content {
        min-height: 350px;
        resize: both;
        overflow: auto;
        position: relative;
        margin: auto;
    }

  </style>

{% endblock %}

{% block content %}

    <script>
        function ajusta() { }
        function reajusta() { }
    </script>

    <div id="tudo">

        <div class="cabecalho">

            <span class="titulo">Evolução em Objetivos de Aprendizado</span>

            {% comment %} Seletor da edição da pesquisa {% endcomment %}
            {% with sem_edicao=True %}
            {% with com_cursos=True %}
            {% with ind_grup=True %}
            {% with so_finais=True %}
                {% include "edicoes.html" %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}

        </div>
    
    <div class="atualizar">

        {% if curso %}
            {% with file_name="evolucao_objetivos_"|addstr:curso %}
                {% include "save_image.html" %}
            {% endwith %}
        {% endif %}

        <div><br><br><br></div>{% comment %} Solução pouco elegante, mas funciona. {% endcomment %}

        <div class="container">

            <div class="row mt-5">
                <div class="col resizable-content">
                    <canvas id="horizontal-div_objetivos"></canvas>
                </div>
            </div>

            <div><br><br><br></div>{% comment %} Solução pouco elegante, mas funciona. {% endcomment %}

            <script>

              var labels = [
                    {% for edicao in edicoes %}
                        "{{edicao}}",
                    {% endfor %}
                ]

              var div_datasets = [
                  {% for media in medias %}
                    
                    { 
                        // SO para o Label
                        data: [{% for faixa in media.faixas %}0,{% endfor %}],
                        label: "{{media.objetivo}}",
                        borderColor: "white",
                        backgroundColor: "white",
                        fill: false,
                        spanGaps: true,
                        stack: '{{media.objetivo}}',
                    },
                    { 
                        data: [{% for faixa in media.faixas %}{{faixa.0|stringformat:".2f"|unlocalize}},{% endfor %}],
                        label: "{{media.objetivo}}",
                        borderColor: "red",
                        backgroundColor: "red",
                        fill: false,
                        spanGaps: true,
                        stack: '{{media.objetivo}}',
                    },
                    { 
                        data: [{% for faixa in media.faixas %}{{faixa.1|stringformat:".2f"|unlocalize}},{% endfor %}],
                        label: "{{media.objetivo}}",
                        borderColor: "yellow",
                        backgroundColor: "yellow",
                        fill: false,
                        spanGaps: true,
                        stack: '{{media.objetivo}}',
                    },
                    { 
                        data: [{% for faixa in media.faixas %}{{faixa.2|stringformat:".2f"|unlocalize}},{% endfor %}],
                        label: "{{media.objetivo}}",
                        borderColor: "green",
                        backgroundColor: "green",
                        fill: false,
                        spanGaps: true,
                        stack: '{{media.objetivo}}',
                    },
                    
                  {% endfor %}
                ] 

    var config_div_objetivos = {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: div_datasets,
        },
        options: {
            legend: { display: false },
            maintainAspectRatio: false,
            title: {
                display: true,
                text: '{% if lingua == "pt" %}Proporção nos Objetivos de Aprendizagem{% else %}Proportion Among Learning Goals{% endif %}',
            },
            scales: {
                x: {
                    stacked: true,
                },
                y: {
                    stacked: true
                },
                xAxes: [{
                    ticks: {
                        //beginAtZero: true,
                        min: -20,
                        max: 100,
                    }
                }],
                //yAxes: [ { ticks: {mirror: true} }],
            },
            plugins: {
                datalabels: {
                    align: function (context) {
                        var value = context.dataset.data[context.dataIndex];
                        return value > 0 ? 'center' : 'start';
                    },
                    formatter: (value, ctx) => {
                        if(value>0) {
                            return (value).toFixed(0)+"%";
                        } else {
                            let ds = ctx.chart.data.datasets
                            if(ds[ctx.datasetIndex - 1]) {
                              if(ds[ctx.datasetIndex - 1].stack == ds[ctx.datasetIndex].stack) {
                                return ''
                              } else {
                                return ds[ctx.datasetIndex].stack;
                              }
                            } else {
                              return ds[ctx.datasetIndex].stack;
                            }
                        }
                    },
                    color: '#000',
                }
            },
            annotation: {
                annotations: [
                    {% comment %} {
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x-axis-0',
                        value: 5,
                        borderColor: 'rgb(225, 12, 12)',
                        borderWidth: 6,
                        label: {
                            enabled: false,
                            content: 'Test label'
                        }
                    },
                    {
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x-axis-0',
                        value: 7,
                        borderColor: 'rgb(12, 225, 12)',
                        borderWidth: 6,
                        label: {
                            enabled: false,
                            content: 'Test label'
                        },
                    } {% endcomment %}
                ]
            }
        }
    }


    function carrega_pagina() {  

        var div_objetivos = document.getElementById('horizontal-div_objetivos').getContext('2d');
        window.div_objetivos = new Chart(div_objetivos, config_div_objetivos);

    }

    window.onload = carrega_pagina
  
  </script>

    </div>
    </div>
    </div>

    <p>&nbsp;</p>
    <p>&nbsp;</p>

    {% with sem_edicao=True %}
    {% with com_cursos=True %}
    {% with ind_grup=True %}
    {% with so_finais=True %}
        {% include "edicoes_ajax.html" %}
    {% endwith %}
    {% endwith %}
    {% endwith %}
    {% endwith %}

{% endblock %}