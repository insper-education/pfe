<!DOCTYPE xml> <!-- Bagunça a linha inicial mas calendario fica alinhado -->

{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Junho de 2019
{% endcomment %}

{% block head %}
  <!-- REFERENCIA: https://github.com/year-calendar/js-year-calendar -->
  <script src="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.css" />
  <link rel='stylesheet' href='https://unpkg.com/bootstrap-datepicker@1.8.0/dist/css/bootstrap-datepicker.standalone.min.css'>
  
  <script src="https://unpkg.com/js-year-calendar@latest/locales/js-year-calendar.pt.js"></script>

  <style>
    table, th, td {
      border: 0px;
    }
  </style>

  <script>
    window.console = window.console || function(t) {};
    if (document.location.search.match(/type=embed/gi)) {
      window.parent.postMessage("resize", "*");
    }
  </script>

{% endblock %}

{% block content %}

  <h3>Calendário de Eventos do PFE</h3>
  <br>
  <div id='calendar'></div>
  <br>

  {% for evento in eventos|dictsort:"endDate" %}
    {% if evento.get_title != "Feriado" and evento.get_title != "Aula Cancelada" %}
      <span class="a{{evento.endDate.year}} ano">
        {% ifchanged evento.get_title evento.endDate.year %}   
          <br><font style="color:{{evento.get_color}}">&#9608;</font> {{evento.get_title}}:
          {% if evento.startDate == evento.endDate %} 
            {{evento.endDate.day}}/{{evento.endDate.month}}
          {% else %}
            {{evento.startDate.day}}/{{evento.startDate.month}} à {{evento.endDate.day}}/{{evento.endDate.month}} 
          {% endif %}
        {% else %}
          ; {{evento.endDate.day}}/{{evento.endDate.month}}
        {% endifchanged %}
      </span>
    {% endif %}
  {% endfor %}

  {% for feedback in feedbacks|dictsort:"endDate" %}
    <span class="a{{feedback.endDate.year}} ano">
      {% ifchanged feedback.get_title feedback.endDate.year %} 
        <br><font style="color:{{feedback.get_color}}">&#9608;</font> {{feedback.get_title}}: 
        {{feedback.endDate.day}}/{{feedback.endDate.month}}
      {% else %}
        ; {{feedback.endDate.day}}/{{feedback.endDate.month}}
      {% endifchanged %}
    </span>
  {% endfor %}

  {% for quinzenal in quinzenais|dictsort:"endDate" %}
    <span class="a{{quinzenal.endDate.year}} ano">
      {% ifchanged quinzenal.get_title quinzenal.endDate.year %} 
        <br><font style="color:{{quinzenal.get_color}}">&#9608;</font> {{quinzenal.get_title}}: 
        {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}
      {% else %}
        ; {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}
      {% endifchanged %}
    </span>
  {% endfor %}
  
  {% for aula in aulas|dictsort:"endDate" %}
    <span class="a{{aula.endDate.year}} ano">
      {% ifchanged aula.get_title aula.endDate.year %} 
        <br><font style="color:{{aula.get_color}}">&#9608;</font> {{aula.get_title}}: 
        {{aula.endDate.day}}/{{aula.endDate.month}}
      {% else %}
        ; {{aula.endDate.day}}/{{aula.endDate.month}}
      {% endifchanged %}
    </span>
  {% endfor %}


  {% if laboratorios %}
    <br>
    {% for laboratorio in laboratorios|dictsort:"endDate" %}
      {% if laboratorio.get_title != "Feriado" %}
        <span class="a{{laboratorio.endDate.year}} ano">
          {% ifchanged laboratorio.get_title laboratorio.endDate.year %}   
            <br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{laboratorio.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{laboratorio.get_title}}: 
            {% if laboratorio.startDate == laboratorio.endDate %} 
              {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}
            {% else %}
              {{laboratorio.startDate.day}}/{{laboratorio.startDate.month}} à {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}} 
            {% endif %}
          {% else %}
            ; {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}
          {% endifchanged %}
        </span>
      {% endif %}
    {% endfor %}
    <br><font style="text-decoration: underline solid orange">
    Dias sublinhados possuem disponibilidade de trabalho no laboratório 3 (L3) [as sextas-feiras]
    </font>
  {% endif %}

  {% if provas %}
    <br>
    {% for prova in provas|dictsort:"endDate" %}
      {% if prova.get_title != "Feriado" %}
        <span class="a{{prova.endDate.year}} ano">
          {% ifchanged prova.get_title prova.endDate.year %}   
            <br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{prova.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{prova.get_title}}: 
            {% if prova.startDate == prova.endDate %} 
              {{prova.endDate.day}}/{{prova.endDate.month}}
            {% else %}
              {{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}} 
            {% endif %}
          {% else %}
            {% if prova.startDate == prova.endDate %} 
              ; {{prova.endDate.day}}/{{prova.endDate.month}}
            {% else %}
              ; {{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}} 
            {% endif %}
          {% endifchanged %}
        </span>
      {% endif %}
    {% endfor %}
    <br><font style="text-decoration: underline solid red">
      Semana de provas sublinhado em vermelho
    </font>
  {% endif %}
  <br>
  <br>

  <div class="modal fade" id="event-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="event-index">
                <form class="form-horizontal">
                    <div class="form-group row">
                        <label for="event-name" class="col-sm-4 control-label">Name</label>
                        <div class="col-sm-8">
                            <input id="event-name" name="event-name" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="event-location" class="col-sm-4 control-label">Location</label>
                        <div class="col-sm-8">
                            <input id="event-location" name="event-location" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="min-date" class="col-sm-4 control-label">Dates</label>
                        <div class="col-sm-8">
                            <div class="input-group input-daterange" data-provide="datepicker">
                                <input id="min-date" name="event-start-date" type="text" class="form-control">
                <div class="input-group-prepend input-group-append">
                    <div class="input-group-text">to</div>
                </div>
                                <input name="event-end-date" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event">
                    Save
                </button>
            </div>
        </div>
    </div>
  </div>
  <div id="context-menu">
  </div>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js'></script> 
  
  <script id="rendered-js">

    let calendar = null;

    function editEvent(event) {
      $('#event-modal input[name="event-index"]').val(event ? event.id : '');
      $('#event-modal input[name="event-name"]').val(event ? event.name : '');
      $('#event-modal input[name="event-location"]').val(event ? event.location : '');
      $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
      $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
      $('#event-modal').modal();
    }

    function deleteEvent(event) {
      var dataSource = calendar.getDataSource();

      calendar.setDataSource(dataSource.filter(item => item.id == event.id));
    }

    function saveEvent() {
      var event = {
        id: $('#event-modal input[name="event-index"]').val(),
        name: $('#event-modal input[name="event-name"]').val(),
        location: $('#event-modal input[name="event-location"]').val(),
        startDate: $('#event-modal input[name="event-start-date"]').datepicker('getDate'),
        endDate: $('#event-modal input[name="event-end-date"]').datepicker('getDate') };


      var dataSource = calendar.getDataSource();

      if (event.id) {
        for (var i in dataSource) {
          if (dataSource[i].id == event.id) {
            dataSource[i].name = event.name;
            dataSource[i].location = event.location;
            dataSource[i].startDate = event.startDate;
            dataSource[i].endDate = event.endDate;
          }
        }
      } else

      {
        var newId = 0;
        for (var i in dataSource) {
          if (dataSource[i].id > newId) {
            newId = dataSource[i].id;
          }
        }

        newId++;
        event.id = newId;

        dataSource.push(event);
      }

      calendar.setDataSource(dataSource);
      $('#event-modal').modal('hide');
    }

    $(function () {
      var currentYear = new Date().getFullYear();
      var currentMonth = new Date().getMonth(); 
      var currentDate = new Date().getDate();
      var hoje = new Date(currentYear, currentMonth, currentDate).getTime();

      calendar = new Calendar('#calendar', {
        language: 'pt',
        enableContextMenu: true,
        enableRangeSelection: true,
        style:'background',
        contextMenuItems: [
        {
          text: 'Update',
          click: editEvent },
        {
          text: 'Delete',
          click: deleteEvent }],

        selectRange: function (e) {
          editEvent({ startDate: e.startDate, endDate: e.endDate });
        },
        mouseOnDay: function (e) {
          if (e.events.length > 0) {
            var content = '';

            for (var i in e.events) {
              content += '<div class="event-tooltip-content">' +
              '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>' +
              '<div class="event-location">' + e.events[i].location + '</div>' +
              '</div>';
            }

            $(e.element).popover({
              trigger: 'manual',
              container: 'body',
              html: true,
              content: content });

            $(e.element).popover('show');
          }
        },
        mouseOutDay: function (e) {
          if (e.events.length > 0) {
            $(e.element).popover('hide');
          }
        },
        dayContextMenu: function (e) {
          $(e.element).popover('hide');
        },
        disabledDays: [
            new Date(2019,11,23),
            new Date(2019,11,24),
            new Date(2019,11,25),
            new Date(2019,11,26),
            new Date(2019,11,27),
            new Date(2019,11,30),
            new Date(2019,11,31),
        ],
        dataSource: [
        {% for evento in eventos %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in aulas %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in quinzenais %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in feedbacks %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
      ],
      
      customDayRenderer: function(element, date) {
          $(element).css('border-radius', '0px');
          {% if not limpo %}
            if(date.getTime() == hoje) {
              $(element).css('outline', '2px solid blue');
            }
          {% endif %}
          if (date.getDay() === 6 || date.getDay() === 0) {
            $(element).css('background-color', 'lightgrey');  
          } else {
            {% for prova in provas %}
              if(
                date.getTime() >= new Date({{prova.startDate.year}}, {{prova.startDate.month|add:-1}},{{prova.startDate.day}}).getTime()
                &&
                date.getTime() <= new Date({{prova.endDate.year}}, {{prova.endDate.month|add:-1}},{{prova.endDate.day}}).getTime()
                ) {
                $(element).css('border-bottom', '4px solid {{prova.get_color}}');
                $(element).css('line-height', '0.85');
              }
            {% endfor %}
            {% for lab in laboratorios %}
              if(date.getTime() == new Date({{lab.startDate.year}}, {{lab.startDate.month|add:-1}},{{lab.startDate.day}}).getTime()) {
                $(element).css('background-image', 'linear-gradient(to bottom, transparent 80%, {{lab.get_color}} 80% )');
              }
            {% endfor %}
          }
        }
       });

      $('#save-event').click(function () {
        saveEvent();
      });
    });

    document.querySelector('#calendar').addEventListener('yearChanged', function(e) {
      console.log("New year selected: " + e.currentYear);
      [].forEach.call(document.querySelectorAll('.ano'), function (el) {
        el.style.display = 'none';
      });
      [].forEach.call(document.querySelectorAll('.a'+e.currentYear), function (el) {
        el.style.display = 'inline';
      });
    })

  </script>

{% endblock %}
