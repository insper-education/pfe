{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Junho de 2019
{% endcomment %}

{% block head %}
  {% load static %}
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-datepicker.min.css' %}"/>

  <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-theme.min.css' %}"/> -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-year-calendar.min.css' %}"/>
  

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
  <style>
    table, th, td {
      border: 0px solid white;
    }
  </style>

{% endblock %}

{% block content %}

<!-- DESCOBRI TARDIAMENTE QUE ESSA BIBLIOTECA ESTA VELHA E TEM UMA MELHOR -->
<!-- VER EM: https://github.com/year-calendar/js-year-calendar -->

<script src="{% static 'js/respond.min.js' %}"></script>
<script src="{% static 'js/jquery-1.10.2.min.js' %}"></script>

<!-- <script src="{% static 'js/bootstrap.min.js' %}"></script> -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<script src="{% static 'js/bootstrap-datepicker.min.js' %}"></script> 
<script src="{% static 'js/bootstrap-year-calendar.min.js' %}"></script>
<script src="{% static 'js/bootstrap-year-calendar.pt.js' %}"></script>
<script src="{% static 'js/bootstrap-popover.js' %}"></script>
<script src="{% static 'js/scripts.js' %}"></script>

<script>

function editEvent(event) {
    $('#event-modal input[name="event-index"]').val(event ? event.id : '');
    $('#event-modal input[name="event-name"]').val(event ? event.name : '');
    $('#event-modal input[name="event-location"]').val(event ? event.location : '');
    $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
    $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
    $('#event-modal').modal();
}

function deleteEvent(event) {
    var dataSource = $('#calendar').data('calendar').getDataSource();

    for(var i in dataSource) {
        if(dataSource[i].id == event.id) {
            dataSource.splice(i, 1);
            break;
        }
    }
    
    $('#calendar').data('calendar').setDataSource(dataSource);
}

function saveEvent() {
    var event = {
        id: $('#event-modal input[name="event-index"]').val(),
        name: $('#event-modal input[name="event-name"]').val(),
        location: $('#event-modal input[name="event-location"]').val(),
        startDate: $('#event-modal input[name="event-start-date"]').datepicker('getDate'),
        endDate: $('#event-modal input[name="event-end-date"]').datepicker('getDate')
    }
    
    var dataSource = $('#calendar').data('calendar').getDataSource();

    if(event.id) {
        for(var i in dataSource) {
            if(dataSource[i].id == event.id) {
                dataSource[i].name = event.name;
                dataSource[i].location = event.location;
                dataSource[i].startDate = event.startDate;
                dataSource[i].endDate = event.endDate;
            }
        }
    }
    else
    {
        var newId = 0;
        for(var i in dataSource) {
            if(dataSource[i].id > newId) {
                newId = dataSource[i].id;
            }
        }
        
        newId++;
        event.id = newId;
    
        dataSource.push(event);
    }
    
    $('#calendar').data('calendar').setDataSource(dataSource);
    $('#event-modal').modal('hide');
}

$(function() {
  var currentYear = new Date().getFullYear();
  var currentMonth = new Date().getMonth(); 
  var currentDate = new Date().getDate();
  var hoje = new Date(currentYear, currentMonth, currentDate).getTime();
   
    $('#calendar').calendar({ 
        enableContextMenu: true,
        enableRangeSelection: true,
        style:'background',
        language:'pt',
        contextMenuItems:[
            {
                text: 'Update',
                click: editEvent
            },
            {
                text: 'Delete',
                click: deleteEvent
            }
        ],
        selectRange: function(e) {
            editEvent({ startDate: e.startDate, endDate: e.endDate });
        },
        mouseOnDay: function(e) {
            if(e.events.length > 0) {
                var content = '';
                
                for(var i in e.events) {
                    content += '<div class="event-tooltip-content">'
                                    + '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>'
                                    + '<div class="event-location">' + e.events[i].location + '</div>'
                                + '</div>';
                }
            
                $(e.element).popover({ 
                    trigger: 'manual',
                    container: 'body',
                    html:true,
                    content: content
                });
                
                $(e.element).popover('show');
            }
        },
        mouseOutDay: function(e) {
            if(e.events.length > 0) {
                $(e.element).popover('hide');
            }
        },
        dayContextMenu: function(e) {
            $(e.element).popover('hide');
        },
        disabledDays: [
            new Date(2019,11,23),
            new Date(2019,11,24),
            new Date(2019,11,25),
            new Date(2019,11,26),
            new Date(2019,11,27),
            new Date(2019,11,30),
            new Date(2019,11,31),
        ],
        dataSource: [
          {% for evento in eventos %} 
            {
                id: {{evento.id}},
                name: "{{evento.name}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.color}}",
            },
            {% endfor %}
            {% for evento in aulas %} 
            {
                id: {{evento.id}},
                name: "{{evento.name}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.color}}",
            },
            {% endfor %}
        ],
        customDayRenderer: function(element, date) {
          if(date.getTime() == hoje) {
            $(element).css('outline', '2px solid blue');
          }
          else if (date.getDay() === 6 || date.getDay() === 0) {
            $(element).css('background-color', 'lightgrey');
          }
        }
    });
    
    $('#save-event').click(function() {
        saveEvent();
    });
});
</script>

  <h3>Calendário de Eventos do PFE</h3>
  <br>
  <div id='calendar'></div>
  <br>
  {% for evento in eventos|dictsort:"endDate" %}
    {% if evento.name != "Feriado" %}
      {% ifchanged evento.name %} 
        <br><font style="color:{{evento.color}}">&#9608;</font> {{evento.name}}: 
        {% if evento.startDate == evento.endDate %} 
          {{evento.endDate.day}}/{{evento.endDate.month|add:-1}}
        {% else %}
          {{evento.startDate.day}}/{{evento.startDate.month|add:-1}} à {{evento.endDate.day}}/{{evento.endDate.month|add:-1}} 
        {% endif %}     
      {% else %}
        ; {{evento.endDate.day}}/{{evento.endDate.month|add:-1}}
      {% endifchanged %}
    {% endif %}
  {% endfor %}
  {% for aula in aulas|dictsort:"endDate" %}
    {% ifchanged aula.name %} 
      <br><font style="color:{{aula.color}}">&#9608;</font> {{aula.name}}: 
       {{aula.endDate.day}}/{{aula.endDate.month|add:-1}}
    {% else %}
      ; {{aula.endDate.day}}/{{aula.endDate.month|add:-1}}
    {% endifchanged %}
  {% endfor %}
  <br>
  <br>

{% endblock %}

