<!DOCTYPE xml> <!-- Bagunça a linha inicial mas calendario fica alinhado -->

{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Junho de 2019
{% endcomment %}

{% block head %}
  {% load static %}

  <!-- REFERENCIA: https://github.com/year-calendar/js-year-calendar -->
  <script src="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.css" />
  <link rel='stylesheet' href='https://unpkg.com/bootstrap-datepicker@1.8.0/dist/css/bootstrap-datepicker.standalone.min.css'>
  
  <script src="https://unpkg.com/js-year-calendar@latest/locales/js-year-calendar.pt.js"></script>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>

  <style>
    table, th, td {
      border: 0px;
    }
  </style>

  <script>
    window.console = window.console || function(t) {};
    if (document.location.search.match(/type=embed/gi)) {
      window.parent.postMessage("resize", "*");
    }
  </script>

  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>

  <style>

    .image {
      outline-width: 0;
      background-color: none;
    }

    .image:hover {
      background: #e7e7e7;
      background-color: none;
    }

    .image:active {
      background-color: lightblue;
    }

  </style>


{% endblock %}

{% block content %}

  <div class="images" style="float: right;">
    <img class="image" id="bjpg" src="{% static 'images/icone_JPG.png' %}" alt="jpg" style="cursor: pointer;">
    <img class="image" id="bpng" src="{% static 'images/icone_PNG.png' %}" alt="png" style="cursor: pointer;">
    <img class="image" id="bpdf" src="{% static 'images/icone_PDF.png' %}" alt="pdf" style="cursor: pointer;">
  </div>

  <div id="tudo">

    <h3>Calendário de Eventos do PFE</h3>
    <br>
    
    <div id='calendar'></div>
    
    &nbsp;Semestre: [<span id="primeiro_semestre" style="cursor: pointer;">1</span>/<span id="segundo_semestre" style="cursor: pointer;">2</span>]

    {% comment %}
        (1, 'aluno'),
        (2, 'professor'),
        (3, 'parceiro'),
        (4, 'administrador'),
    {% endcomment %}

    {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
      <br><span style="font-size:20px" data-toggle="tooltip" data-html="true" animation="true" title=
      "O semestre da coordenação vai de Março à Agosto e de Setembro a Fevereiro">
        Operação:
      </span>

      {% comment %} O certo era ser uma função essa chamadas. {% endcomment %}
      {% comment %}  Para o ponto e virgula ficar junto dos termos
      {% if eventos %}
        {% for evento in coordenacao|dictsort:"endDate" %} 
          <span class="coordenacao" data-ano="{{evento.endDate.year}}" data-mes="{{evento.endDate.month}}" >
            {% ifchanged evento.get_title evento.get_semester evento.endDate.year %}   
              <br><font style="color:{{evento.get_color}}">&#9608;</font> {{evento.get_title}}:
              {% if evento.startDate == evento.endDate %} 
                {{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}
              {% else %}
                {{evento.startDate.day}}/{{evento.startDate.month}}/{{evento.endDate.year}} à {{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}
              {% endif %}
            {% else %}
              ; {{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}
            {% endifchanged %}
          </span>
        {% endfor %}
      {% endif %}
      {% endcomment %}  
      {% if eventos %}{% for evento in coordenacao|dictsort:"endDate" %}<span class="coordenacao" data-ano="{{evento.endDate.year}}" data-mes="{{evento.endDate.month}}" >{% ifchanged evento.get_title evento.get_semester evento.endDate.year %}<br><font style="color:{{evento.get_color}}">&#9608;</font> {{evento.get_title}}: {% if evento.startDate == evento.endDate %}{{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}{% else %}{{evento.startDate.day}}/{{evento.startDate.month}}/{{evento.endDate.year}} à {{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}{% endif %}{% else %}; {{evento.endDate.day}}/{{evento.endDate.month}}/{{evento.endDate.year}}{% endifchanged %}</span>{% endfor %}{% endif %}

    {% endif %}

    {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
      <br><br><span style="font-size:20px">
        Acadêmico:
      </span>
    {% endif %}

    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% for evento in eventos|dictsort:"endDate" %}
      {% if evento.get_title != "Feriado" and evento.get_title != "Aula cancelada" %}
        <span class="ano{{evento.endDate.year}} ano">
          <span class="semestre" data-mes="{{evento.endDate.month}}">
            {% ifchanged evento.get_title evento.get_semester evento.endDate.year %}   
              <br><font style="color:{{evento.get_color}}">&#9608;</font> {{evento.get_title}}:
              {% if evento.startDate == evento.endDate %} 
                {{evento.endDate.day}}/{{evento.endDate.month}}
              {% else %}
                {{evento.startDate.day}}/{{evento.startDate.month}} à {{evento.endDate.day}}/{{evento.endDate.month}} 
              {% endif %}
            {% else %}
              ; {{evento.endDate.day}}/{{evento.endDate.month}}
            {% endifchanged %}
          </span>
        </span>
      {% endif %}
    {% endfor %}
    {% endcomment %}
    {% if eventos %}{% for evento in eventos|dictsort:"endDate" %}{% if evento.get_title != "Feriado" and evento.get_title != "Aula cancelada" %}<span class="ano{{evento.endDate.year}} ano"><span class="semestre" data-mes="{{evento.endDate.month}}">{% ifchanged evento.get_title evento.get_semester evento.endDate.year %}<br><font style="color:{{evento.get_color}}">&#9608;</font> {{evento.get_title}}: {% if evento.startDate == evento.endDate %}{{evento.endDate.day}}/{{evento.endDate.month}}{% else %}{{evento.startDate.day}}/{{evento.startDate.month}} à {{evento.endDate.day}}/{{evento.endDate.month}}{% endif %}{% else %}; {{evento.endDate.day}}/{{evento.endDate.month}}{% endifchanged %}</span></span>{% endif %}{% endfor %}{% endif %}


    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% if feedbacks %}
      {% for feedback in feedbacks|dictsort:"endDate" %}
        <span class="ano{{feedback.endDate.year}} ano">
          <span class="semestre" data-mes="{{feedback.endDate.month}}">
            {% ifchanged feedback.get_title feedback.get_semester feedback.endDate.year %} 
              <br><font style="color:{{feedback.get_color}}">&#9608;</font> {{feedback.get_title}}: 
              {{feedback.endDate.day}}/{{feedback.endDate.month}}
            {% else %}
              ; {{feedback.endDate.day}}/{{feedback.endDate.month}}
            {% endifchanged %}
          </span>
        </span>
      {% endfor %}
    {% endif %}
    {% endcomment %}
    {% if feedbacks %}{% for feedback in feedbacks|dictsort:"endDate" %}<span class="ano{{feedback.endDate.year}} ano"><span class="semestre" data-mes="{{feedback.endDate.month}}">{% ifchanged feedback.get_title feedback.get_semester feedback.endDate.year %}<br><font style="color:{{feedback.get_color}}">&#9608;</font> {{feedback.get_title}}: {{feedback.endDate.day}}/{{feedback.endDate.month}}{% else %}; {{feedback.endDate.day}}/{{feedback.endDate.month}}{% endifchanged %}</span></span>{% endfor %}{% endif %}

    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% if quinzenais %}
      {% for quinzenal in quinzenais|dictsort:"endDate" %}
        <span class="ano{{quinzenal.endDate.year}} ano">
          <span class="semestre" data-mes="{{quinzenal.endDate.month}}">
            {% ifchanged quinzenal.get_title quinzenal.get_semester quinzenal.endDate.year %} 
              <br><font style="color:{{quinzenal.get_color}}">&#9608;</font> {{quinzenal.get_title}}: 
              {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}
            {% else %}
              ; {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}
            {% endifchanged %}
          </span>
        </span>
      {% endfor %}
    {% endif %}
    {% endcomment %}
    {% if quinzenais %}{% for quinzenal in quinzenais|dictsort:"endDate" %}<span class="ano{{quinzenal.endDate.year}} ano"><span class="semestre" data-mes="{{quinzenal.endDate.month}}">{% ifchanged quinzenal.get_title quinzenal.get_semester quinzenal.endDate.year %}<br><font style="color:{{quinzenal.get_color}}">&#9608;</font> {{quinzenal.get_title}}: {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}{% else %}; {{quinzenal.endDate.day}}/{{quinzenal.endDate.month}}{% endifchanged %}</span></span>{% endfor %}{% endif %}

    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% if aulas %}
      {% for aula in aulas|dictsort:"endDate" %}
        <span class="ano{{aula.endDate.year}} ano">
          <span class="semestre" data-mes="{{aula.endDate.month}}">
            {% ifchanged aula.get_title aula.get_semester aula.endDate.year %} 
              <br><font style="color:{{aula.get_color}}">&#9608;</font> {{aula.get_title}}: 
              {{aula.endDate.day}}/{{aula.endDate.month}}
            {% else %}
              ; {{aula.endDate.day}}/{{aula.endDate.month}}
            {% endifchanged %}
          </span>
        </span>
      {% endfor %}
    {% endif %}
    {% endcomment %}
    {% if aulas %}{% for aula in aulas|dictsort:"endDate" %}<span class="ano{{aula.endDate.year}} ano"><span class="semestre" data-mes="{{aula.endDate.month}}">{% ifchanged aula.get_title aula.get_semester aula.endDate.year %}<br><font style="color:{{aula.get_color}}">&#9608;</font> {{aula.get_title}}: {{aula.endDate.day}}/{{aula.endDate.month}}{% else %}; {{aula.endDate.day}}/{{aula.endDate.month}}{% endifchanged %}</span></span>{% endfor %}{% endif %}

    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% if laboratorios %}
      <br>
      {% for laboratorio in laboratorios|dictsort:"endDate" %}
        {% if laboratorio.get_title != "Feriado" %}
          <span class="ano{{laboratorio.endDate.year}} ano">
            <span class="semestre" data-mes="{{laboratorio.endDate.month}}">
              {% ifchanged laboratorio.get_title laboratorio.get_semester laboratorio.endDate.year %}   
                <br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{laboratorio.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{laboratorio.get_title}}: 
                {% if laboratorio.startDate == laboratorio.endDate %} 
                  {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}
                {% else %}
                  {{laboratorio.startDate.day}}/{{laboratorio.startDate.month}} à {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}} 
                {% endif %}
              {% else %}
                ; {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}
              {% endifchanged %}
            </span>
          </span>
        {% endif %}
      {% endfor %}
      <br><font style="text-decoration: underline solid orange">
      Dias sublinhados possuem disponibilidade de trabalho no laboratório 3 (L3)
      </font>
    {% endif %}
    {% endcomment %}
    {% if laboratorios %}
      <br>
      {% for laboratorio in laboratorios|dictsort:"endDate" %}{% if laboratorio.get_title != "Feriado" %}<span class="ano{{laboratorio.endDate.year}} ano"><span class="semestre" data-mes="{{laboratorio.endDate.month}}">{% ifchanged laboratorio.get_title laboratorio.get_semester laboratorio.endDate.year %}<br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{laboratorio.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{laboratorio.get_title}}: {% if laboratorio.startDate == laboratorio.endDate %}{{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}{% else %}{{laboratorio.startDate.day}}/{{laboratorio.startDate.month}} à {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}{% endif %}{% else %}; {{laboratorio.endDate.day}}/{{laboratorio.endDate.month}}{% endifchanged %}</span></span>{% endif %}{% endfor %}
      <br><font style="text-decoration: underline solid orange">
      Dias sublinhados possuem disponibilidade de trabalho no laboratório 3 (L3)
      </font>
    {% endif %}

    {% comment %}  Para o ponto e virgula ficar junto dos termos
    {% if provas %}
      <br>
      {% for prova in provas|dictsort:"endDate" %}
        {% if prova.get_title != "Feriado" %}
          <span class="ano{{prova.endDate.year}} ano">
            <span class="semestre" data-mes="{{prova.endDate.month}}">
              {% ifchanged prova.get_title prova.get_semester prova.endDate.year %}   
                <br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{prova.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{prova.get_title}}: 
                {% if prova.startDate == prova.endDate %} 
                  {{prova.endDate.day}}/{{prova.endDate.month}}
                {% else %}
                  {{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}} 
                {% endif %}
              {% else %}
                {% if prova.startDate == prova.endDate %} 
                  ; {{prova.endDate.day}}/{{prova.endDate.month}}
                {% else %}
                  ; {{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}} 
                {% endif %}
              {% endifchanged %}
            </span>
          </span>
        {% endif %}
      {% endfor %}
      <br><font style="text-decoration: underline solid red">
        Semana de provas sublinhado em vermelho
      </font>
    {% endif %}
    {% endcomment %}
    {% if provas %}
      <br>
      {% for prova in provas|dictsort:"endDate" %}{% if prova.get_title != "Feriado" %}<span class="ano{{prova.endDate.year}} ano"><span class="semestre" data-mes="{{prova.endDate.month}}">{% ifchanged prova.get_title prova.get_semester prova.endDate.year %}<br><font style="background-image : linear-gradient(to bottom, transparent 80%, {{prova.get_color}} 80%">&nbsp;&nbsp;&nbsp;</font> {{prova.get_title}}: {% if prova.startDate == prova.endDate %}{{prova.endDate.day}}/{{prova.endDate.month}}{% else %}{{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}}{% endif %}{% else %}{% if prova.startDate == prova.endDate %} ; {{prova.endDate.day}}/{{prova.endDate.month}}{% else %}; {{prova.startDate.day}}/{{prova.startDate.month}} à {{prova.endDate.day}}/{{prova.endDate.month}}{% endif %}{% endifchanged %}</span></span>{% endif %}{% endfor %}
      <br><font style="text-decoration: underline solid red">
        Semana de provas sublinhado em vermelho
      </font>
    {% endif %}

    <br>
    <br>

    <div class="modal fade" id="event-modal">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Event</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
              </div>
              <div class="modal-body">
                  <input type="hidden" name="event-index">
                  <form class="form-horizontal">
                      <div class="form-group row">
                          <label for="event-name" class="col-sm-4 control-label">Name</label>
                          <div class="col-sm-8">
                              <input id="event-name" name="event-name" type="text" class="form-control">
                          </div>
                      </div>
                      <div class="form-group row">
                          <label for="event-location" class="col-sm-4 control-label">Location</label>
                          <div class="col-sm-8">
                              <input id="event-location" name="event-location" type="text" class="form-control">
                          </div>
                      </div>
                      <div class="form-group row">
                          <label for="min-date" class="col-sm-4 control-label">Dates</label>
                          <div class="col-sm-8">
                              <div class="input-group input-daterange" data-provide="datepicker">
                                  <input id="min-date" name="event-start-date" type="text" class="form-control">
                  <div class="input-group-prepend input-group-append">
                      <div class="input-group-text">to</div>
                  </div>
                                  <input name="event-end-date" type="text" class="form-control">
                              </div>
                          </div>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="save-event">
                      Save
                  </button>
              </div>
          </div>
      </div>
    </div>
    <div id="context-menu">
    </div>

  </div>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js'></script> 
  
  <script id="rendered-js">

    let calendar = null;

    function editEvent(event) {
      $('#event-modal input[name="event-index"]').val(event ? event.id : '');
      $('#event-modal input[name="event-name"]').val(event ? event.name : '');
      $('#event-modal input[name="event-location"]').val(event ? event.location : '');
      $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
      $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
      $('#event-modal').modal();
    }

    function deleteEvent(event) {
      var dataSource = calendar.getDataSource();

      calendar.setDataSource(dataSource.filter(item => item.id == event.id));
    }

    function saveEvent() {
      var event = {
        id: $('#event-modal input[name="event-index"]').val(),
        name: $('#event-modal input[name="event-name"]').val(),
        location: $('#event-modal input[name="event-location"]').val(),
        startDate: $('#event-modal input[name="event-start-date"]').datepicker('getDate'),
        endDate: $('#event-modal input[name="event-end-date"]').datepicker('getDate') };


      var dataSource = calendar.getDataSource();

      if (event.id) {
        for (var i in dataSource) {
          if (dataSource[i].id == event.id) {
            dataSource[i].name = event.name;
            dataSource[i].location = event.location;
            dataSource[i].startDate = event.startDate;
            dataSource[i].endDate = event.endDate;
          }
        }
      } else

      {
        var newId = 0;
        for (var i in dataSource) {
          if (dataSource[i].id > newId) {
            newId = dataSource[i].id;
          }
        }

        newId++;
        event.id = newId;

        dataSource.push(event);
      }

      calendar.setDataSource(dataSource);
      $('#event-modal').modal('hide');
    }

    function calendario() {
      var currentYear = new Date().getFullYear();
      var currentMonth = new Date().getMonth(); 
      var currentDate = new Date().getDate();
      var hoje = new Date(currentYear, currentMonth, currentDate).getTime();

      calendar = new Calendar('#calendar', {
        language: 'pt',
        enableContextMenu: true,
        enableRangeSelection: true,
        style:'background',
        contextMenuItems: [
        {
          text: 'Update',
          click: editEvent },
        {
          text: 'Delete',
          click: deleteEvent }],

        selectRange: function (e) {
          editEvent({ startDate: e.startDate, endDate: e.endDate });
        },
        mouseOnDay: function (e) {
          if (e.events.length > 0) {
            var content = '';

            for (var i in e.events) {
              content += '<div class="event-tooltip-content">' +
              '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>' +
              '<div class="event-location">' + e.events[i].location + '</div>' +
              '</div>';
            }

            $(e.element).popover({
              trigger: 'manual',
              container: 'body',
              html: true,
              content: content });

            $(e.element).popover('show');
          }
        },
        mouseOutDay: function (e) {
          if (e.events.length > 0) {
            $(e.element).popover('hide');
          }
        },
        dayContextMenu: function (e) {
          $(e.element).popover('hide');
        },
        disabledDays: [], {% comment %} Não estou usando por enquanto. {% endcomment %}
        dataSource: [
        {% for evento in eventos %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in aulas %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in quinzenais %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% for evento in feedbacks %} 
            {
                id: {{evento.id}},
                name: "{{evento.get_title}}",
                location: "{{evento.location}}",
                startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                color: "{{evento.get_color}}",
            },
          {% endfor %}
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
            {% for evento in coordenacao %} 
              {
                  id: {{evento.id}},
                  name: "{{evento.get_title}}",
                  location: "{{evento.location}}",
                  startDate: new Date({{evento.startDate.year}},{{evento.startDate.month|add:-1}},{{evento.startDate.day}}),
                  endDate: new Date({{evento.endDate.year}},{{evento.endDate.month|add:-1}},{{evento.endDate.day}}),
                  color: "{{evento.get_color}}",
              },
            {% endfor %}
          {% endif %}
      ],
      
      customDayRenderer: function(element, date) {
          $(element).css('border-radius', '0px');
          {% if not limpo %}
            if(date.getTime() == hoje) {
              $(element).css('outline', '2px solid blue');
            }
          {% endif %}
          if (date.getDay() === 6 || date.getDay() === 0) {
            $(element).css('background-color', 'lightgrey');  
          } else {
            {% for prova in provas %}
              if(
                date.getTime() >= new Date({{prova.startDate.year}}, {{prova.startDate.month|add:-1}},{{prova.startDate.day}}).getTime()
                &&
                date.getTime() <= new Date({{prova.endDate.year}}, {{prova.endDate.month|add:-1}},{{prova.endDate.day}}).getTime()
                ) {
                $(element).css('border-bottom', '4px solid {{prova.get_color}}');
                $(element).css('line-height', '0.85');
              }
            {% endfor %}
            {% for lab in laboratorios %}
              if(date.getTime() == new Date({{lab.startDate.year}}, {{lab.startDate.month|add:-1}},{{lab.startDate.day}}).getTime()) {
                $(element).css('background-image', 'linear-gradient(to bottom, transparent 80%, {{lab.get_color}} 80% )');
              }
            {% endfor %}
          }
        }
       });

      $('#save-event').click(function () {
        saveEvent();
      });
    }
    
    $(calendario);

    var currentYear = 2018; //como se fosse global

    document.querySelector('#calendar').addEventListener('yearChanged', function(e) {
      //console.log("New year selected: " + e.currentYear);
      currentYear = e.currentYear;
      [].forEach.call(document.querySelectorAll('.ano'), function (el) {
        el.style.display = 'none';
      });
      [].forEach.call(document.querySelectorAll('.ano'+e.currentYear), function (el) {
        el.style.display = 'inline';
      });

      carrega_semestre()
      
     })

    function primeiro(e) {
      //console.log("Semestre selected: 1");
      document.getElementById("primeiro_semestre").style.fontWeight = "bold";
      document.getElementById("primeiro_semestre").style.color = "black";
      document.getElementById("segundo_semestre").style.fontWeight = "normal";
      document.getElementById("segundo_semestre").style.color = "grey";
      
      [].forEach.call(document.querySelectorAll('.semestre'), function (el) {
        el.style.display = 'none';
      });
      var els = Array.from(document.querySelectorAll(".semestre[data-mes]")).filter(el => Number(el.dataset.mes) < 7);
      [].forEach.call(els, function (el) {
        el.style.display = 'inline';
      });

      {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
        //console.log("Semestre coordenacao selected: 1 em " + currentYear);
        [].forEach.call(document.querySelectorAll('.coordenacao'), function (el) {
          el.style.display = 'none';
        });
        var els = Array.from(document.querySelectorAll(".coordenacao[data-mes]")).filter(el => Number(el.dataset.mes) <= 8);
        var els = els.filter(el => Number(el.dataset.mes) >= 3);
        var els = els.filter(el => Number(el.dataset.ano) == currentYear);
        [].forEach.call(els, function (el) {
          el.style.display = 'inline';
        });
      {% endif %}
    }
    document.querySelector('#primeiro_semestre').addEventListener('click', primeiro)

    function segundo(e) {
      //console.log("Semestre selected: 2 em " + currentYear);
      document.getElementById("primeiro_semestre").style.fontWeight = "normal";
      document.getElementById("primeiro_semestre").style.color = "grey";
      document.getElementById("segundo_semestre").style.fontWeight = "bold";
      document.getElementById("segundo_semestre").style.color = "black";

      [].forEach.call(document.querySelectorAll('.semestre'), function (el) {
        el.style.display = 'none';
      });
      var els = Array.from(document.querySelectorAll(".semestre[data-mes]")).filter(el => Number(el.dataset.mes) > 6);
      [].forEach.call(els, function (el) {
        el.style.display = 'inline';
      });

      {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
        //console.log("Semestre coordenacao selected: 2 em " + currentYear);
        [].forEach.call(document.querySelectorAll('.coordenacao'), function (el) {
          el.style.display = 'none';
        });
        
        var els = Array.from(document.querySelectorAll(".coordenacao[data-mes]")).filter(el => Number(el.dataset.mes) > 8);
        var els = els.filter(el => Number(el.dataset.ano) == currentYear);
        [].forEach.call(els, function (el) {
          el.style.display = 'inline';
        });

        var els = Array.from(document.querySelectorAll(".coordenacao[data-mes]")).filter(el => Number(el.dataset.mes) < 3);
        var els = els.filter(el => Number(el.dataset.ano) == currentYear+1);
        [].forEach.call(els, function (el) {
          el.style.display = 'inline';
        });

      {% endif %}

    }
    document.querySelector('#segundo_semestre').addEventListener('click',segundo)

    window.onload = carrega_semestre
    
    function carrega_semestre() {
      //console.log("semestre: {{semestre}}");
      {% if semestre == 1 %}
        primeiro()
      {% else %}
        segundo()
      {% endif %}
    }

  function get_image(tipo) {
    //var imgData = null
    document.querySelector('#tudo').style.width = "1200px";
    setTimeout(function () {
      html2canvas(document.querySelector('#tudo'), {
        width: 1200,
        windowWidth: 1200,
        scrollX: 0,
        scrollY: -window.scrollY
      }).then(function(canvas) {
        if(tipo=="png") {
          var imgData = canvas.toDataURL('image/png');
          saveAs(imgData, 'calendario.png'); // GERA PNG 
        } else {
          var imgData = canvas.toDataURL('image/jpeg');
          if(tipo=="jpg" || tipo=="jpeg") {
            saveAs(imgData, 'calendario.jpg'); // GERA PNG 
          } else
          if(tipo=="pdf") {
            var w = canvas.width
            var h = canvas.height
            var alt = (412 / canvas.width) * canvas.height
            // GERA PDF
            var doc = new jsPDF('portrait', 'px', 'a4', true, true);
            doc.addImage(imgData, 'JPG', 16, 16, 412, alt);
            doc.save('calendario.pdf');
          }
        }
      });
      document.querySelector('#tudo').style.width = "100%";
    }, 600);
  }

  document.getElementById("bpng").addEventListener("click", function() {
    get_image("png")
  });

  document.getElementById("bjpg").addEventListener("click", function() {
    get_image("jpg")
  });

  document.getElementById("bpdf").addEventListener("click", function() {
    get_image("pdf")
  });

  function saveAs(uri, filename) {

    var link = document.createElement('a');

    if (typeof link.download === 'string') {

        link.href = uri;
        link.download = filename;

        //Firefox requires the link to be in the body
        document.body.appendChild(link);

        //simulate click
        link.click();

        //remove the link when done
        document.body.removeChild(link);

    } else {

        window.open(uri);

    }
  }

  </script>

{% endblock %}
