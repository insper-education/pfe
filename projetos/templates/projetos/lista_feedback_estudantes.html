{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 13 de Janeiro de 2020
{% endcomment %}

{% block head %}
    {% load static %}
    
    <script src="{% static 'js/w3.js' %}"></script>
    <script src="{% static 'js/Chart.min.js' %}"></script>
    {% comment %} <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script> {% endcomment %}
    <script src="{% static 'js/chartjs-plugin-labels.js' %}"></script>
    
    {% include "tabelas_includes.html" %}
    
    {% comment %} Para chamar os Tooltips {% endcomment %}
    <script>{% include "tooltip.js" %}</script>
{% endblock %}

{% block content %}

  {% url 'estudante_feedback' as feedback_url%}

  <span class="titulo">{{titulo}}</span>

  Link para pesquisa: <a href="{{ feedback_url }}">{{ SERVER_URL }}{{ feedback_url }}</a><br><br>
  
  <!-- VER: https://stackoverflow.com/questions/53202862/trying-to-sort-tables-with-w3-js-but-its-not-sorting-numbers-properly -->

  {% include "edicoes.html" %}

  <div class="atualizar">

    <script>
      var recomendaria = [0, 0, 0];
      var primeira_opcao = [0, 0];
      var proposta = [0, 0, 0, 0, 0];
      var trabalhando = [0, 0, 0, 0];
      var comentarios = [];
    </script>

  {% include "tabelas_top.html" with tabela="Feedbacks" cabecalhos=cabecalhos %}
      {% comment %} <th onclick="w3.sortHTML('#FeedbacksTable', '.item', 'td:nth-child(1)')" style="cursor:pointer" class="text-center">Nome</th>
      <th onclick="w3.sortHTML('#FeedbacksTable', '.item', 'td:nth-child(2)')" style="cursor:pointer" class="text-center">Projeto</th>
      <th onclick="w3.sortHTML('#FeedbacksTable', '.item', 'td:nth-child(3)')" style="cursor:pointer" class="text-center">Data</th>
      <th class="text-center">Mensagem</th> {% endcomment %}
      {% for estudante, projeto, feedback in alocacoes %}
        <tr class="item">
          <td style='font-size:80%' data-sort="{{estudante.user.get_full_name}}">
            <a href="{% url 'estudante_detail' estudante.id %}">
              {{estudante.user.get_full_name}} {% if estudante.externo %}<span style="color:red">[{{estudante.externo}}]</span>{% endif %}
            </a>
          </td>
          <td style='font-size:80%'>
            {% if projeto %}
              <a href="{% url 'projeto_completo' projeto.id %}">
                {{projeto}}
              </a>
            {% endif %}
          </td>
          <td style='font-size:80%'>
            {% if feedback %}
              <a href="{% url 'mostra_feedback_estudante' feedback.id %}">
                {{feedback.momento|date:"Y.m.d"}}
              </a>
            {% endif %}
          </td>
          {% if feedback.recomendaria %}
            <script>recomendaria[{{feedback.recomendaria}}-1] += 1;</script>
          {% endif %}
          {% if feedback.primeira_opcao != None %}
            <script>primeira_opcao{% if feedback.primeira_opcao %}[0]{% else %}[1]{% endif %} += 1;</script>
          {% endif %}
          {% if feedback.recomendaria %}
            <script>proposta[{{feedback.proposta}}-1] += 1;</script>
          {% endif %}
          {% if feedback.trabalhando %}
            <script>trabalhando[{{feedback.trabalhando}}-1] += 1;</script>
          {% endif %}
          {% if feedback.outros %}
            <script>comentarios.push("{{feedback.outros}}");</script>
          {% endif %}

          <td style='font-size:80%' class="text-center">
            {% comment %} <a href="mailto:{{estudante.user.email}}?subject=Feedback%20Final%20PFE&amp;body={% include 'mensagem_feedback_final.html' %}" target='_blank'> {% endcomment %}
            <a href="mailto:{{estudante.user.email}}?subject=Feedback%20Final%20PFE&amp;body={% include 'mensagem_feedback_final.html' %}" target='_blank'>
              e-mail
            </a>
          </td>
        </tr>
      {% endfor %}
    </table>
  </div>
  

  <p>&nbsp;</p>

  <div id="canvas-holder">
      <canvas style="background-color: #eee;" id="chart-recomendaria"></canvas>
      <p>&nbsp;</p>
      <canvas style="background-color: #eee;"  id="chart-primeira_opcao"></canvas>
      <p>&nbsp;</p>
      <canvas style="background-color: #eee;"  id="chart-proposta"></canvas>
      <p>&nbsp;</p>
      <canvas style="background-color: #eee;"  id="chart-trabalhando"></canvas>
  </div>


  <p>&nbsp;</p>
  <p>&nbsp;</p>

  <table id="ComentariosTable"  style="background-color: #eee;" >
    <tr><td><b>Comentários:</b></td></tr>
  </table>

  <script>
    comentarios.forEach(function(texto, i) {
      $('#ComentariosTable tr:last').after("<tr><td>" + texto + "</td></tr>");
    })
  </script>

  <p>&nbsp;</p>
  <p>&nbsp;</p>

  <div class="chart-container" style="position: relative; max-width:64vh">
      <canvas id="bar-feedbacks"></canvas>
  </div>

  <p>&nbsp;</p>

  <script>

      var config_recomendaria = {     // REFERENTE AO PIE CHART
        type: 'pie',
        data: {
          datasets: [{
            data: recomendaria,
            backgroundColor: [
              "#e74c3c",
              "#95a5a6",
              "#34495e",
            ],
          }],
          labels: [
            'Não recomendo',
            'Recomendo com ressalvas',
            'Recomendo fortemente',
          ]
        },
        options: {
          responsive: true,
          title: {
                display: true,
                text: 'Recomendaria Organização Parceira',
                position: "top",
          },
          legend: {
            display: false,
            position: "bottom",
            labels: {
              fontColor: "#333",
              fontSize: 14
            }
          },
          plugins: {
            labels: [
              {
                render: 'label',
                fontColor: '#000',
                fontStyle: 'bold',
                position: 'outside'
              },
              {
                render: 'percentage'
              }
            ]
          }
        }
      };
    

      var config_primeira_opcao = {     // REFERENTE AO PIE CHART
        type: 'pie',
        data: {
          datasets: [{
            data: primeira_opcao,
            backgroundColor: [
              "#2ecc71",
              "#3498db",
              "#9b59b6",
              "#f1c40f",
            ],
          }],
          labels: [
            'Sim',
            'Não',
          ]
        },
        options: {
          responsive: true,
          title: {
                display: true,
                text: 'Empresa seria uma das primeiras opções',
                position: "top",
          },
          legend: {
            display: false,
            position: "bottom",
            labels: {
              fontColor: "#333",
              fontSize: 14
            }
          },
          plugins: {
            labels: [
              {
                render: 'label',
                fontColor: '#000',
                fontStyle: 'bold',
                position: 'outside'
              },
              {
                render: 'percentage'
              }
            ]
          }
        }
      };


      var config_proposta = {     // REFERENTE AO PIE CHART
        type: 'pie',
        data: {
          datasets: [{
            data: proposta,
            backgroundColor: [
              "#bb79d6",
              "#f1c40f",
              "#f10fc4",
              "#0ff1c4",
              "#59b69b",
            ],
          }],
          labels: [
            'Recebi convite e apliquei',
            'Não recebi convite, mas apliquei',
            'Recebi convite, mas não apliquei',
            'Não recebi, nem apliquei',
            'Não haviam vagas em aberto',
          ]
        },
        options: {
          responsive: true,
          title: {
                display: true,
                text: 'Recebeu proposta de estágio',
                position: "top",
          },
          legend: {
            display: false,
            position: "bottom",
            labels: {
              fontColor: "#333",
              fontSize: 14
            }
          },
          plugins: {
            labels: [
              {
                render: 'label',
                fontColor: '#000',
                fontStyle: 'bold',
                position: 'outside'
              },
              {
                render: 'percentage'
              }
            ]
          }
        }
      };



      var config_trabalhando = {     // REFERENTE AO PIE CHART
        type: 'pie',
        data: {
          datasets: [{
            data: trabalhando,
            backgroundColor: [
              "#bb79d6",
              "#f1c40f",
              "#f10fc4",
              "#0ff1c4",
            ],
          }],
          labels: [
            'Empresa do Projeto do PFE',
            'Outra',
            'Ainda não',
            'Prefiro não responder',
          ]
        },
        options: {
          responsive: true,
          title: {
                display: true,
                text: 'Onde está trabalhando',
                position: "top",
          },
          legend: {
            display: false,
            position: "bottom",
            labels: {
              fontColor: "#333",
              fontSize: 14
            }
          },
          plugins: {
            labels: [
              {
                render: 'label',
                fontColor: '#000',
                fontStyle: 'bold',
                position: 'outside'
              },
              {
                render: 'percentage'
              }
            ]
          }
        }
      };


    var config_feedbacks = {
        type: 'bar',
        data: {
        labels: [
            {% for loop in loop_anos %}
              "{{loop}}",
            {% endfor %}
            ],
        datasets: [
            {
            label: "estudantes",
            backgroundColor: "#0E7E32",
            data: [
                    {% for num in num_estudantes %}
                        {{num}},
                    {% endfor %}
                ]
            }, 
            {
            label: "feedbacks",
            backgroundColor: "#15Cecd",
            data: [
                    {% for num in num_feedbacks %}
                        {{num}},
                    {% endfor %}
                ]
            }, 
        ]
        },
        options: {
          legend: { display: true },
          title: {
              display: true,
              text: 'Estudantes e Feedbacks'
          },
          plugins: {
            labels: [
              {
                render: 'value',
                fontColor: '#000',
                fontStyle: 'bold',
              }
            ]
          }
        }
    };

    function carrega_grafico() {  
      // Chart da quantidade de projetos
      var bar_feedbacks = document.getElementById('bar-feedbacks').getContext('2d');
      window.projeto = new Chart(bar_feedbacks, config_feedbacks);

      var context_recomendaria = $("#chart-recomendaria").get(0).getContext('2d'); // REFERENTE AO PIE CHART
      window.myPie = new Chart(context_recomendaria, config_recomendaria); // REFERENTE AO PIE CHART

      var context_primeira_opcao = $("#chart-primeira_opcao").get(0).getContext('2d'); // REFERENTE AO PIE CHART
      window.myPie2 = new Chart(context_primeira_opcao, config_primeira_opcao); // REFERENTE AO PIE CHART

      var context_proposta = $("#chart-proposta").get(0).getContext('2d'); // REFERENTE AO PIE CHART
      window.myPie3 = new Chart(context_proposta, config_proposta); // REFERENTE AO PIE CHART

      var context_trabalhando = $("#chart-trabalhando").get(0).getContext('2d'); // REFERENTE AO PIE CHART
      window.myPie4 = new Chart(context_trabalhando, config_trabalhando); // REFERENTE AO PIE CHART

    }

      function carrega_pagina() {
        carrega_grafico();
      };
      window.onload = carrega_pagina

    </script>

  </div>

  {% include "edicoes_ajax.html" with tabela='Feedbacks' %}

{% endblock %}