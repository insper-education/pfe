{% extends "base.html" %}
{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 24 de Abril de 2020
{% endcomment %}

{% block head %}
  
  {% load static %}
  {% load bleach %}
  {% load linguas %}
  {% load propostas %}


  {% comment %} REMOVER ESSA PARTE E DEIXAR SÓ O SCRIPT ABAIXO {% endcomment %}

  {% comment %} <script src="{% static 'js/pfe_pulsa_texto.js' %}"></script> {% endcomment %}

<script>
  function pulsa_texto(atualizado, id) {
    // Verifica se o DIV já existe
    var f = document.getElementById(id);
    if (!f) {
        // Cria o DIV se não existir
        f = document.createElement('div');
        f.id = id;
        f.style.color = "white";
        f.style.position = "fixed"; // Fixo na tela
        f.style.top = "10px"; // Distância do topo
        f.style.left = "50%"; // Centraliza horizontalmente
        f.style.transform = "translateX(-50%)"; // Ajusta a posição para centralizar
        f.style.borderRadius = "4px"; // Bordas arredondadas
        f.style.padding = "10px"; // Espaçamento interno
        f.style.zIndex = "1000"; // Garante que fique acima de outros elementos
        f.style.transition = "opacity 0.5s"; // Transição suave
        document.body.appendChild(f); // Adiciona o DIV ao corpo do documento
    }

    // Atualiza o conteúdo e a cor de fundo
    if (atualizado) {
        f.innerHTML = "Valores atualizados no servidor.";
        f.style.backgroundColor = "green";
    } else {
        f.innerHTML = "Erro ao atualizar dados no servidor.";
        f.style.backgroundColor = "red";
    }

    // Exibe o DIV
    f.style.display = '';
    
    // Oculta após 2 segundos
    setTimeout(function() {
        f.style.display = 'none';
    }, 2000);
  }

</script>


  {% comment %} Para o gráfico no final da página {% endcomment %}
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'css/Chart.min.css' %}">

  {% include "tabelas_includes.html" %}

  <style>

    label {
      margin-bottom: 2px;
      line-height: 1.0;
    }
    select {margin-bottom: 12px;}

    /* DataTables sorting arrow alignment fix */
    table.dataTable thead th.sorting:before,
    table.dataTable thead th.sorting:after,
    table.dataTable thead th.sorting_asc:before,
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th.sorting_desc:before,
    table.dataTable thead th.sorting_desc:after {
      bottom: 0.0em !important;
      top: auto !important;
      vertical-align: middle !important;
    }

    #OpcoesEstudantesTable thead th,
    #OpcoesEstudantesTable tbody td {
      padding: 0.05em 0.3em;
    }

  .card-analise {
    border-radius: 8px;
    border: none;
    max-width: 700px;
  }
  
  .card-analise .card-header {
    border-radius: 8px 8px 0 0 !important;
    border-bottom: none;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  }
  
  .card-analise .card-body {
    padding: 1rem;
  }
  
  .card-analise .form-group {
    margin-bottom: 0.75rem;
  }
  
  .card-analise label {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
  }
  
  .card-analise .form-control {
    border-radius: 4px;
    border: 1px solid #ced4da;
    font-size: 0.9rem;
    padding: 0.375rem 0.75rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .card-analise .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25);
  }
  
  .card-analise textarea.form-control {
    resize: vertical;
    min-height: 60px;
  }
  
  .card-analise .btn-success {
    background-color: #28a745;
    border-color: #28a745;
    border-radius: 4px;
    padding: 0.375rem 1rem;
    font-size: 0.875rem;
    transition: all 0.2s ease-in-out;
  }
  
  .card-analise .btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }
  
  .card-analise .alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
    border-radius: 4px;
    border-left: 3px solid #28a745;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }

   .card-disponibilizar {
    border-radius: 8px;
    border: none;
    max-width: 700px;
  }
  
  .card-disponibilizar .card-header {
    border-radius: 8px 8px 0 0 !important;
    border-bottom: none;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  }
  
  .card-disponibilizar .card-body {
    padding: 0.75rem 1rem;
  }
  
  .radio-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .radio-item {
    display: flex;
    align-items: center;
  }
  
  .radio-item input[type="radio"] {
    margin-right: 0.375rem;
    cursor: pointer;
    width: 18px;
    height: 18px;
  }
  
  .radio-item label {
    margin-bottom: 0;
    cursor: pointer;
    font-size: 0.9rem;
    user-select: none;
  }
  
  .info-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
  }
  
  .info-text i {
    margin-right: 0.375rem;
  }

</style>


{% endblock %}

{% block content %}

  {% if not proposta.organizacao %}
  <h2 id="org_conectada" class="text-warning">
    {% lng "Proposta ainda sem organização definitiva" "Proposal still without definitive organization" %}
  </h2><br>
  {% endif %}

  {% with completo=True %}
    {% include "proposta.html" %}
  {% endwith %}

  {% with completo=True %}
    {% include "organizacao.html" %}
  {% endwith %}

  <strong>
    {% lng "Submetido por" "Submitted by" %}:
  </strong><br>
  {{proposta.nome}}<br><br>

  {% with c_t=proposta|contatos_tec %}
    {% if proposta.contatos_tecnicos or c_t %}
      <strong>{% lng "Contatos Técnicos" "Technical Contacts" %}</strong><br>
      {% if proposta.contatos_tecnicos %}
        {{proposta.contatos_tecnicos|linebreaks|bleach_urlize|safe}}
        <br>
      {% endif %}
      {% if c_t %}
        {% for contato in c_t %}
          {{contato}}<br>
        {% endfor %}
      {% endif %}
      <br>
    {% endif %}
  {% endwith %}

  {% with c_a=proposta|contatos_adm %}
    {% if proposta.contatos_administrativos or c_a %}
      <strong>{% lng "Contatos Administrativos" "Administrative Contacts" %}</strong><br>
      {% if proposta.contatos_administrativos %}
        {{proposta.contatos_administrativos|linebreaks|bleach_urlize|safe}}
        <br>
      {% endif %}
      {% if c_a %}
        {% for contato in c_a %}
          {{contato}}<br>
        {% endfor %}
      {% endif %}
      <br>
    {% endif %}
  {% endwith %}

  {% with vencido=True areas_de_interesse_selecionadas=proposta.areadeinteresse_set.all com_borda=True %}
    {% include "areas.html" %}  
  {% endwith %}

  <hr>

  {% with editavel=True %}
    {% include "recomendadas.html" %}
  {% endwith %}

  {% with editavel=True %}
    {% include "perfil_estudantes.html" %}
  {% endwith %}

  <hr>

  
  <form method="post" id="disponibilizacaoform" enctype="multipart/form-data">
    {% csrf_token %}

 
    <div class="card card-analise shadow-sm mb-4">
      <div class="card-header text-white">
        <h6 class="mb-0" style="font-size: 0.95rem;">
          <i class="fas fa-clipboard-check mr-2"></i>
          {% lng "Análise da Proposta" "Proposal Review" %}
        </h6>
      </div>
      <div class="card-body">
        
        <!-- Analisada por -->
        <div class="form-group">
          <label for="autorizador" class="font-weight-bold">
            <i class="fas fa-user-check mr-1"></i>
            {% lng "Analisada por" "Analyzed by" %}
          </label>
          <select class="form-control fechar_proposta" name="autorizador" id="autorizador" 
                  data-toggle="tooltip" data-html="true" animation="true" 
                  title="Mesmo ao autorizar uma proposta, esta só será visível para os estudantes depois que a liberação de visualização for habilitada."
                  required>
            <option value='0'>{% lng "Selecione um revisor" "Select a reviewer" %}</option>
            {% for pessoa in comite %}
              <option value="{{pessoa.id}}" {% if pessoa.id == proposta.autorizado.id %}selected{% endif %}>
                {{ pessoa.get_full_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Anotações -->
        <div class="form-group">
          <label for="anotacoes" class="font-weight-bold">
            <i class="fas fa-sticky-note mr-1"></i>
            {% lng "Anotações" "Notes" %}
            <span class="text-muted font-weight-normal" style="font-size: 0.85rem;">({% lng "opcional" "optional" %})</span>
          </label>
          <textarea class="form-control anotacoes_proposta" name="anotacoes" id="anotacoes" rows="2"
                    placeholder="Anotações sobre a conformidade da proposta"
                    >{% if proposta.anotacoes %}{{proposta.anotacoes}}{% endif %}</textarea>
        </div>
        <script>
          let lastValue = `{% if proposta.anotacoes %}{{proposta.anotacoes}}{% endif %}`;
          let saveInterval = 2000; // Tempo em milissegundos (2 segundos)
          let saveTimeout;

          function checkForChanges() {
            const currentValue = $('#anotacoes').val();
            if (currentValue !== lastValue) {
              lastValue = currentValue;
              clearTimeout(saveTimeout);
              saveTimeout = setTimeout(fechar_proposta, saveInterval);
            }
          }

          $(document).ready(function() {
            // Verifica mudanças a cada 500ms
            setInterval(checkForChanges, 500);
          });
        </script>

      </div>
    </div>

    {% include "conformidade.html" %}

    <div class="card card-disponibilizar shadow-sm mb-4">
      <div class="card-header text-white">
        <h6 class="mb-0" style="font-size: 0.95rem;">
          <i class="fas fa-eye mr-2"></i>
          {% lng "Disponibilização" "Availability" %}
        </h6>
      </div>
      <div class="card-body">
        
        <label class="font-weight-bold mb-2">
          <i class="fas fa-unlock mr-1"></i>
          {% lng "Disponibilizar proposta:" "Make proposal available:" %}
        </label>
        
        <div class="radio-group">
          <div class="radio-item">
            <input class="fechar_proposta disponibilizar" 
                  type="radio" 
                  name="disponibilizar" 
                  id="disp_sim"
                  value="sim"
                  {% if proposta.disponivel %}checked{% endif %}>
            <label for="disp_sim">
              {% lng "Sim" "Yes" %}
            </label>
          </div>
          
          <div class="radio-item">
            <input class="fechar_proposta disponibilizar" 
                  type="radio" 
                  name="disponibilizar" 
                  id="disp_nao"
                  value="nao"
                  {% if not proposta.disponivel %}checked{% endif %}>
            <label for="disp_nao">
              {% lng "Não" "No" %}
            </label>
          </div>
        </div>
        
        <div class="info-text">
          <i class="fas fa-info-circle"></i>
          <span>
            {% lng "Previsão para liberar visualização de propostas para estudantes em:" "Forecast to release proposal visualization for students on:" %}
            <strong>{{liberacao_visualizacao.startDate}}</strong>
          </span>
        </div>

      </div>
    </div>

    {% include "prioridades.html" %}

    <div class="card card-analise shadow-sm mb-4">
      <div class="card-header text-white">
        <h6 class="mb-0" style="font-size: 0.95rem;">
          <i class="fas fa-users mr-2"></i>
          {% lng "Estudantes Aplicando para a Proposta" "Students Applying for the Proposal" %}
        </h6>
      </div>
      <div class="card-body">
        <table id="OpcoesEstudantesTable" class="table-bordered table-hover">
          <thead class="table-info">
            <tr>
              <th title="Nome do estudante">{% lng "Nome" "Name" %}</th>
              <th title="Curso do estudante">{% lng "Curso" "Program" %}</th>
              <th style="width: 5em;" title="Prioridade de opção do estudante">{% lng "Ordem" "Order" %}</th>
              <th style="width: 3em;" title="Coeficiente de Rendimento Acadêmico do estudante">{% lng "CR" "GPA" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for estudante in sem_opcao %}
              <tr class="font-weight-bold" style="background-color:rgb(255, 148, 255);">
                <td><a href="{% url 'estudante_detail' estudante.id %}">{{estudante.user.get_full_name}}</a></td>
                <td>{{estudante.curso2}}</td>
                <td class="text-center" data-order="0">
                  {% lng "SEM" "WITHOUT" %}
                </td>
                <td class="text-right">{{estudante.cr|floatformat:2}}</td>
              </tr>
            {% endfor %}
            {% for opcao in proposta.opcao_set.all %}
              <tr class="{% if opcao.aluno in estudantes %}font-weight-bold{% endif %}"
              style="background-color:
                {% if opcao.prioridade == 1 %}
                  {{cores_opcoes.0}}
                {% elif opcao.prioridade == 2 %}
                  {{cores_opcoes.1}}
                {% elif opcao.prioridade == 3 %}
                  {{cores_opcoes.2}}
                {% elif opcao.prioridade == 4 %}
                  {{cores_opcoes.3}}
                {% elif opcao.prioridade == 5 %}
                  {{cores_opcoes.4}}
                {% else %}
                  rgb(158, 158, 158)
                {% endif %};">
                <td><a href="{% url 'estudante_detail' opcao.aluno.id %}">{{opcao.aluno.user.get_full_name}}</a></td>
                <td>{{opcao.aluno.curso2}}</td>
                <td class="text-center" data-order="{{opcao.prioridade}}">{{opcao.prioridade}}</td>
                <td class="text-right">{{opcao.aluno.cr|floatformat:2}}</td>
              </tr>
            {% endfor %}
          </tbody>
          <caption style="caption-side: bottom; font-size: 0.9em; padding-top: 1px; text-align: right;">
            {% lng "Estudantes em negrito foram selecionados para a proposta" "Students in bold were selected for the proposal" %}
          </caption>
        </table>
      </div>
    </div>

    <script>
      $(document).ready(function() {
        function toggleConformidade() {
            var autorizadorValue = $("#autorizador").val();
            if (autorizadorValue === '0' || autorizadorValue === '') {
                $(".conformidade").prop("disabled", true);
            } else {
                $(".conformidade").prop("disabled", false);
            }
        }

        // Primeira interação
        toggleConformidade();

        // Sempre que mudar verificar
        $("#autorizador").change(function() {
            toggleConformidade();
        });

        function toggleDisponibilizar() {
          var allChecked = true;
          $(".conformidade").each(function() {
              if (!$(this).is(":checked")) {
                  allChecked = false;
              }
          });

          if (allChecked) {
              $(".disponibilizar").prop("disabled", false);
          } else {
              $(".disponibilizar").prop("disabled", true);
          }
        }

        // Initial check
        toggleDisponibilizar();

        // Check on change
        $(".conformidade").change(function() {
            toggleDisponibilizar();
        });

      });

    </script>

    <br><br>
    <div style="max-width: 56em; text-align: center;">
      <a class="btn btn-primary mb-1 mt-2" style="width: 13em;" href="{% url 'proposta_editar' proposta.slug %}">
        {% lng "Editar Proposta" "Edit Proposal" %}
      </a>
      <a class="btn btn-primary mb-1 mt-2" style="width: 13em;" href="{% url 'proposta_detalhes' proposta.id %}">
        {% lng "Visão do Estudante" "Student View" %}
      </a>
      
      {% for projeto in projetos %}
        <a class="btn btn-primary mb-1 mt-2" style="width: 13em;" href="{% url 'projeto_infos' projeto.id %}">
          {% lng "Projeto" "Project" %}
          {{projeto.ano}}.{{projeto.semestre}}
        </a>
        <a class="btn btn-danger mb-1 mt-2" style="width: 13em; color:white;" onClick="return confirm('Proposta possui um projeto e não pode ser removida')">
          {% lng "Remover Proposta" "Remove Proposal" %}
        </a>
      {% empty %}
        <a class="btn btn-primary mb-1 mt-2" data-toggle="tooltip" data-html="true" animation="true" title="criar projeto dessa proposta"
        onclick="cria_projeto()" style="width: 13em; padding-bottom: 3px; color:white;">Criar Projeto</a>
        <a class="btn btn-danger mb-1 mt-2" style="width: 13em; color:white;" href="{% url 'proposta_remover' proposta.slug %}" onClick="return confirm('Tem certeza que deseja remover proposta definitivamente?')">
          {% lng "Remover Proposta" "Remove Proposal" %}
        </a>
      {% endfor %}
    </div>
    <br>

  {% if not projetos %}
    <script>
      function cria_projeto() {
        if (confirm('Não existe um projeto para essa proposta, deseja criar?')) {
          window.open("{% url 'projeto_criar' proposta.id %}");
        }
      }
    </script>
  {% endif %}

  </form>

  <script>
      
    function fechar_proposta() {
      var autorizador = $("#autorizador option:selected").attr("value");
      var disponibilizar = $("input[name=disponibilizar]:checked", "#disponibilizacaoform").val();
      var anotacoes = $("#anotacoes").val();

      var dict = {};
      $(".fechar_proposta").each(function() {
        dict[$(this).attr("name")] = $(this).is(":checked");
      })

      url = "{% url 'ajax_proposta' proposta.id %}";

      data = {
        autorizador: autorizador,
        disponibilizar: disponibilizar,
        dict: dict,
        anotacoes: anotacoes,
      };
      
      function success(response){
        pulsa_texto(response.atualizado, "valor_atualizado");
      };

      {% include "ajax_default_function.js" %}
    
    }

    $(".fechar_proposta").change(fechar_proposta);

  </script>

  {% include "forum_respostas.html" %}

  {% comment %} Só Para usar DataTables {% endcomment %}
  {% comment %} tabela="OpcoesEstudantes" {% endcomment %}
  <script>
    {% include "tabelas_scripts.js" %}
    $(document).ready(function() {
      // get language
      lingua_atual = localStorage.getItem("lingua");
      $('#OpcoesEstudantesTable').DataTable({
        "order": [[2, "asc"]],
        "paging": false,
        "searching": false,
        "language": textos_linguas[lingua_atual]
      });
    });
  </script>

{% endblock %}