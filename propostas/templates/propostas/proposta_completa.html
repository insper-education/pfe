{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Abril de 2020
{% endcomment %}

{% block head %}
  
  {% load static %}

  <style type="text/css">
    td label { 
       display: block;
       text-align: center;
    }
  </style>

  {% comment %} Para o gráfico no final da página {% endcomment %}
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'css/Chart.min.css' %}">

{% endblock %}

{% block content %}

  {% with completo=True %}
    {% include "proposta.html" %}
  {% endwith %}

  {% with completo=True %}
    {% include "organizacao.html" %}
  {% endwith %}

  <strong>Submetido por:</strong><br>
  {{proposta.nome}}<br><br>

  {% if proposta.contatos_tecnicos %}
    <strong>Contatos Técnicos</strong><br>
    {{proposta.contatos_tecnicos|linebreaks|urlize}}
    <br><br>
  {% endif %}

  {% if proposta.contatos_administrativos %}
    <strong>Contatos Administrativos</strong><br>
    {{proposta.contatos_administrativos|linebreaks|urlize}}
    <br><br>
  {% endif %}

  <h4>Áreas de Interesse</h4>
  {% with aa=proposta.areadeinteresse_set.all %}
    {% with vencido=True %}
      {% include "areas.html" %}
    {% endwith %}
  {% endwith %}
  <br>

  {% with editavel=True %}
    {% include "recomendadas.html" %}
  {% endwith %}

  {% with editavel=True %}
    {% include "perfil_estudantes.html" %}
  {% endwith %}

  <hr>

  <form method="post" id="disponibilizacaoform" enctype="multipart/form-data">
    {% csrf_token %}
    <br><b><label for="autorizador">Autorizado por</label></b>:
    <select class="fechar_proposta" name="autorizador" id="autorizador" title="Selecione quem autorizou proposta" required>
        <option value='0'> ---- </option>
        {% for pessoa in comite %}
          <option value="{{pessoa.id}}" {% if pessoa.id == proposta.autorizado.id %}selected{% endif %}>
            {{pessoa}}
          </option>  
        {% endfor %}
    </select>

    <br><b>Disponibilizar: </b>
    <label><input class="fechar_proposta" type="radio" name="disponibilizar" value="sim"
      {% if proposta.disponivel %}checked{% endif %}
    > Sim</label>
    <label><input class="fechar_proposta" type="radio" name="disponibilizar" value="nao"
      {% if not proposta.disponivel %}checked{% endif %}
    > Não</label>


    <br><br>
    <a class="myButton" href="{% url 'proposta_editar' proposta.slug %}">Editar Proposta</a>
    <a class="myButton" href="{% url 'proposta_detalhes' proposta.id %}">Visão do Estudante</a>

    {% for projeto in projetos %}
      <a class="myButton" href="{% url 'projeto_completo' projeto.id %}">Projeto {{projeto.ano}}.{{projeto.semestre}}</a>
    {% empty %}
      <a class="myButton" data-toggle="tooltip" data-html="true" animation="true" title="criar projeto dessa proposta"
      onclick="cria_projeto()" style="color:white;">Criar Projeto</a>
    {% endfor %}
    <br><br>

  {% if not projetos %}
    <script>
      function cria_projeto() {
        if (confirm('Não existe um projeto para essa proposta, deseja criar?')) {
          window.open("{% url 'projeto_criar' proposta.id %}");
        }
      }
    </script>
  {% endif %}

  </form>

  {% include "prioridades.html" %}

  <br>
  <h4>Aluno(s) Aplicando para a Proposta</h4>

  {% for estudante in sem_opcao %}
    <a href="{% url 'estudante_detail' estudante.id %}"
      class="dark-green-bold">
        {{estudante.user.get_full_name}}
        [{{ estudante.get_curso_display }}]
        &nbsp;=>&nbsp;SEM PRIORIDADE DEFINIDA
        &nbsp;|
        {% comment %} &nbsp;{ {{estudante.anoPFE}}.{{estudante.semestrePFE}} } {% endcomment %}
        &nbsp;CR={{estudante.cr}}
      <br>
    </a>
  {% endfor %}

  {% for opcao in proposta.opcao_set.all %}
    {% if proposta.ano == opcao.aluno.anoPFE and proposta.semestre == opcao.aluno.semestrePFE %}
    <a href="{% url 'estudante_detail' opcao.aluno.id %}"
       class="
       {% if opcao.aluno in estudantes %}
        {% if opcao.prioridade <= 5 %}green-bold{% else %}yellow-bold{% endif %}
       {% else %}
        {% if opcao.prioridade <= 5 %}green-normal{% else %}yellow-normal{% endif %}
       {% endif %}
       ">
        {{opcao.aluno.user.get_full_name}}
        [{{ opcao.aluno.get_curso_display }}]
        &nbsp;=>&nbsp;opção #{{opcao.prioridade}}
        &nbsp;|
        &nbsp;CR={{opcao.aluno.cr}}
      <br>
    </a>
    {% endif %}
  {% endfor %}
  <p style="line-height:2px">
    --------------------------------------------------------------------------------------
  </p>
  {% for opcao in proposta.opcao_set.all %}
    {% if proposta.ano != opcao.aluno.anoPFE or proposta.semestre != opcao.aluno.semestrePFE %}
    <a href="{% url 'estudante_detail' opcao.aluno.id %}" class="{% if opcao.aluno in estudantes %}red-bold{% else %}red-normal{% endif%}">
        {{opcao.aluno.user.get_full_name}}
        [{{ opcao.aluno.get_curso_display }}]
        &nbsp;=>&nbsp;opção #{{opcao.prioridade}}
        &nbsp;|&nbsp;{ {{opcao.aluno.anoPFE}}.{{opcao.aluno.semestrePFE}} }
        &nbsp;CR={{opcao.aluno.cr}}
      <br>
    </a>
    {% endif %}
  {% endfor %}
  <br>

  <p>&nbsp;</p>
  <p>&nbsp;</p>

<script>

     function fechar_proposta() {
      var autorizador = $("#autorizador option:selected").attr("value");
      var disponibilizar = $('input[name=disponibilizar]:checked', '#disponibilizacaoform').val();

      $.ajax({
          type: "POST",
          data: {    
              autorizador: autorizador,
              disponibilizar: disponibilizar,
              'csrfmiddlewaretoken': '{{ csrf_token }}',
          },
          success: function(response){
            if (response.atualizado) {
              console.log("Valor atualizado.");
            }
          },
          error: function(response) {
              console.log('error')
          }
      });
    }

    $(".fechar_proposta").change(fechar_proposta);

  </script>

  <script>
    $(".alunos").change(function () {
      var vaga = $(this).val();
      var checked = $(this).prop('checked');

      $.ajax({
        url: '{% url "validate_alunos" %}',
        data: {
          'proposta': {{proposta.id}},
          'vaga': vaga,
          'checked': checked,
        },
        dataType: 'json',
        success: function (response) {
          if (response.atualizado) {
            console.log("Valor atualizado.");
          }
        },
        error: function(response) {
            console.log('error')
        }
      });
    });
  </script>

{% endblock %}