{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 24 de Abril de 2020
{% endcomment %}

{% block head %}
  
  {% load static %}

  <style type="text/css">
    td label { 
       display: block;
       text-align: center;
    }
  </style>

  {% comment %} Para o gráfico no final da página {% endcomment %}
  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'css/Chart.min.css' %}">

{% endblock %}

{% block content %}

  {% with completo=True %}
    {% include "proposta.html" %}
  {% endwith %}

  {% with completo=True %}
    {% include "organizacao.html" %}
  {% endwith %}

  <strong>Submetido por:</strong><br>
  {{proposta.nome}}<br><br>

  {% if proposta.contatos_tecnicos %}
    <strong>Contatos Técnicos</strong><br>
    {{proposta.contatos_tecnicos|linebreaks|urlize}}
    <br><br>
  {% endif %}

  {% if proposta.contatos_administrativos %}
    <strong>Contatos Administrativos</strong><br>
    {{proposta.contatos_administrativos|linebreaks|urlize}}
    <br><br>
  {% endif %}

  <h4>Áreas de Interesse</h4>
  {% with aa=proposta.areadeinteresse_set.all %}
    {% with vencido=True %}
      {% include "areas.html" %}
    {% endwith %}
  {% endwith %}
  <br>

  {% with editavel=True %}
    {% include "recomendadas.html" %}
  {% endwith %}

  {% with editavel=True %}
    {% include "perfil_estudantes.html" %}
  {% endwith %}

  <hr>

  <form method="post" id="disponibilizacaoform" enctype="multipart/form-data">
    {% csrf_token %}

    <br><b>Conformidade de Proposta: </b>

    <table class="table table-borderless" style="width: auto;">
      <tbody>
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="habilidades" name="habilidades" value="True" {% if proposta.habilidades %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="habilidades" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal require knowledge and skills acquired from previous years of engineering course work?">
              A proposta de projeto requer conhecimentos e habilidades adquiridos em anos anteriores do curso de engenharia?
            </label>
          </td>
        </tr>

        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="design" name="design" value="True" {% if proposta.design %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="design" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal require students to apply a systematic engineering design process for a system, component, or process to meet desired needs?">
              A proposta do projeto exige que os alunos apliquem um processo sistemático de projeto de engenharia para um sistema, componente ou processo para atender às necessidades desejadas?
            </label>
          </td>
        </tr>

        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="realistico" name="realistico" value="True" {% if proposta.realistico %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="realistico" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal represent a have a real-world or real-industry experience that are formally requested by an external organization?">
              A proposta do projeto representa uma experiência do mundo real ou da indústria real que é solicitada formalmente por uma organização externa?
            </label>
          </td>
        </tr>
        
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="normas" name="normas" value="True" {% if proposta.normas %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="normas" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal have opportunity to incorporates appropriate engineering standards that can be further referenced in the project reports?">
              A proposta do projeto tem oportunidade de incorporar padrões de engenharia apropriados que podem ser referenciados posteriormente nos relatórios do projeto?
            </label>
          </td>
        </tr>
        
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="restricoes" name="restricoes" value="True" {% if proposta.restricoes %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="restricoes" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal design challenge incorporate multiple realistic constraints, such as economic, environmental, social, political, ethical, health and safety, manufacturability, and/or sustainability?">
              A proposta do projeto possui um desafio de design que incorpora várias restrições realistas, como econômica, ambiental, social, política, ética, saúde e segurança, capacidade de fabricação e/ou sustentabilidade?
            </label>
          </td>
        </tr>
        
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="experimentacao" name="experimentacao" value="True" {% if proposta.experimentacao %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="experimentacao" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal require experimentation and hands-on skills?">
              A proposta do projeto requer experimentação e habilidades práticas?
            </label>
          </td>
        </tr>
        
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="equipe" name="equipe" value="True" {% if proposta.equipe %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="equipe" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal allow teamwork among students in one or more engineering programs?">
              A proposta do projeto permite o trabalho em equipe entre alunos de um ou mais cursos de engenharia?
            </label>
          </td>
        </tr>
        
        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="duracao" name="duracao" value="True" {% if proposta.duracao %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="duracao" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal complexity is appropriate to one academic semester (around 4.5 months)?">
              A proposta do projeto possui uma complexidade adequada a um semestre letivo (cerca de 4,5 meses)?
            </label>
          </td>
        </tr>

        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="carga" name="carga" value="True" {% if proposta.carga %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="carga" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal is sufficient complexity to allow each team member to contribute about 360 hours among class, laboratory, meetings, and outside class time?">
              A proposta do projeto é de complexidade suficiente para permitir que cada membro da equipe contribua com cerca de 360 horas entre aula, laboratório, reuniões e fora do horário de aula?
            </label>
          </td>
        </tr>        

        <tr>
          <td>
            <input class="fechar_proposta" type="checkbox" id="mensuravel" name="mensuravel" value="True" {% if proposta.mensuravel %}checked{% endif %}>
          </td>
          <td>
            <label style="text-align: left;" for="mensuravel" data-toggle="tooltip" data-html="true" animation="true" title="Does the project proposal have concrete and measurable goals?">
              A proposta do projeto tem objetivos concretos e mensuráveis?
            </label>
          </td>
        </tr>
        
      </tbody>
    </table>

    <br><b><label for="autorizador">Autorizado por</label></b>:
    <select class="fechar_proposta" name="autorizador" id="autorizador" title="Selecione quem autorizou proposta" required>
        <option value='0'> ---- </option>
        {% for pessoa in comite %}
          <option value="{{pessoa.id}}" {% if pessoa.id == proposta.autorizado.id %}selected{% endif %}>
            {{pessoa}}
          </option>  
        {% endfor %}
    </select>

    <br><b>Disponibilizar: </b>
    <label><input class="fechar_proposta" type="radio" name="disponibilizar" value="sim"
      {% if proposta.disponivel %}checked{% endif %}
    > Sim</label>
    <label><input class="fechar_proposta" type="radio" name="disponibilizar" value="nao"
      {% if not proposta.disponivel %}checked{% endif %}
    > Não</label>


    <br><br>
    <a class="myButton" href="{% url 'proposta_editar' proposta.slug %}">Editar Proposta</a>
    <a class="myButton" href="{% url 'proposta_detalhes' proposta.id %}">Visão do Estudante</a>
    
    {% for projeto in projetos %}
      <a class="myButton" href="{% url 'projeto_completo' projeto.id %}">Projeto {{projeto.ano}}.{{projeto.semestre}}</a>
      <a class="myButton" onClick="return confirm('Proposta possui um projeto e não pode ser removida')" >Remove Proposta</a>
    {% empty %}
      <a class="myButton" data-toggle="tooltip" data-html="true" animation="true" title="criar projeto dessa proposta"
      onclick="cria_projeto()" style="color:white;">Criar Projeto</a>
      <a class="myButton" href="{% url 'proposta_remover' proposta.slug %}" onClick="return confirm('Tem certeza que deseja remover proposta definitivamente?')" >Remove Proposta</a>
    {% endfor %}
    <br><br>

  {% if not projetos %}
    <script>
      function cria_projeto() {
        if (confirm('Não existe um projeto para essa proposta, deseja criar?')) {
          window.open("{% url 'projeto_criar' proposta.id %}");
        }
      }
    </script>
  {% endif %}

  </form>

  {% include "prioridades.html" %}

  <br>
  <h4>Aluno(s) Aplicando para a Proposta</h4>

  {% for estudante in sem_opcao %}
    <a href="{% url 'estudante_detail' estudante.id %}"
      class="dark-green-bold">
        {{estudante.user.get_full_name}}
        [{{ estudante.get_curso_display }}]
        &nbsp;=>&nbsp;SEM PRIORIDADE DEFINIDA
        &nbsp;|
        {% comment %} &nbsp;{ {{estudante.anoPFE}}.{{estudante.semestrePFE}} } {% endcomment %}
        &nbsp;CR={{estudante.cr}}
      <br>
    </a>
  {% endfor %}

  {% for opcao in proposta.opcao_set.all %}
    {% if proposta.ano == opcao.aluno.anoPFE and proposta.semestre == opcao.aluno.semestrePFE %}
    <a href="{% url 'estudante_detail' opcao.aluno.id %}"
       class="
       {% if opcao.aluno in estudantes %}
        {% if opcao.prioridade <= 5 %}green-bold{% else %}yellow-bold{% endif %}
       {% else %}
        {% if opcao.prioridade <= 5 %}green-normal{% else %}yellow-normal{% endif %}
       {% endif %}
       ">
        {{opcao.aluno.user.get_full_name}}
        [{{ opcao.aluno.get_curso_display }}]
        &nbsp;=>&nbsp;opção #{{opcao.prioridade}}
        &nbsp;|
        &nbsp;CR={{opcao.aluno.cr}}
      <br>
    </a>
    {% endif %}
  {% endfor %}
  <p style="line-height:2px">
    --------------------------------------------------------------------------------------
  </p>
  {% for opcao in proposta.opcao_set.all %}
    {% if proposta.ano != opcao.aluno.anoPFE or proposta.semestre != opcao.aluno.semestrePFE %}
    <a href="{% url 'estudante_detail' opcao.aluno.id %}" class="{% if opcao.aluno in estudantes %}red-bold{% else %}red-normal{% endif%}">
        {{opcao.aluno.user.get_full_name}}
        [{{ opcao.aluno.get_curso_display }}]
        &nbsp;=>&nbsp;opção #{{opcao.prioridade}}
        &nbsp;|&nbsp;{ {{opcao.aluno.anoPFE}}.{{opcao.aluno.semestrePFE}} }
        &nbsp;CR={{opcao.aluno.cr}}
      <br>
    </a>
    {% endif %}
  {% endfor %}

<script>

     function fechar_proposta() {
      var autorizador = $("#autorizador option:selected").attr("value");
      var disponibilizar = $('input[name=disponibilizar]:checked', '#disponibilizacaoform').val();

      var dict = {};
      $(".fechar_proposta").each(function() {
        dict[$(this).attr("name")] = $(this).is(':checked');
      })

      $.ajax({
          type: "POST",
          data: {    
              autorizador: autorizador,
              disponibilizar: disponibilizar,
              dict: dict,
              'csrfmiddlewaretoken': '{{ csrf_token }}',
          },
          success: function(response){
            if (response.atualizado) {
              console.log("Valor atualizado.");
            }
          },
          error: function (request, status, error) {
            {% if user.tipo_de_usuario == 4 %} 
              alert(request.responseText);
              jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
              console.log('error'+request.responseText);
            {% else %}
              jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
            {% endif %}
          }
      });
    }

    $(".fechar_proposta").change(fechar_proposta);

    $(".alunos").change(function () {
      var vaga = $(this).val();
      var checked = $(this).prop('checked');

      $.ajax({
        url: '{% url "validate_alunos" %}',
        data: {
          'proposta': {{proposta.id}},
          'vaga': vaga,
          'checked': checked,
        },
        dataType: 'json',
        success: function (response) {
          if (response.atualizado) {
            console.log("Valor atualizado.");
          }
        },
        error: function (request, status, error) {
          {% if user.tipo_de_usuario == 4 %} 
            alert(request.responseText);
            jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
            console.log('error'+request.responseText);
          {% else %}
            jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
          {% endif %}
        }
      });
    });
  </script>

{% endblock %}