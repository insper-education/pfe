{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 22 de Abril de 2020
{% endcomment %}

{% block head %}
  {% load static %}
  {% load rubricas %}

  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      text-align: left;
      padding: 8px;
    }

    table, th, td {
      border: 1px solid lightgrey;
    }

    tr:nth-child(even) {background-color: #f2f2f2;}
  
    ul {padding-left: 28px;}

  </style>

  {% include "cores_bancas.html" %}
  
  <script>{% include "tooltip.js" %}</script>

  {% comment %} Converte notas para conceitos e vice-versa {% endcomment %}
  {% include "converte_notas.html" %}

  {% include "avalia_objetivos.html" %}

  <script>
    let intermediaria = new Banca(); 
    let final = new Banca(); 
    let falconi = new Banca(); 
  </script>

{% endblock %}

{% block content %}

  <span class="titulo">
    Projeto: <a href="{% url 'projeto_completo' projeto.id %}">{{projeto.get_titulo}}</a>
    {% if projeto.titulo_final %}
      <i>Título original: <a href="{% url 'projeto_completo' projeto.id %}">{{projeto.titulo}}</a></i>
    {% endif %}
  </span>

  <strong>Semestre:</strong> {{projeto.ano}}.{{projeto.semestre}}<br>

  {% if projeto.orientador %}
    <strong>Orientador{% if projeto.orientador.user.genero == "F" %}a{% endif %}: </strong>
    <a href="{% url 'professor_detail' projeto.orientador.id %}">
      {{projeto.orientador.user.get_full_name}}
    </a>
    <br>
  {% endif %}
  <strong>Organização: </strong>
    <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">
      {{projeto.organizacao}}
    </a><br>
  
  {% include "tipo_projeto.html" with com_tipo=True %}<br>
  
  <strong>Grupo:</strong>
  <ul>
  {% for alocacao in projeto.alocacao_set.all %}
    <a href="{% url 'estudante_detail' alocacao.aluno.id %}">
      <li>
        {{alocacao.aluno.user.get_full_name}} 
        [{{ alocacao.aluno.curso2 }}]
        &lt;{{alocacao.aluno.user.email}}&gt; 
      </li>
    </a>
  {% endfor %}
  </ul>

  {% if avaliadores_inter %}
    <h5>
    {% for banca in projeto.banca_set.all %}
      {% if banca.tipo_de_banca == 1 %}
          <a style="margin-right: 1em;" href="{% url 'banca_ver' banca.id %}">
            Banca Intermediária ({{banca.startDate|date:"d/m/y"}})
          </a>
      {% endif %}
    {% endfor %}
    </h5>
    <table>    
      {% for avaliador, objs in avaliadores_inter.items %}
          <tr><td>
            <strong>Avaliador{% if avaliador.genero == "F" %}a{% endif %}: </strong>
            <a href="{% url 'professor_detail' avaliador.professor.id %}">
              {{avaliador.get_full_name}}
            </a><br>
            <strong>Avaliado em: </strong>{{objs.momento}}<br>
            <strong>Conceitos:</strong><br>
            <ul style="list-style-type: '&#x21A3; ';">
              {% for objetivo, conceito in objs.items %}{% if objetivo != "momento" and objetivo|slice:11 != "observacoes" %}

                <li>
                  <span style="font-weight: 500;">{{objetivo.titulo}}</span>: 
                  <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:objetivo.id|get_texto_intermediaria_nota:conceito.nota}}">
                <span id="inter{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}"></span></span></li>
                <script>
                  $("#inter{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}").html(
                    {% if conceito.nota %}converteN({{conceito.nota}}){% else %}"N/A"{% endif %}
                  );
                  objetivo_tmp = new Objetivo();
                  objetivo_tmp.titulo = "{{objetivo.titulo}}"
                  intermediaria.add_objetivo(objetivo_tmp)
                  {% if conceito.nota %}
                    intermediaria.dict[objetivo_tmp.titulo].soma_nota({{conceito.nota}});
                  {% endif %}
                </script>

              {% endif %}{% endfor %}
              
              {% if objs.observacoes_orientador %}  
                <li><span style="font-weight: 500;">Observações para o Orientador</span>: {{objs.observacoes_orientador}}</li>
              {% endif %}

            </ul>

          </td></tr>

      {% endfor %}

      <tr style="background-color: var(--color_banca_intermediaria); color: darkslategrey"><td>
        <b>Média das avaliações intermediárias:<ul id="med_aval" style="list-style-type: '&#x21A3; ';"></ul></b>
        <span id="med_interm_calc"></span>
        <script>
          for (var key in intermediaria.dict) {
            if(intermediaria.dict[key].avaliacoes>0) $('#med_aval').append(intermediaria.dict[key].texto());
          }
          $("#med_interm_calc").html(intermediaria.media_calculada());
        </script>
      </td></tr>

    </table>
  {% endif %}

  <br>

  {% if avaliadores_final %}
    <h5>
    {% for banca in projeto.banca_set.all %}
      {% if banca.tipo_de_banca == 0 %}
          <a style="margin-right: 1em;" href="{% url 'banca_ver' banca.id %}">
            Banca Final ({{banca.startDate|date:"d/m/y"}})
          </a>
      {% endif %}
    {% endfor %}
    </h5>
    <table>    
      {% for avaliador, objs in avaliadores_final.items %}
          <tr><td>
            <strong>Avaliador{% if avaliador.genero == "F" %}a{% endif %}: </strong>
            <a href="{% url 'professor_detail' avaliador.professor.id %}">
              {{avaliador.get_full_name}}
            </a><br>
            <strong>Avaliado em: </strong>{{objs.momento}}<br>
            <strong>Conceitos:</strong><br>
            <ul style="list-style-type: '&#x21A3; ';">
              {% for objetivo, conceito in objs.items %}{% if objetivo != "momento" and objetivo|slice:11 != "observacoes" %}

                <li><span style="font-weight: 500;">{{objetivo.titulo}}</span>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:objetivo.id|get_texto_final_nota:conceito.nota}}">
                <span id="final{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}"></span></span></li>
                <script>
                  $("#final{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}").html(
                    {% if conceito.nota %}converteN({{conceito.nota}}){% else %}"N/A"{% endif %}
                  );
                  objetivo_tmp = new Objetivo();
                  objetivo_tmp.titulo = "{{objetivo.titulo}}"
                  final.add_objetivo(objetivo_tmp)
                  {% if conceito.nota %}
                    final.dict[objetivo_tmp.titulo].soma_nota({{conceito.nota}});
                  {% endif %}
                </script>

              {% endif %}{% endfor %}
              
              {% if objs.observacoes_orientador %}
                <li><span style="font-weight: 500;">Observações para o Orientador</span>: {{objs.observacoes_orientador}}</li>
              {% endif %}
              
            </ul>

          </td></tr>

      {% endfor %}

      <tr style="background-color: var(--color_banca_final); color: darkslategrey"><td>
        <b>Média das avaliações finais:<ul id="med_final" style="list-style-type: '&#x21A3; ';"></ul></b>
        <span id="med_final_calc"></span>
        <script>
          for (var key in final.dict) {
            if(final.dict[key].avaliacoes>0) $('#med_final').append(final.dict[key].texto());
          }
          $("#med_final_calc").html(final.media_calculada());
        </script>
      </td></tr>

    </table>
  {% endif %}
  <br>

  {% if avaliadores_falconi %}
    <h5>
    {% for banca in projeto.banca_set.all %}
      {% if banca.tipo_de_banca == 2 %}    
          <a style="margin-right: 1em;" href="{% url 'banca_ver' banca.id %}">
            Banca Falconi ({{banca.startDate|date:"d/m/y"}})
          </a>
      {% endif %}
    {% endfor %}
    </h5>
    <table>    
      {% for avaliador, objs in avaliadores_falconi.items %}
          <tr><td>
            <strong>Avaliador{% if avaliador.genero == "F" %}a{% endif %}: </strong>
            <a href="{% url 'parceiro_detail' avaliador.parceiro.id %}">
              {{avaliador.get_full_name}}
            </a><br>
            <strong>Avaliado em: </strong>{{objs.momento}}<br>
            <strong>Conceitos:</strong><br>
            <ul style="list-style-type: '&#x21A3; ';">
              {% for objetivo, conceito in objs.items %}{% if objetivo != "momento" and objetivo|slice:11 != "observacoes" %}
                <li><span style="font-weight: 500;">{{objetivo.titulo}}</span>: <span data-toggle="tooltip" data-html="true" animation="true" title="
                {{objetivos|get_rubrica:objetivo.id|get_texto_final_nota:conceito.nota}}">
                <span id="falconi{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}"></span></span></li>
                <script>
                  $("#falconi{{projeto.id}}_{{avaliador.id}}_{{objetivo.id}}").html(
                    {% if conceito.nota %}converteN({{conceito.nota}}){% else %}"N/A"{% endif %}
                  );
                  objetivo_tmp = new Objetivo();
                  objetivo_tmp.titulo = "{{objetivo.titulo}}"
                  falconi.add_objetivo(objetivo_tmp)
                  {% if conceito.nota %}
                    falconi.dict[objetivo_tmp.titulo].soma_nota({{conceito.nota}});
                  {% endif %}
                </script>

              {% endif %}{% endfor %}
              
              {% if objs.observacoes_orientador %}  
                <li><span style="font-weight: 500;">Observações para o Orientador</span>: {{objs.observacoes_orientador}}</li>
              {% endif %}

            </ul>

          </td></tr>

      {% endfor %}

      <tr style="background-color: var(--color_banca_falconi); color: darkslategrey"><td>
        <b>Média das avaliações falconi:<ul id="med_falconi" style="list-style-type: '&#x21A3; ';"></ul></b>
        <span id="med_falconi_calc"></span>
        <script>
          for (var key in falconi.dict) {
            if(falconi.dict[key].avaliacoes>0) $('#med_falconi').append(falconi.dict[key].texto());
          }
          $("#med_falconi_calc").html(falconi.media_calculada());
        </script>

      </td></tr>

    </table>
  {% endif %}

{% endblock %}