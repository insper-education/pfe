{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 14 de Janeiro de 2024
{% endcomment %}

{% block head %}
  {% load static %}
  {% load date_extras %}
  {% comment %} Para chamar os Tooltips {% endcomment %}
  <script>{% include "tooltip.js" %}</script>
  
  {% comment %} Para recarregar a página em caso de um botão back ou similar {% endcomment %}
  {% include "reload.html" %}

  <link rel="stylesheet" href="{% static 'css/div_arrend.css' %}">
  <link rel="stylesheet" href="{% static 'css/outros.css' %}">
  <link rel="stylesheet" href="{% static 'css/short_full.css' %}">

  <style>
    ul {margin-bottom: 6px;}
  </style>
{% endblock %}

{% block content %}

  <span class="titulo">Avaliar Entregas</span>

  {% comment %} Seletor da edição da pesquisa {% endcomment %}
  {% include "edicoes.html" %}
  <br>

  <div class="atualizar">

      {% for projeto, entregas in avaliacoes %}
        {% if projeto.tem_relatos %}
          <div class="div_arredondado">
          
            <div class="tresp"><strong>Projeto:</strong> <a href="{% url 'projeto_completo' projeto.id %}">{{projeto.get_titulo}}</a>
            {% include "tipo_projeto.html" with com_tipo=False %}</div>
            <strong>Organização:</strong>
            {% if projeto.organizacao %}
              <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">{{ projeto.organizacao.nome }}</a>
            {% else %}
              ORGANIZAÇAO NÃO DEFINIDA
            {% endif %}
            <br>
            {% if edicao == "todas" %}
              <strong>Semestre:</strong> {{projeto.ano}}.{{projeto.semestre}}<br>
            {% endif %}
            <strong>Orientador:</strong>
            {% if projeto.orientador %}
              <a href="{% url 'professor_detail' projeto.orientador.id %}">{{projeto.orientador}}</a>
            {% else %}
              ORIENTADOR NÃO DEFINIDO
            {% endif %}
          
            <div style="margin:8px 0px 3px 0px; "><strong>Entregas:</strong></div>

            {% for item in entregas %}
            {% with dias_ate=item.evento.endDate|dif_dias_hoje dias=14 %} {% comment %} Eventos são mostrados duas semanas antes do prazo {% endcomment %}
              <div style="border: 1px solid grey; margin: {% if forloop.first %}0{% else %}10{% endif %}px 0px 4px 0px; padding: 0.2em; display:block;"> {% comment %} {% if dias_ate > dias %}{% endif %} {% endcomment %}
                <span {% if dias_ate > dias %}style="color:lightgrey;"{% endif %}>
                  <b>{{item.composicao.exame.titulo}}</b>
                  <span class="opt_full">[prazo {{ item.evento.endDate|date:"DATE_FORMAT" }}]:</span>
                  <span class="opt_short">[prazo {{ item.evento.endDate|date:"d/m/y" }}]:</span></b>
                </span>
                  {% comment %} {% if dias_ate > dias %}lightgrey{% endif %}" {% endcomment %}
                  {% comment %} <a id="adiciona" class="open-documento data-toggle="tooltip" data-html="true" animation="true"   item.documentos.last {% endcomment %}
                  {% comment %} onClick="check_prazo('{{item.evento.endDate|date:"Y-m-d"}}T23:59:59');" {% endcomment %}
                <br>
                <ul style="padding-left: 22px; width: fit-content;">
                {% for documento in item.documentos %}
                  <li style="list-style-type:'&#128463; ';">
                    {% if forloop.first%}<b>{% endif %}
                    {% if documento.documento or documento.link %}
                      <a 
                          {% if documento.usuario %} data-toggle="tooltip" data-html="true" animation="true" title="Entregue por {{documento.usuario.get_full_name}}"{% endif %}
                          class="{% if dias_ate > dias %}lightgrey{% endif %}"
                          {% if documento.usuario and not item.composicao.exame.grupo %}
                            href="{% url 'entrega_avaliar' item.composicao.id projeto.id documento.usuario.id %}"
                          {% else %}
                            href="{% url 'entrega_avaliar' item.composicao.id projeto.id %}"
                          {% endif %}
                          target="_blank" rel="noopener noreferrer">Entregue {{documento.data}}</a>
                    {% endif %}
                    {% if not item.composicao.exame.grupo %}
                      {% if documento.usuario %}
                        ({{documento.usuario.get_full_name}})
                      {% else %}
                        (ERRO AO IDENTIFICAR ESTUDANTE)
                      {% endif %}
                    {% endif %}
                    {% if documento.data|diff_days:item.evento.endDate > 0 %}<span style="color: red;">[ENTREGUE APÓS PRAZO]</span>{% endif %}
                    {% if forloop.first%}</b>{% endif %}  
                  </li>
                {% empty %}
                  Arquivos ausentes<br>
                {% endfor %}
                </ul>

                {% if item.avaliacoes %}
                <div style="display: table;">
                  <table style="border: 0px; border-collapse: separate; border-spacing: 10px; width: 100%;">
                    <tr>
                      <td style="padding: 0.4em; background-color: lightgrey; border: 0px; vertical-align: top;">
                        {% if item.avaliacoes.last.objetivo %}
                          <b>Avaliação:</b><br>
                          <ul>
                          {% for avaliacao in item.avaliacoes %}
                            <li style="margin-left: -1.9em; white-space: nowrap; list-style-type: '&#8227; ';">
                              {% if avaliacao.objetivo %}
                                {{avaliacao.objetivo.titulo}}:
                                {% comment %} {{avaliacao.objetivo.sigla}}: {% endcomment %}
                              {% else %}
                                Objetivo não definido 
                              {% endif %}
                              {{avaliacao.get_conceito}}
                            </li>
                          {% endfor %}
                          </ul>
                          <b>Nota = {{item.nota|floatformat:2}}  </b>
                        {% else %}
                          <b>Decisão:</b><br>
                          &#8227;
                          {% if avaliacao.nota > 5 %}
                            Adequado
                          {% else %}
                            Inadequado
                          {% endif %}
                        {% endif %}
                      </td>

                      {% if item.observacao.observacoes_estudantes or item.observacao.observacoes_orientador%}
                        <td style="padding: 0.4em; background-color: lightgrey; border: 0px; vertical-align: top;">
                          {% if item.observacao.observacoes_estudantes %}
                            <b>Observações para Estudantes:</b><br>
                            {{item.observacao.observacoes_estudantes}}<br>
                            {% if item.observacao.observacoes_orientador %} 
                              <br>
                            {% endif %}
                          {% endif %}
                          {% if item.observacao.observacoes_orientador %} 
                            <b>Observações do Orientador:</b><br>
                            {{item.observacao.observacoes_orientador}}
                          {% endif %}
                        </td>
                      {% endif %}

                    </tr>
                  </table>
                </div>
                {% endif %}

              </div>
            {% endwith %}
          {% endfor %} 

          </div>
        {% endif %}
      {% empty %}
       Sem alocações de projetos esse semestre.
      {% endfor %}

  </div> 

  <script>
    function carrega_pagina() {};
    function carrega_site() {
      var filterEdicao = localStorage.getItem("filterEdicao");
      if (filterEdicao !== null && $("#filterEdicao option[value='"+filterEdicao+"']").length > 0 ) {
        $('#filterEdicao').val(filterEdicao).trigger('change');
      }
      carrega_pagina();
    };
    window.onload = carrega_site
  </script>

  {% include "edicoes_ajax.html" %}

{% endblock %}