{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 17 de Julho de 2020
{% endcomment %}

{% block head %}
  
  {% load static %}
  
  <script src="{% static 'js/w3.js' %}"></script>

  <script> {% include "tooltip.js" %} </script>

  <style>
    .arrow {
      border: solid black;
      border-width: 0px 2px 2px 0px;
      display: inline-block;
      padding: 2px;
      vertical-align: middle;
    }

    .right {
      transform: rotate(-45deg);
      -webkit-transform: rotate(-45deg);
    }

    #toggle {
      display:inline-block; 
    }

  </style>

{% endblock %}

{% block content %}

  {% include "impressora.html" %}

  <span class="titulo">Resultado dos Projetos</span>

  {% comment %} Seletor da edição da pesquisa {% endcomment %}
  {% include "edicoes.html" %}

  <script>
    $(document).on('click','#informacoes_tag',function(){
      if($("#toggle").is(':visible')) $("#informacoes").css("display", "inline");
      else $("#informacoes").css("display", "block");
      $("#toggle").toggle( "slide" );
    });
  </script>
  
  <div id="informacoes" style="font-size:0.8rem; display: inline; border: 1px solid lightgray; padding: 1px;">
    <span id="informacoes_tag" style="cursor: pointer; color:gray;"><b>Informações <i class="arrow right"></i>&nbsp;</b></span>
    <div id="toggle" style="padding-top: 10px;display: none;"> 
    <label><input id="periodo" onchange="($(this).prop('checked') ? $('#ProjetosTable tr > *:nth-child(2)').show() : $('#ProjetosTable tr > *:nth-child(2)').hide())" type="checkbox" checked /> Período</label>&nbsp;&nbsp;&nbsp;
      <label><input id="organizacao" onchange="($(this).prop('checked') ? $('#ProjetosTable tr > *:nth-child(3)').show() : $('#ProjetosTable tr > *:nth-child(3)').hide())" type="checkbox" checked /> Organização</label>&nbsp;&nbsp;&nbsp;
      <label><input id="orientador" onchange="($(this).prop('checked') ? $('#ProjetosTable tr > *:nth-child(4)').show() : $('#ProjetosTable tr > *:nth-child(4)').hide())" type="checkbox" checked /> Orientador</label>&nbsp;&nbsp;&nbsp;
      <label><input id="grupo" onchange="($(this).prop('checked') ? $('.grupo').show() : $('.grupo').hide())" type="checkbox" checked /> Grupo</label>&nbsp;&nbsp;&nbsp;
      <label class="grupo"><input id="email" onchange="($(this).prop('checked') ? $('.email').show() : $('.email').hide())" type="checkbox" checked /> e-mail</label>&nbsp;&nbsp;&nbsp;
      <label class="grupo"><input id="curso" onchange="($(this).prop('checked') ? $('.curso').show() : $('.curso').hide())" type="checkbox" checked /> curso</label>&nbsp;&nbsp;&nbsp;
    </div>
  </div>{% comment %} Mais elementos no carrega_pagina() {% endcomment %}

  <table  id="ProjetosTable" class="projetos">

    {% if tabela %}
      <tr>
        <th style="border-right:0px; border-left:0px;"></th>
        <th style="border-right:0px; border-left:0px;"></th>
        <th style="border-right:0px; border-left:0px;"></th>
        <th style="border-right:0px; border-left:0px;"></th>
        <th colspan="2" class="text-center">
          <b>Relatórios</b>
        </th>
        <th colspan="3" class="text-center">
          <b>Bancas</b>
        </th>
      </tr>
      <tr>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(1)')" style="cursor:pointer" class="text-center">Projeto</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(2)')" style="cursor:pointer" class="text-center">Período</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(3)')" style="cursor:pointer" class="text-center">Organização</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(4)')" style="cursor:pointer" class="text-center">Orientador</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(5)')" style="cursor:pointer" class="text-center" data-toggle="tooltip" data-html="true" animation="true" title="Relatório Intermediária">Inte.</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(6)')" style="cursor:pointer" class="text-center" data-toggle="tooltip" data-html="true" animation="true" title="Relatório Final">Final</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(7)')" style="cursor:pointer" class="text-center" data-toggle="tooltip" data-html="true" animation="true" title="Banca Intermediária">Inte.</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(8)')" style="cursor:pointer" class="text-center" data-toggle="tooltip" data-html="true" animation="true" title="Banca Final">Final</th>
        <th onclick="w3.sortHTML('#ProjetosTable', '.item', 'td:nth-child(9)')" style="cursor:pointer" class="text-center" data-toggle="tooltip" data-html="true" animation="true" title="Banca Falconi">Falc.</th>
      </tr>      

      {% for projeto, relatorio_intermediario, relatorio_final, banca_intermediaria, banca_final, banca_falconi in tabela %} 
      <tr class="item"
        {% if banca_falconi.2 >= 8 %}
          {% if banca_intermediaria.2 >= 7 and banca_final.2 >= 7 and relatorio_final.2 >= 7 and relatorio_intermediario.2 >= 7 %}
            style="background-color:lightgreen"
          {% else %}
            style="background-color:#DAF7A6"
          {% endif %}
        {% elif banca_falconi.2 >= 6 %}
          {% if banca_intermediaria.2 >= 7 and banca_final.2 >= 7 and relatorio_final.2 >= 7 and relatorio_intermediario.2 >= 7 %}
            style="background-color:lemonchiffon"
          {% else %}
            style="background-color:#ffffed"
          {% endif %}
        {% endif %}
      >
          <td>
            <a class="imprimir" href="{% url 'projeto_completo' projeto.id %}">
              {{projeto.get_titulo}}
              {% include "tipo_projeto.html" %}<br>
            </a>

            <ul class="grupo" style="margin-bottom: 6px;">
              {% for alocacao in projeto.alocacao_set.all %}
                <li>
                  <a class="imprimir" href="{% url 'estudante_detail' alocacao.aluno.id %}">
                    {{alocacao.aluno}}
                  </a>
                  <span class="email">
                    <a href="mailto:{{alocacao.aluno.user.email}}">&lt;{{alocacao.aluno.user.email}}&gt;</a>
                  </span>
                  <span class="curso">
                    [{{ alocacao.aluno.curso2 }}]
                  </span>
                </li>
              {% endfor %}
            </ul>
          </td>
          <td>
            {{projeto.ano}}.{{projeto.semestre}}
          </td>
          <td>
            <a class="imprimir" href="{% url 'organizacao_completo' projeto.organizacao.id %}">
              {{ projeto.organizacao.nome }}
            </a>
          </td>
          
          {% comment %} Orientador {% endcomment %}
          <td>
            {% if projeto.orientador %}
            <a class="imprimir" href="{% url 'professor_detail' projeto.orientador.id %}">
              {{ projeto.orientador }}
            </a>
            {% else %}
              Orientador não definido
            {% endif %}

            {% with coorientadores=projeto.coorientador_set.all %}
              {% if coorientadores %}
              <span class="coorientadores">
              <br>coorientador:
                {% for coorientador in coorientadores %}
                    <a class="imprimir" href="{% url 'user_detail' coorientador.usuario.id %}">
                      {{coorientador.usuario.get_full_name}} 
                    </a>
                    {% comment %} <a class="email" href="mailto:{{coorientador.usuario.email}}">&lt;{{coorientador.usuario.email}}&gt;</a> {% endcomment %}
                    {% if not forloop.last %}
                      ;
                    {% endif %}
                {% endfor %}
                </span>
              {% endif %}
            {% endwith %}

          </td>

          {% comment %} Relatório Intermediário {% endcomment %}
          <td class="text-center" style="white-space: nowrap;">
            <a class="imprimir" href="{% url 'projeto_completo' projeto.id %}"
              {% if relatorio_intermediario.1 %}
                data-toggle="tooltip" data-html="true" animation="true" title="{{ relatorio_intermediario.0|safe }}">
              {{ relatorio_intermediario.1|safe }}
              {% else %}
              >
              {% endif %}
            </a>
          </td>

        {% comment %} Relatório Final {% endcomment %}
          <td class="text-center" style="white-space: nowrap;">
            <a class="imprimir" href="{% url 'projeto_completo' projeto.id %}"
              {% if relatorio_final.1 %}
                data-toggle="tooltip" data-html="true" animation="true" title="{{ relatorio_final.0|safe }}">
              {{ relatorio_final.1|safe }}
              {% else %}
              >
              {% endif %}
            </a>
          </td>

        {% comment %} Banca Intermediária {% endcomment %}
          <td class="text-center" style="white-space: nowrap;">
            <a class="imprimir" href="{% url 'conceitos_obtidos' projeto.id %}"
              {% if banca_intermediaria.1 %}
                data-toggle="tooltip" data-html="true" animation="true" title="{{ banca_intermediaria.0|safe }}">
                {{ banca_intermediaria.1|safe }}
              {% else %}
              >
              {% endif %}
            </a>
          </td>

          {% comment %} Banca Final {% endcomment %}
          <td class="text-center" style="white-space: nowrap;">
            <a class="imprimir" href="{% url 'conceitos_obtidos' projeto.id %}"
              {% if banca_final.1 %}
                data-toggle="tooltip" data-html="true" animation="true" title="{{ banca_final.0|safe }}">
                {{ banca_final.1|safe }}
              {% else %}
              >
              {% endif %}
            </a>
          </td>

          {% comment %} Banca Falconi {% endcomment %}
          <td class="text-center" style="white-space: nowrap;">
            <a class="imprimir" href="{% url 'conceitos_obtidos' projeto.id %}"
              {% if banca_falconi.1 %}
                data-toggle="tooltip" data-html="true" animation="true" title="{{ banca_falconi.0|safe }}">
                {{ banca_falconi.1|safe }}
              {% else %}
              >
              {% endif %}
            </a>
          </td>

      </tr>

      {% empty %}
        <tr><td colspan="6">
        Não existem projetos disponíveis.
        </td></tr>
      {% endfor %}
    
    {% endif %}

  </table>

  <br>
  &nbsp;<span style="background-color:lightgreen">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    Certificação Excelência Projeto Final de Engenharia FALCONI-INSPER<br>

  &nbsp;<span style="background-color:lemonchiffon">&nbsp;&nbsp;&nbsp;&nbsp;</span>
    Certificação Destaque Projeto Final de Engenharia FALCONI-INSPER<br>

  <p>&nbsp;</p>


  <script>
  
    var request_ajax_r = null;
    var xhrCount = 0;  // Para contar as chamadas e usar somente a última

    function carrega_semestre(){

      var seqNumber = ++xhrCount;

      {% comment %} if (request_ajax_r != null){ 
          request_ajax_r.abort();
          request_ajax_r = null;
      } {% endcomment %}

      $("#spinner").css("visibility", "visible");
      var edicao = $(".filter option:selected").attr("value");
      request_ajax_r = $.ajax({
          type: "POST",
          data: {
              edicao: edicao,
              'csrfmiddlewaretoken': '{{ csrf_token }}',
          },
          success: function(response){
            if (seqNumber === xhrCount) { {% comment %} Processando resposta {% endcomment %}
              $("table.projetos").replaceWith($("table.projetos",response));
              //$("#organizacao").prop('checked') ? $('#ProjetosTable tr > *:nth-child(2)').show() : $('#ProjetosTable tr > *:nth-child(2)').hide()
              //$("#orientador").prop('checked') ? $('#ProjetosTable tr > *:nth-child(3)').show() : $('#ProjetosTable tr > *:nth-child(3)').hide()
              {% include "tooltip.js" %}
              $("#spinner").css("visibility", "hidden");
            } // else {% comment %} Ignorando resposta {% endcomment %}
          },
          error: function (request, status, error) {
            {% if user.tipo_de_usuario == 4 %} 
              alert(request.responseText);
              jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
              console.log('error'+request.responseText);
            {% else %}
              jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
            {% endif %}
          }
      });
    }

    $(".filter").change(carrega_semestre);    
    $(document).ready(carrega_semestre);

    function carrega_pagina() {
      ($("#periodo").prop('checked') ? $('#ProjetosTable tr > *:nth-child(2)').show() : $('#ProjetosTable tr > *:nth-child(2)').hide());
      ($("#organizacao").prop('checked') ? $('#ProjetosTable tr > *:nth-child(3)').show() : $('#ProjetosTable tr > *:nth-child(3)').hide());
      ($("#orientador").prop('checked') ? $('#ProjetosTable tr > *:nth-child(4)').show() : $('#ProjetosTable tr > *:nth-child(4)').hide());
      ($("#grupo").prop('checked') ? $('.grupo').show() : $('.grupo').hide());
      ($("#email").prop('checked') ? $('.email').show() : $('.email').hide());
      ($("#curso").prop('checked') ? $('.curso').show() : $('.curso').hide());
    };

    function carrega_site() {
      var filterEdicao = localStorage.getItem("filterEdicao");
      if (filterEdicao !== null && $("#filterEdicao option[value='"+filterEdicao+"']").length > 0 ) {
        $('#filterEdicao').val(filterEdicao).trigger('change');
      }
      carrega_pagina();
    };

    window.onload = carrega_site;

  </script>

  <script>
    $('#ProjetosTable tr > *:nth-child(3)').hide();
  </script>

{% endblock %}
