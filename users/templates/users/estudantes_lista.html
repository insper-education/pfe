{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 23 de Maio de 2019
{% endcomment %}

{% block head %}

  {% load static %}
  {% load dictionary %}

  <script src="{% static 'js/Chart.min.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>

  {% include "tabelas_includes.html" %}

  {% comment %} Para recarregar a página em caso de um botão back ou similar {% endcomment %}
  {% include "reload.html" %}

{% endblock %}

{% block content %}
  
  <span class="titulo">{{titulo}}
    <small><a href="{% url 'cadastrar_usuario' %}?tipo=estudante">&#10133;</a></small>
  </span>

  {% comment %} Seletor da edição da pesquisa {% endcomment %}
  {% include "edicoes.html" with com_cursos=True %}

  <script>
    $('#filterEdicao').append($('<option>', {
        value: "trancou",
        text: 'trancou'
    }));
  </script>
  
  <div class="atualizar">

    {% include "tabelas_top.html" with tabela="Estudantes" cabecalhos=cabecalhos %}
        {% for aluno in alunos_list %} 
        <tr class="item">
          <th scope="row" data-order="{{aluno.user.get_full_name}}">
            <a href="{% url 'estudante_detail' aluno.id %}">
              {{aluno.user.get_full_name}} {% if aluno.externo %}<span style="color:red">[{{aluno.externo}}]</span>{% endif %}
            </a>
          </th>
          <td style="text-align: right;">
            {% if aluno.matricula %}
              {{aluno.matricula}}
            {% else %}
              N/I
            {% endif %}
          </td>
          <td>
            <a href="mailto:{{aluno.user.email}}"> &lt;{{aluno.user.email}}&gt;</a>
          </td>
          {% if aluno.curso %}
            <td style="color:#{{ aluno.curso2.cor }};">
              {{ aluno.get_curso_display }}
            </td>
          {% else %}
            <td>Indefinido</td>
          {% endif %}
          <td>
            {% if aluno.alocacao_set.all %}
              {% for alocacao in aluno.alocacao_set.all %}
                {% if ano == 0 or alocacao.projeto.ano == ano and alocacao.projeto.semestre == semestre %}
                  <a href="{% url 'projeto_completo' alocacao.projeto.id %}">
                    {% if alocacao.projeto.avancado %}<u>{% endif %}
                    {{alocacao.projeto.ano}}.{{alocacao.projeto.semestre}}
                    {% if alocacao.projeto.avancado %}</u>{% endif %}
                    <br>
                  </a>
                {% endif %}
              {% endfor %}
            {% else %}
              {% if aluno.anoPFE and aluno.semestrePFE %}
                {{aluno.anoPFE}}.{{aluno.semestrePFE}}
              {% else %}
                Indefinido
              {% endif %}
            {% endif %}
          </td>
          <td class="{% if configuracao.ano == aluno.anoPFE and configuracao.semestre == aluno.semestrePFE %}text-success{% endif %}">
            {% if aluno.alocacao_set.all %}
              {% for alocacao in aluno.alocacao_set.all %}
                {% if ano == 0 or alocacao.projeto.ano == ano and alocacao.projeto.semestre == semestre %}
                  <a href="{% url 'projeto_completo' alocacao.projeto.id %}">
                    {{alocacao.projeto.get_titulo}}
                  </a>
                  {% if alocacao.projeto.avancado %}
                    <span style="color:red">[PFE Avançado]</span>
                  {% endif %}
                  {% if alocacao.projeto.proposta.internacional %}
                    <span style="color:red">[Internacional]</span>
                  {% endif %}
                  {% if alocacao.projeto.proposta.intercambio %}
                    <span style="color:red">[Intercâmbio]</span>
                  {% endif %}
                  {% if alocacao.projeto.time_misto %}
                    <span style="color:red">[Time Misto]</span>
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          </td>
          <td class="{% if configuracao.ano == aluno.anoPFE and configuracao.semestre == aluno.semestrePFE %}text-success{% endif %}">
            {% if aluno.alocacao_set.all %}
              {% for alocacao in aluno.alocacao_set.all %}
                {% if ano == 0 or alocacao.projeto.ano == ano and alocacao.projeto.semestre == semestre %}
                  {% if alocacao.projeto and alocacao.projeto.organizacao %}
                    <a href="{% url 'organizacao_completo' alocacao.projeto.organizacao.id %}">
                      {{alocacao.projeto.organizacao}}
                    </a>
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          </td>
          <td>
          {% if aluno.user.linkedin %}
            <a href="{{ aluno.user.linkedin }}">{{ aluno.user.linkedin }}</a>
          {% endif %}
          </td>
        </tr>
        {% endfor %}
        <caption style="text-align:right"><small>Projetos <u>sublinhados</u> são de PFE Avançado</small></caption>
      </table>
    </div>
    <br>

    <strong>Número Total de Estudantes:</strong> {{ num_alunos }}
    <br>

    <div id="canvas-holder">
      <canvas id="chart-programas"></canvas>
      <br><br>
      <canvas id="chart-generos"></canvas>
    </div>

    <br><br>

    <h5>Quantidade de estudantes alocados em projetos</h5>
    <table id="AlunosTable">
      <tr>
          <th class="text-center" style="border-right: solid 3px;">Periodo</th>
          <th class="text-center">Computação</th>
          <th class="text-center">Mecânica</th>
          <th class="text-center">Mecatrônica</th>
          <th class="text-center" style="border-left: solid 3px;">TOTAL</th>
      </tr>
      {% for ano,tabela_ano in tabela_alunos.items %}
        {% for semestre,tabela_semetre in tabela_ano.items %}
          <tr>
              <td class="text-center" style="border-right: solid 3px;"> {{ano}}.{{semestre}} </td>
              <td class="text-center"> {{tabela_semetre.computação}} </td>
              <td class="text-center"> {{tabela_semetre.mecânica}} </td>
              <td class="text-center"> {{tabela_semetre.mecatrônica}} </td>
              <td class="text-center" style="border-left: solid 3px;"><b> {{tabela_semetre.total}} </b></td>
          </tr>
        {% endfor %}
      {% endfor %}
      {% if ano == 0 or semestre == 0 %}
        <tr>
          <td class="text-center" style="border-right: solid 3px; border-top: double;"> Totais </td>
          <td class="text-center" style="border-top: double;"> {{totais.computação}} </td>
          <td class="text-center" style="border-top: double;"> {{totais.mecânica}} </td>
          <td class="text-center" style="border-top: double;"> {{totais.mecatrônica}} </td>
          <td class="text-center" style="border-left: solid 3px; border-top: double;"><b> {{totais.total}} </b></td>
        </tr>
      {% endif %}
    </table>
    {% if ano == 0 or semestre == 0 %}
      <small>estudantes reprovados e do PFE avançado contam mais de uma vez</small>
    {% endif %}
    <br>

    {% if ano == 0 or semestre == 0 %}
      <div id="canvas-holder">
        <canvas id="total-estudantes"></canvas>
      </div>
    {% endif %}


    <script>
      var config_programas = {
        type: 'pie',
        data: {
          datasets: [{
            data: [
              {{ num_alunos_comp }},
              {{ num_alunos_mec }},
              {{ num_alunos_mxt }},
            ],
            backgroundColor: [
              'rgb(75, 192, 192)',
              'rgb(255, 99, 132)',
              'rgb(255, 205, 86)',
            ],
            label: 'Proporção de cursos entre estudantes'
          }],
          labels: [
            'Computação [{% widthratio num_alunos_comp num_alunos 100 %}%]',
            'Mecânica [{% widthratio num_alunos_mec num_alunos 100 %}%]',
            'Mecatrônica [{% widthratio num_alunos_mxt num_alunos 100 %}%]',
          ]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Proporção de cursos entre estudantes',
            position: 'top'
          },
          legend: {
            display: true,
            position: "bottom",
          }
        }
      };


      var config_generos = {
        type: 'pie',
        data: {
          datasets: [{
            data: [
              {{ num_alunos_masculino }},
              {{ num_alunos_feminino }},
            ],
            backgroundColor: [
              'rgb(93, 173, 226)',
              'rgb(175, 122, 197)',
            ],
            label: 'Proporção de cursos entre estudantes'
          }],
          labels: [
            'Masculino [{% widthratio num_alunos_masculino num_alunos 100 %}%]',
            'Feminino [{% widthratio num_alunos_feminino num_alunos 100 %}%]',
          ]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Proporção de gêneros entre estudantes',
            position: 'top'
          },
          legend: {
            display: true,
            position: "bottom",
          }
        }
      };

           
      var labels = []
      var est_computacao = []
      var est_mecatronica = []
      var est_mecanica = []

      {% for ano,tabela_ano in tabela_alunos.items %}
        {% for semestre,tabela_semetre in tabela_ano.items %}
          labels.push("{{ano}}.{{semestre}}");
          est_computacao.push({{tabela_semetre.computação}});
          est_mecatronica.push({{tabela_semetre.mecatrônica}});
          est_mecanica.push({{tabela_semetre.mecânica}});
        {% endfor %}
      {% endfor %}
    
      var config_totais = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              data: est_computacao,
              backgroundColor: 'rgb(75, 192, 192)',
              label: 'Computação'
            },
            {
              data: est_mecatronica,
              backgroundColor: 'rgb(255, 205, 86)',
              label: 'Mecatrônica'
            },
            {
              data: est_mecanica,
              backgroundColor: 'rgb(255, 99, 132)',
              label: 'Mecânica'
            },
          ],
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Estudantes por curso por semestre',
            position: 'top'
          },
          legend: {
            display: true,
            position: "bottom",
          },
          tooltips: {
						mode: 'index',
						intersect: false
					},
					responsive: true,
					scales: {
						xAxes: [{
							stacked: true,
						}],
						yAxes: [{
							stacked: true
						}]
					}
        }
      };

      // Chart da proporção de estudantes por programas
      var chart_programas = document.getElementById('chart-programas').getContext('2d');
      window.myPie = new Chart(chart_programas, config_programas);

      // Chart da proporção de estudantes por gênero
      var chart_generos = document.getElementById('chart-generos').getContext('2d');
      window.myPie = new Chart(chart_generos, config_generos);

      {% if ano == 0 or semestre == 0 %}
        // Chart da proporção de estudantes por gênero
        var chart_totais = document.getElementById('total-estudantes').getContext('2d');
        window.myPie = new Chart(chart_totais, config_totais);
      {% endif %}

      var table = null;

      function carrega_pagina() {
        table = $('#EstudantesTable').dataTable();

        if(table) {
          // Hide/Esconde certas colunas
          //table.fnSetColumnVis( 0, true );  // esconde Nome
          table.fnSetColumnVis( 1, false );  // esconde Matrícula
          //table.fnSetColumnVis( 2, true );  // esconde e-mail
          //table.fnSetColumnVis( 3, true );  // esconde Curso
          //table.fnSetColumnVis( 4, true );  // esconde Período
          //table.fnSetColumnVis( 5, true );  // esconde Projeto
          //table.fnSetColumnVis( 6, true );  // esconde Organização
          table.fnSetColumnVis( 7, false );  // esconde Linkedin
        }
      };

      function carrega_site(){
        carrega_pagina();
      };
      window.onload = carrega_site
    </script>

  </div>

  {% include "edicoes_ajax.html" with tabela='Estudantes' com_cursos=True %}
  
{% endblock %}