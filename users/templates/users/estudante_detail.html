{% extends "base.html" %}
{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 23 de Maio de 2019
{% endcomment %}

{% load static %}
{% load l10n %}
{% load aderencia_aluno %}
{% load dictionary %}
{% load zip_data %}
{% load relatos %}
{% load bancas %}
{% load documentos %}
{% load get_notas %}
{% load get_descontos %}
{% load linguas %}
{% load reunioes %}
{% load propostas %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/usuarios.css' %}">
  <link rel="stylesheet" href="{% static 'css/tab_arrend.css' %}"> {% comment %} SETAS {% endcomment %}
  <script src="{% static 'js/Chart.min.js' %}"></script>
  {% include "reload.html" %}

  <style>
    .tit_rel {
      font-weight: bold;
      font-size: 20px;
    }
    @media (max-width: 740px) {
      .tit_rel {font-size: 17px;}
    } 

    .reunioes-list {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 0.15rem;
      max-width: 100%;
      width: 750px;
      margin-left: 0.5em;
    }
    .reuniao-linha {
      display: flex;
      align-items: center;
      gap: 0.15rem;
      padding: 0.05rem 0.1rem;
      border-bottom: 1px solid #e9ecef;
      font-size: 0.9rem;
      transition: background 0.15s;
    }
    .reuniao-linha:last-child {border-bottom: none;}
    .reuniao-linha:hover {background: #fff;}

    .mostra-data-hora {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #6c757d;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .mostra-data {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
      width: 86px;
    }
    .mostra-hora {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
      width: 70px;
    }

    .reuniao-titulo-compacto {
      flex: 1;
      color: #2c3e50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge-mini {
      padding: 0.25em 0.5em;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 4px;
      white-space: nowrap;
    }

/* Estilos para Bancas */
    .bancas-list {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 0.15rem;
      max-width: 100%;
      width: 750px;
      margin-left: 0.5em;
    }
    .banca-linha {
      display: flex;
      align-items: center;
      gap: 0.15rem;
      padding: 0.05rem 0.1rem;
      border-bottom: 1px solid #e9ecef;
      font-size: 0.9rem;
      transition: background 0.15s;
    }
    .banca-linha:last-child {border-bottom: none;}
    .banca-linha:hover {background: #fff;}
    .banca-linha a {
      display: flex;
      align-items: center;
      gap: 0.15rem;
      flex: 1;
      text-decoration: none;
      color: inherit;
    }
    .banca-linha a:hover {
      text-decoration: none;
    }
    
    .banca-icone {
      font-size: 1rem;
      width: 20px;
      text-align: center;
      color: #6c757d;
      flex-shrink: 0;
    }

    .banca-tipo {
      flex: 1;
      color: #2c3e50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 740px) {
      .mostra-data-hora {min-width: 140px; font-size: 0.8rem; gap: 0.3rem;}
      .reuniao-linha {gap: 0.3rem; padding: 0.3rem 0.4rem; font-size: 0.85rem;}
      .banca-linha {gap: 0.3rem; padding: 0.3rem 0.4rem; font-size: 0.85rem;}
    }

    /* Relatos Quinzenais (compacto) */
    .relatos-list {
      background:#f8f9fa;
      border-radius:6px;
      padding:0.15rem;
      max-width:100%;
      width:750px;
      margin-left:0.5em;
    }
    .relato-linha {
      display:flex;
      align-items:center;
      gap:0.4rem;
      padding:0.13rem 0.14rem;
      border-bottom:1px solid #e9ecef;
      font-size:0.85rem;
      transition:background .15s;
    }
    .relato-linha:last-child {border-bottom:none;}
    .relato-linha:hover {background:#fff;}
    .relato-ordem {
      width:26px;
      font-weight:600;
      flex-shrink:0;
      text-align:right;
      color:#495057;
    }
    .relato-data {
      display:flex;
      align-items:center;
      gap:0.25rem;
      color:#6c757d;
      white-space:nowrap;
      width:92px;
      flex-shrink:0;
      font-size:0.75rem;
    }
    .relato-status {
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#2c3e50;
    }
    .relato-badge {
      padding:0.25em 0.45em;
      font-size:0.65rem;
      font-weight:600;
      border-radius:4px;
      flex-shrink:0;
      white-space:nowrap;
    }
    .relato-icone {width:18px; text-align:center; flex-shrink:0; font-size:0.9rem;}
    @media (max-width:740px){
      .relato-linha{gap:0.3rem; padding:0.25rem 0.3rem;}
      .relato-data{width:78px; font-size:0.7rem;}
      .relato-ordem{width:32px;}
    }

        .propostas-list {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 0.15rem;
      max-width: 100%;
      width: 750px;
      margin-left: 0.5em;
    }
    .proposta-linha {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.4rem;
      border-bottom: 1px solid #e9ecef;
      font-size: 0.85rem;
      transition: background 0.15s;
    }
    .proposta-linha:last-child {border-bottom: none;}
    .proposta-linha:hover {background: #fff;}
    .proposta-linha a {
  display:grid;
  grid-template-columns: 26px 140px 1fr 60px 52px;
  gap:0.4rem;
  width:100%;
  min-width:0;
}
@media (max-width:740px){
  .proposta-linha a {grid-template-columns:26px 95px 1fr 54px 46px;}
}
.proposta-org, .proposta-titulo {
  min-width:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
    .proposta-linha a:hover {text-decoration: none;}
    
    .proposta-prioridade {
      width: 26px;
      font-weight: 700;
      flex-shrink: 0;
      text-align: center;
      color: #495057;
      background: #e9ecef;
      border-radius: 4px;
      padding: 0.2em 0.3em;
      font-size: 0.8rem;
    }

    .proposta-periodo {
      color: #6c757d;
      font-size: 0.75rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .proposta-aderencia {
      padding: 0.25em 0.45em;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 4px;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .proposta-divisor {
      margin: 1rem 0;
      border-top: 2px dashed #dee2e6;
      text-align: center;
      position: relative;
    }
    .proposta-divisor span {
      background: #fff;
      padding: 0 1rem;
      color: #6c757d;
      font-size: 0.75rem;
      position: relative;
      top: -0.6rem;
    }
    
    @media (max-width: 740px) {
      .proposta-linha {gap: 0.3rem; padding: 0.25rem 0.3rem; font-size: 0.8rem;}
      .proposta-org {max-width: 100px;}
    }

  </style>
{% endblock %}

{% block content %}

  <div class="user-info">
    {% include "usuario.html" with user=aluno.user %}

    {% if aluno.matricula %}
      <div class="user-info-row">
        <label>{% lng "Matrícula" "Student ID" %}:</label>
        <span>{{ aluno.matricula }}</span>
      </div>
    {% endif %}

    <div class="user-info-row">
      <label>{% lng "Curso" "Program" %}:</label>
      <span>{{ aluno.curso2 }}</span>
    </div>

    <div class="user-info-row">
      <label>{% lng "Período Capstone" "Capstone Semester" %}:</label>
      <span>
        {% if aluno.ano and aluno.semestre %}
          {{ aluno.ano }}.{{ aluno.semestre }}
        {% else %}
          {% lng "Período não definido" "Not defined" %}
        {% endif %}
      </span>
    </div>
    
    <div class="user-info-row">
      <label>{% lng "Situação Acadêmica" "Academic Status" %}:</label>
      <span>
        {% if aluno.trancado %}
          {% lng "Trancado" "On leave" %}
        {% else %}
          {% lng "Regular" "Regular" %}
        {% endif %}
      </span>
    </div>

    {% if not user.eh_estud and aluno.cr %}
      <div class="user-info-row">
        <label>{% lng "CR" "GPA" %}:</label>
        <span>{% lng_4 aluno.cr %}</span>
      </div>
    {% endif %}

    {% if not user.eh_estud %}
      {% include "dados_usuario.html" with user=aluno.user %}
    {% endif %}

  </div>
  
  <hr>

  {% if aluno.trabalhou %}
    <b>{{aluno.get_trabalhou_help_text }}</b> {{ aluno.trabalhou|linebreaks }}<br>
  {% endif %}

  {% if aluno.atividades %}
    <b>{{aluno.get_atividades_help_text }}</b> {{ aluno.atividades|linebreaks }}<br>
  {% endif %}

  {% if aluno.familia %}
    <b>{{aluno.get_familia_help_text }}</b> {{ aluno.familia|linebreaks }}<br>
  {% endif %}

  
  {% with areas_de_interesse_selecionadas=aluno.user.areadeinteresse_set.all vencido=True com_borda=True %}
    {% include "areas.html" %}
  {% endwith %}
  <br>

  {% if user.eh_prof_a %}

    {% if aluno.opcao_set.all %}
      <hr>
      <h4><i class="fas fa-list-ol"></i> {% lng "Propostas Selecionadas" "Selected Proposals" %}</h4>

      {% select_by_periodo aluno.opcao_set.all aluno.ano aluno.semestre as opcoes_regulares %}
      {% exclude_by_periodo aluno.opcao_set.all aluno.ano aluno.semestre as opcoes_outros %}

      {% if opcoes_regulares %}
        <div class="propostas-list mt-2">
          {% for opcao in opcoes_regulares %}
            <div class="proposta-linha">
              <a href="{% url 'proposta_completa' opcao.proposta.id %}">
                <div class="proposta-prioridade">{{ opcao.prioridade }}</div>
                <div class="proposta-org" title="{{ opcao.proposta.organizacao.nome }}">{{ opcao.proposta.organizacao.nome }}</div>
                <div class="proposta-titulo" title="{{ opcao.proposta.titulo }}">{{ opcao.proposta.titulo }}</div>
                <div class="proposta-periodo">{{ opcao.proposta.ano }}.{{ opcao.proposta.semestre }}</div>
                <div class="proposta-aderencia">{% mede_aderencia aluno opcao.proposta %}%</div>
              </a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info mt-2" role="alert">
          <i class="fas fa-info-circle"></i>
          {% lng "Nenhuma proposta selecionada para o semestre regular." "No proposal selected for the regular semester." %}
        </div>
      {% endif %}

      {% if opcoes_outros %}
        <div class="proposta-divisor">
          <span>{% lng "Outros Semestres" "Other Semesters" %}</span>
        </div>
        <div class="propostas-list">
          {% for opcao in opcoes_outros %}
            <div class="proposta-linha">
              <a href="{% url 'proposta_completa' opcao.proposta.id %}">
                <div class="proposta-prioridade">{{ opcao.prioridade }}</div>
                <div class="proposta-org" title="{{ opcao.proposta.organizacao.nome }}">{{ opcao.proposta.organizacao.nome }}</div>
                <div class="proposta-titulo" title="{{ opcao.proposta.titulo }}">{{ opcao.proposta.titulo }}</div>
                <div class="proposta-periodo">{{ opcao.proposta.ano }}.{{ opcao.proposta.semestre }}</div>
                <div class="proposta-aderencia">{% mede_aderencia aluno opcao.proposta %}%</div>
              </a>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}

    {% if certificados %}
      <hr>
      <h4>{% lng "Certificados" "Certificates" %}</h4>
      <ul>
        {% for certificado in certificados %}
          <li>
            {{certificado.tipo_certificado}}
            {% if certificado.data %}
                em {{certificado.data|date:"DATE_FORMAT"}}
            {% endif %}
            {% if certificado.documento %}
                - documento: <a href="{{ certificado.documento.url }}" target="_blank" rel="noopener noreferrer"><span style="word-break: break-all;">{{ certificado.documento.url }}</span></a><br>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if alocacoes.count > 0 %}
      <hr>
      <h4>{% lng_n alocacoes.count "Alocação" "Alocações" "Allocation" "Allocation2" %}</h4>

      {% for alocacao in alocacoes %}
        <b>{% lng "Projeto" "Project" %}{% if alocacoes.count > 1 %} {{forloop.revcounter}}{% endif %}:</b>
        <a href="{% url 'projeto_infos' alocacao.projeto.id %}">
          [{{alocacao.projeto.organizacao.nome}}] {{alocacao.projeto.get_titulo}}
          ({{alocacao.projeto.ano}}.{{alocacao.projeto.semestre}})
          {% include "tipo_projeto.html" with projeto=alocacao.projeto %}
        </a>
        <br>

        {% include "display_notas_individuais.html" with notas=alocacao|get_notas_alocacao:request descontos=alocacao|get_descontos_alocacao rubricas=True %}
        {% include "display_graficos_individuais.html" %}
        <br><br>

        <!-- RELATOS QUINZENAIS -->
        {% with relatos=alocacao|get_relatos %}
          {% if alocacao.projeto.ano > 2021 and relatos %}
            <span class="tit_rel ml-2"><i class="fas fa-clipboard-list"></i> {% lng "Relatos Quinzenais" "Biweekly Reports" %}</span>
            <div class="relatos-list mt-2">
              {% for evento, relato, ordem in relatos %}
                <div class="relato-linha">
                  <div class="relato-ordem">{{ ordem|add:1 }}&ordm;</div>
                  <div class="relato-data">
                    <i class="far fa-calendar"></i>
                    <span class="texto-longo">{{ evento.endDate|date:"d/m/Y" }}</span>
                    <span class="texto-curto">{{ evento.endDate|date:"d/m/y" }}</span>
                  </div>
                  <div class="relato-status">
                    {% if relato %}
                      <a href="{% url 'relato_visualizar' relato.id %}">
                        {% lng "Preenchido" "Filled" %} ·
                        <span class="texto-longo">{{ relato.momento|date:"d/m/Y H:i" }}</span>
                        <span class="texto-curto">{{ relato.momento|date:"d/m/y H:i" }}</span>
                      </a>
                    {% else %}
                      {% lng "Não preenchido por estudante" "Not filled by student" %}
                    {% endif %}
                  </div>
                  <div class="relato-icone">
                    {% if relato %}
                      {% if relato.avaliacao >= 0 %}
                        {% if relato.avaliacao > 0 %}
                          <span data-toggle="tooltip" data-html="true" animation="true" title="Adequado">&#128077;</span>
                        {% else %}
                          <span data-toggle="tooltip" data-html="true" animation="true" title="Inadequado">&#128078;</span>
                        {% endif %}
                      {% else %}
                        <span data-toggle="tooltip" data-html="true" animation="true" title="Aguardando avaliação">&#x23F3;</span>
                      {% endif %}
                    {% else %}
                      <span data-toggle="tooltip" data-html="true" animation="true" title="Sem preenchimento">—</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <br>
          {% endif %}
        {% endwith %}

        <!-- REUNIÕES -->
        {% with reunioes=alocacao|get_reunioes %}
          {% if reunioes %}
            <span class="tit_rel ml-2"><i class="fas fa-users"></i> {% lng "Reuniões" "Meetings" %}</span>
            <div class="reunioes-list mt-2">
              {% for reuniao in reunioes %}
                {% with participacao=reuniao|get_participacao:alocacao.aluno.user %}
                  <div class="reuniao-linha">
                    <div class="mostra-data-hora">
                      <div class="mostra-data">
                        <i class="far fa-calendar"></i>
                        <span class="texto-longo">{{ reuniao.data_hora|date:"d/m/Y" }}</span>
                        <span class="texto-curto">{{ reuniao.data_hora|date:"d/m/y" }}</span>
                      </div>
                      <div class="mostra-hora">
                        <i class="far fa-clock ml-2"></i>
                        {{ reuniao.data_hora|date:"H:i" }}
                      </div>
                    </div>
                    <div class="reuniao-titulo-compacto" title="{{ reuniao.titulo }}{% if participacao.observacoes %} - {{ participacao.observacoes }}{% endif %}">
                      {{ reuniao.titulo }}
                    </div>
                    {% if participacao %}
                      {% if participacao.situacao == 1 %}
                        <span class="badge badge-success badge-mini">{% lng "Presente" "Present" %}</span>
                      {% elif participacao.situacao == 2 %}
                        <span class="badge badge-danger badge-mini">{% lng "Ausente" "Absent" %}</span>
                      {% elif participacao.situacao == 3 %}
                        <span class="badge badge-warning badge-mini text-dark">{% lng "Justificado" "Excused" %}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge badge-secondary badge-mini">—</span>
                    {% endif %}
                  </div>
                {% endwith %}
              {% endfor %}
            </div>
            <br>
          {% endif %}
        {% endwith %}

        <!-- BANCAS -->
        {% with bancas=alocacao|get_bancas %}
          {% if bancas %}
            <span class="tit_rel ml-2"><i class="fas fa-gavel"></i> {% lng "Participação em Bancas" "Examination Boards" %}</span>
            <div class="bancas-list mt-2">
              {% for banca in bancas %}
                <div class="banca-linha">
                  <a href="{% url 'resultado_bancas' %}?banca={{banca.id}}">
                    <div class="mostra-data-hora">
                      <div class="mostra-data">
                        <i class="far fa-calendar"></i>
                        <span class="texto-longo">{{ banca.startDate|date:"d/m/Y" }}</span>
                        <span class="texto-curto">{{ banca.startDate|date:"d/m/y" }}</span>
                      </div>
                      <div class="mostra-hora">
                        <i class="far fa-clock ml-2"></i>
                        {{ banca.startDate|date:"H:i" }}
                      </div>
                    </div>
                    <div class="banca-tipo" title="{{ banca.composicao.exame }}">{{ banca.composicao.exame }}</div>
                    <span class="badge badge-info badge-mini">
                      {% lng "Ver" "View" %}
                    </span>
                  </a>
                </div>
              {% endfor %}
            </div>
            <br>
          {% endif %}
        {% endwith %}


        {% with documentos=alocacao|get_documentos_individuais %}
          {% if documentos %}
            <span class="tit_rel ml-2"><i class="fas fa-file-alt"></i> {% lng "Documentos Individuais" "Individual Documents" %}</span>
            <div class="caixa_rolante">
              {% include "documentos.html" %}
            </div>
          {% endif %}
        {% endwith %}

        {% if not forloop.last %}
          <hr style="border-top: 3px dotted #8c8b8b;">
        {% endif %}
      
      {% endfor %}
    {% endif %} 

  {% endif %} 
  
  <hr>
  {% include "participacoes_usuario.html" with usuario=aluno.user %}
  
  {% include "estudantes/includes/funcionalidade_respostas.html" %}
  {% include "estudantes/includes/conduta_respostas.html" with individual=True %}

  {% if user.eh_admin %}
    <a href="{% url 'edita_usuario' aluno.user.id %}">
      <button class="btn btn-primary mb-1" style="float: right;">
        {% lng "Editar" "Edit" %}
      </button>
    </a>
  {% endif %}

{% endblock %}