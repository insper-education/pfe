{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 23 de Maio de 2019
{% endcomment %}

{% block head %}
  {% load static %}
  {% load aderencia_aluno %}
  {% load dictionary %}
  {% load l10n %}

  <script src="{% static 'js/Chart.min.js' %}"></script>

{% endblock %}

{% block content %}
  
  <span class="titulo">{{aluno.user.get_full_name}}</span>

  <strong>e-mail:</strong> <a href="mailto:{{aluno.user.email}}"> &lt;{{aluno.user.email}}&gt;</a><br>
  {% if aluno.user.linkedin %}
    <strong>LinkedIn:</strong> <a href="{{aluno.user.linkedin}}" target="_blank">{{aluno.user.linkedin}}</a><br>
  {% endif %}
  {% if aluno.matricula %}
    <strong>Matrícula:</strong> {{aluno.matricula}}<br>
  {% endif %}
  <strong>Curso:</strong> {{aluno.get_curso_display}}<br>
  <strong>Periodo PFE:</strong> {{aluno.anoPFE}}.{{aluno.semestrePFE}}<br>
  <strong>CR:</strong> {{aluno.cr}} <br>

  {% if aluno.trabalhou %}
    <br><strong>{{aluno.get_trabalhou_help_text }}</strong> {{ aluno.trabalhou|linebreaks }}
  {% endif %}  

  {% if aluno.social %}
    <br><strong>{{aluno.get_social_help_text }}</strong> {{ aluno.social|linebreaks }}
  {% endif %}  

  {% if aluno.entidade %}
    <br><strong>{{aluno.get_entidade_help_text }}</strong> {{ aluno.entidade|linebreaks }}
  {% endif %}  

  {% if aluno.familia %}
    <br><strong>{{aluno.get_familia_help_text }}</strong> {{ aluno.familia|linebreaks }}
  {% endif %}  

  <br>
  <strong>Áreas de interesse selecionadas:</strong>
  {% with aa=aluno.user.areadeinteresse_set.all %}
    {% with vencido=True %}
      {% include "areas.html" %}
    {% endwith %}
  {% endwith %}
  <br>

      {% if aluno.opcao_set.all %}
        <hr>
        <h3>Propostas Selecionadas</h3>
        <p id="regular"> 
        {% for opcao in aluno.opcao_set.all %}
            {% if opcao.proposta.ano == opcao.aluno.anoPFE and opcao.proposta.semestre == opcao.aluno.semestrePFE %}
                <a href="{% url 'proposta_completa' opcao.proposta.id %}">
                <p><b>{{opcao.prioridade}}</b> - 
                    {{opcao.proposta.titulo}}
                    ({{opcao.proposta.organizacao.nome}})
                    {{ '{' }}{{opcao.proposta.ano}}.{{opcao.proposta.semestre}}{{ '}' }}
                    |{% mede_aderencia aluno opcao.proposta %}%|
                </p>
                </a>
            {% endif %}
        {% endfor %}
        </p>
        <script>
            if($.trim($("#regular").html())=='') {
                $("#regular").text("Nenhuma proposta selecionada para o semestre regular.");
            }
        </script>
        <p id="quebra" style="line-height:2px; display:none">
            --------------------------------------------------------------------------------------
        </p>
        {% for opcao in aluno.opcao_set.all %}
            {% if opcao.proposta.ano != opcao.aluno.anoPFE or opcao.proposta.semestre != opcao.aluno.semestrePFE %}
                <script>
                  $("#quebra").show();
                </script>
                <a href="{% url 'proposta_completa' opcao.proposta.id %}">
                <p><b>{{opcao.prioridade}}</b> - 
                    {{opcao.proposta.titulo}}
                    ({{opcao.proposta.organizacao.nome}})
                    {{ '{' }}{{opcao.proposta.ano}}.{{opcao.proposta.semestre}}{{ '}' }}
                    |{% mede_aderencia aluno opcao.proposta %}%|
                </p>
                </a>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if alocacoes.count > 0 %}
        <hr>
        <h3>Projeto Alocado</h3>
        {% for alocado in alocacoes %}

            <a href="{% url 'projeto_completo' alocado.projeto.id %}">
            {{alocado.projeto.get_titulo}}
            ({{alocado.projeto.organizacao.nome}})
            { {{alocado.projeto.ano}}.{{alocado.projeto.semestre}} }
            </a>
            <br>
            
            <a style="color:black" href="{% url 'edita_notas' alocado.id %}">
              {% if alocado.get_notas %}
                Notas = 
                {% for aval, nota, peso in alocado.get_notas %}
                  <span style="background-color:#eef;">{{aval}}({% widthratio peso 1 100 %}%)={{nota|floatformat:1}}</span>
                {% endfor %}
                &nbsp;|
              {% endif %}

              &nbsp;
              Média = 
              {% with media=alocado.get_media %}
                {% if media.pesos != 1 %}
                  <a style="color:red" data-toggle="tooltip" data-html="true" animation="true" title="Pesos da média diferente de 100%">
                {% endif %}    
                  {{media.media|floatformat:1}}
                {% if media.pesos != 1 %}
                  </a>
                {% endif %}
              {% endwith %}
            </a>
            
            <div class="row mt-1 justify-content-md-center">
                <div class="col-md-4"><canvas id="radial-geral{{alocado.id}}"></canvas></div>
                <div class="col-md-4"><canvas id="radial-individual{{alocado.id}}"></canvas></div>
                <div class="col-md-4"><canvas id="radial-grupo{{alocado.id}}"></canvas></div>
            </div>
            <small>Cálculo das avaliações supõe mesmo peso para todas as avaliações</small>

            <script>
                var config_radial_individual{{alocado.id}} = {
                    type: 'radar',
                    data: {
                        labels: [
                            {% for key in media_individual %}
                                "{{key}}",
                            {% endfor %}
                            ],
                        datasets: [
                            {
                            label: "Objetivos de Aprendizagem",
                            pointBackgroundColor: [
                                {% for key, value in media_individual.items %}
                                    "{{value.cor}}",
                                {% endfor %}
                                ],
                            data: [
                                {% for key, value in media_individual.items %}
                                    {% if value.media >= 0 %}
                                      {{value.media|stringformat:".2f"|unlocalize}},
                                    {% else %}
                                      null,
                                    {% endif %}
                                {% endfor %}
                                ],
                            scaleOverride: true,
                            pointRadius: 5,
                            backgroundColor: "rgba(0,0,240,0.1)",
                            },
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Avaliação Individual'
                        },
                        scale: {
                            angleLines: {
                                display: false
                            },
                            ticks: {
                                beginAtZero: true,
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                    }
                }

                var config_radial_grupo{{alocado.id}} = {
                    type: 'radar',
                    data: {
                        labels: [
                            {% for key in media_grupo %}
                                "{{key}}",
                            {% endfor %}
                            ],
                        datasets: [
                            {
                            label: "Objetivos de Aprendizagem",
                            pointBackgroundColor: [
                                {% for key, value in media_grupo.items %}
                                    "{{value.cor}}",
                                {% endfor %}
                                ],
                            data: [
                                {% for key, value in media_grupo.items %}
                                    {{value.media|stringformat:".2f"|unlocalize}},
                                {% endfor %}
                                ],
                            scaleOverride: true,
                            pointRadius: 5,
                            backgroundColor: "rgba(0,0,240,0.1)",
                            },
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Avaliação Grupo'
                        },
                        scale: {
                            angleLines: {
                                display: false
                            },
                            ticks: {
                                beginAtZero: true,
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                    }
                }

                var config_radial_geral{{alocado.id}} = {
                    type: 'radar',
                    data: {
                        labels: [
                            {% for key in medias_geral %}
                                "{{key}}",
                            {% endfor %}
                            ],
                        datasets: [
                            {
                            label: "Objetivos de Aprendizagem",
                            pointBackgroundColor: [
                                {% for key, value in medias_geral.items %}
                                    "{{value.cor}}",
                                {% endfor %}
                                ],
                            data: [
                                {% for key, value in medias_geral.items %}
                                    {{value.media|stringformat:".2f"|unlocalize}},
                                {% endfor %}
                                ],
                            scaleOverride: true,
                            pointRadius: 5,
                            backgroundColor: "rgba(0,0,240,0.1)",
                            },
                        ]
                    },
                    options: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Avaliação Geral'
                        },
                        scale: {
                            angleLines: {
                                display: false
                            },
                            ticks: {
                                beginAtZero: true,
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                    }
                }

                // Chart radial do nível nos objetivos de aprendizagem
                var radial_geral{{alocado.id}} = document.getElementById('radial-geral{{alocado.id}}').getContext('2d');
                new Chart(radial_geral{{alocado.id}}, config_radial_geral{{alocado.id}});

                var radial_individual{{alocado.id}} = document.getElementById('radial-individual{{alocado.id}}').getContext('2d');
                new Chart(radial_individual{{alocado.id}}, config_radial_individual{{alocado.id}});

                var radial_grupo{{alocado.id}} = document.getElementById('radial-grupo{{alocado.id}}').getContext('2d');
                new Chart(radial_grupo{{alocado.id}}, config_radial_grupo{{alocado.id}});

            </script>

        {% endfor %}
    {% endif %}

    {% if user.tipo_de_usuario == 4 %}
        <a href="{% url 'edita_usuario' aluno.user.id %}">
        <button style="float: right;">Editar</button>
        </a>
    {% endif %}
    <p>&nbsp;</p>   

    
    <script>

        function carrega_pagina() {  
        }

        window.onload = carrega_pagina
    
    </script>   

{% endblock %}