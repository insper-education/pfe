{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 1 de Junho de 2021
{% endcomment %}

{% load static %}
{% load get_field %}

<style>
  .carregando {
    display: inline-block;
    border: 8px solid #f3f3f3;
    border-top: 8px solid #7498CD;
    border-radius: 100%;
    width: 38px;
    height: 38px;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .col1 {
    -ms-flex: 0 0 20%;
    flex: 0 0 5.2em;
    max-width: 20%;
    position: relative;
    width: 100%;
    padding-right: 6px;
    padding-left: 15px; 
  }

  .col2 {
    -ms-flex: 0 0 calc(100% - 0em);
    flex: 0 0 calc(100% - 5.2em);
    max-width: calc(100% - 0em);
    position: relative;
    width: 100%;
    padding-right: 15px;
    padding-left: 6px;
  }


</style>

<form id="meuForm" method="post" enctype="multipart/form-data">

  {% csrf_token %}

  <div class="modal-header">
    <h5 id="documentacao" class="modal-title">{% if documentos %}Editar{% else %}Adicionar{% endif %} Documento</h5>    
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body">

    <div class="mb-3 row">
      {% if projeto %}
        <div class="col-sm form-label">
          <span for="organizacao">Organização:</span>
          <input type="hidden" id="organizacao" name="organizacao" value="{{projeto.organizacao.id}}"/>
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
          <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">
          {% endif %}
            {{projeto.organizacao.nome}}
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
          </a>
          {% endif %}
        </div>
      {% elif organizacao %}
        <div class="col-sm form-label">
          <span for="organizacao">Organização:</span>
          <input type="hidden" id="organizacao" name="organizacao" value="{{organizacao.id}}"/>
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
            <a href="{% url 'organizacao_completo' organizacao.id %}">
          {% endif %}
            {{organizacao.nome}}
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
            </a>
          {% endif %}
        </div>
      {% else %}
        <label for="organizacao" class="col1 col-form-label" style="overflow: clip; overflow-clip-margin: 0.1em;">Empresa</label>
        <div class="col2">
          <select id="organizacao" name="organizacao" class="form-control">
            <option selected value> -- selecione uma organização -- </option>
            {% for org in organizacoes %}
              <option value="{{org.id}}" {% if org.id == organizacao.id %}selected="selected"{% endif %}>
                {{org.nome|slice:":90"}} ({{org.sigla}})
              </option>
            {% endfor %}
          </select>
        </div>
      {% endif %}
    </div>

    <div class="mb-3 row">
      {% if projeto %}
        <div class="col-sm form-label">
          <span for="projeto">Projeto:</span>
          <input type="hidden" id="projeto" name="projeto" value="{{projeto.id}}"/>
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
            <a href="{% url 'projeto_completo' projeto.id %}">
          {% endif %}
            {{projeto.get_titulo}} ({{projeto.ano}}.{{projeto.semestre}})
          {% if user.tipo_de_usuario == 2 or user.tipo_de_usuario == 4 %}
            </a>  
          {% endif %}
        </div>
      {% else %}
        <label for="projeto" class="col1 col-form-label" style="overflow: clip; overflow-clip-margin: 0.1em;">Projeto</label>
        <div class="col2">
        <select id="projeto" name="projeto" class="form-control">
          <option selected value> -- selecione um projeto -- </option>
          {% for proj in projetos %}
            <option class="proj org{{proj.organizacao.id}}" value="{{proj.id}}" data-org="{{proj.organizacao.id}}" {% if proj.id == projeto.id %}selected="selected"{% endif %}>
              {{proj.organizacao}} - {{proj.get_titulo|slice:":90"}} ({{proj.ano}}.{{proj.semestre}})
              {% include "tipo_projeto.html" with projeto=proj %}
            </option>
          {% endfor %}
        </select>
        </div>
      {% endif %}
    </div>

    <div class="mb-3 row">
      {% if tipo %}
        <div class="col-sm form-label">
          <span for="tipo_documento">Tipo:</span>
          <input type="hidden" id="tipo_documento" name="tipo_documento" value="{{tipo.id}}"/>
          {{tipo.nome}}
        </div>
      {% else %}
        <label for="tipo_documento" class="col1 col-form-label">Tipo</label>
        <div class="col2">
        <select id="tipo_documento" name="tipo_documento" class="form-control" required="required" >
          <option disabled selected value> -- selecione tipo de documento -- </option>
          {% for retorno in tipos_documentos %}
            <option value="{{retorno.id}}" {% if retorno.id == tipo.id %}selected="selected"{% endif %}>
              {{retorno.nome}}
            </option>
          {% endfor %}
        </select>
        </div>
      {% endif %}
    </div>

    <div class="mb-3 row">
      {% if travado %}
        <div class="col-sm form-label">
          <label>Data:</label> <span id="datetime"></span>
        </div>
        <script>
          function updateDateTime() {
            const now = new Date();
            document.querySelector('#datetime').textContent = now.toLocaleString('pt-BR');
          }
          updateDateTime();
          setInterval(updateDateTime, 1000);
        </script>
      {% else %}
        <label for="data" class="col1 col-form-label">Data</label>
        <div class="col2">
          <input id="data" class="form-control" type="datetime-local" name="data" value="{{data|date:'Y-m-d\TH:i'}}">
        </div>
      {% endif %}
    </div>

    {% if not tipo or tipo and tipo.arquivo %}
      <div class="mb-3 row">
        <label for="arquivo" class="col1 col-form-label" style="overflow: clip; overflow-clip-margin: 0.5em;">Arquivo</label>
        <div class="col2">
          <input required id="arquivo" type="file" name="arquivo" class="form-control" style="border: 0px; padding-left: 0px;"
                accept="text/plain, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-powerpoint, application/vnd.openxmlformats-officedocument.presentationml.presentation, image/*, video/mp4, video/x-m4v, video/webm, video/x-matroska, video/*, .mkv">
          {% if documentos %}
            <input type="hidden" id="documentos" name="documentos" value="{{documento_id}}"/>
            <small>Arquivo atual: {% include "documentos.html" %}</small>
          {% endif %}
        </div>
      </div>

      {% if configuracao.maxMB_filesize %}
        <script>
          document.getElementById("arquivo").onchange = function() {
            if(this.files && this.files[0] && this.files[0].size > {{configuracao.maxMB_filesize}}*1048576){
              alert("Tamanho do arquivo maior que o permitido de {{configuracao.maxMB_filesize}}Mb");
              this.value = "";
            }
          }
        </script>
      {% endif %}
    {% endif %}
    
    {% if not tipo or tipo and tipo.link %}
      <div class="mb-3 row">
        <label for="link" class="col1 col-form-label">Link</label>
        <div class="col2">
          <input class="form-control" type="text" style="max-width:100%;display:block" size="73" maxlength="{% max_length Documento "link" %}" id="link" name="link" placeholder="https://">
        </div>
      </div>
    {% endif %}

    <div class="mb-3 row">
      <label for="lingua_do_documento" class="col1 col-form-label" style="overflow: clip; overflow-clip-margin: 0.2em;">Língua</label>
      <div class="col2">
        <select id="lingua_do_documento" name="lingua_do_documento" class="form-control" required="required" >
          <option value="portugues" selected="selected">Português</option>
          <option value="ingles">Inglês</option>
        </select>
      </div>
    </div>

    {% if not travado %}
      <div class="mb-3 row">
        <label for="anotacao" class="col1 col-form-label" style="overflow: clip; overflow-clip-margin: 0.0em;">Anotação</label>
        <div class="col2">
          <input class="form-control" type="text" style="max-width:100%;display:block" size="73" maxlength="{% max_length Documento "anotacao" %}" id="anotacao" name="anotacao">
        </div>
      </div>
    {% endif %}

    {% if not travado %}
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="confidencial" name="confidencial" value="true" checked>
        <label class="form-check-label" for="confidencial">Confidencial</label>
      </div>
    {% endif %}

  </div>

  <div class="modal-footer">    
    <div id="carregando_arquivo" style="float: left; display: none;">Carregando arquivo... <div class="carregando"></div></div>
    <button type="button" class="btn btn-secondary mb-1" data-dismiss="modal">Fechar</button>
    <button id="atualiza" type="submit" class="btn btn-primary mb-1">Enviar</button>
  </div>

  <script>

    $("#organizacao").change(function() {
      if($(this).val()) {
        $(".proj").hide();
        $(".proj.org"+$(this).val()).show();
      } else {
        $(".proj").show();
      }
    });

    $('#projeto').change(function() {
      $('#organizacao').val($('#projeto option:selected').attr('data-org') );

    });

    $('#tipo_documento').change(function() {
      if($(this).val()==26 || $(this).val()==37) { //  (26, 'Relatório Publicado'), 37, 'Materia na Midia'
        $("#confidencial").prop("checked", false);
      } else {
        $("#confidencial").prop("checked", true);
      }
    });
    $("#tipo_documento").trigger("change");  // Para rodar quando estiver carregando

    // Pelo menos um campo deve ser selecionado
    $("#arquivo").change(function() {
      if($(this).val()) {
        $("#link").prop("required", false);
      } else {
        $("#link").prop("required", true);
      }
    });
    //$inputs.not(this).prop('required', !$(this).val().length);

    $('#link').on('input',function(e){
      if($(this).val()) {
        $('#arquivo').prop('required', false);
      } else {
        $('#arquivo').prop('required', true);
      }
    });

  </script>

</form>

<script>
  
  $("form#meuForm").submit(function(e){
      e.preventDefault();
      
      $("#carregando_arquivo").show();

      $.ajaxSetup({
        headers: { "X-CSRFToken": "{{csrf_token}}" }
      });

      var form = $("form#meuForm").closest("form");
      var data = new FormData(form[0]);

      $.ajax({
        type: "POST",
        {% if adiciona == "adiciona_documento" %}
          {% if documento_id %}
            url: "{% url adiciona organizacao.id projeto.id tipo.sigla documento_id %}",
          {% elif tipo %}
            url: "{% url adiciona organizacao.id projeto.id tipo.sigla %}",
          {% elif projeto %}
            url: "{% url adiciona organizacao.id projeto.id %}",
          {% elif organizacao %}
            url: "{% url adiciona organizacao.id %}",
          {% else %}
            url: "{% url adiciona %}",
          {% endif %}
        {% elif adiciona == "adiciona_documento_tipo" %}  
          url: "{% url adiciona tipo.sigla %}",
        {% elif adiciona == "adiciona_documento_estudante" %}
          url: "{% url adiciona tipo.sigla %}",
        {% endif %}
        data: data,
        processData: false,
        contentType: false,   // verificar se isso é assim mesmo
        success: function(response){
          $("#carregando_arquivo").hide();
          $("#popup").modal("hide");
          location.reload();
        },
        error: function (request, status, error) {
          $("#carregando_arquivo").hide();
          $("#popup").modal("hide");
          {% if user.tipo_de_usuario == 4 %} 
            alert(request.responseText);
            jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
            console.log('error'+request.responseText);
          {% else %}
            jQuery("body").html("Erro no servidor. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
          {% endif %}
        }
    });
    return false;
  });
</script> 
