{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 1 de Junho de 2021
{% endcomment %}

<form id="meuForm" method="post"
      {% if documento_id %}
        action="{% url 'adiciona_documento' organizacao.id projeto.id tipo documento_id %}"
      {% elif tipo %}
        action="{% url 'adiciona_documento' organizacao.id projeto.id tipo %}"
      {% elif projeto %}
        action="{% url 'adiciona_documento' organizacao.id projeto.id %}"
      {% else %}
        action="{% url 'adiciona_documento' organizacao.id %}"
      {% endif %}
      enctype="multipart/form-data">

  {% csrf_token %}

  <div class="modal-header">
    <h5 id="documentacao" class="modal-title">{% if documentos %}Editar{% else %}Adicionar{% endif %} Documento</h5>    
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body">

    <label for="data">Data: </label> <input id="data" class="form-control" type="date" name="data" value="{{data|date:'Y-m-d'}}"><br>
    
    <label for="arquivo">Documento:</label> 
    <input required id="arquivo" type="file" name="arquivo" 
    accept="text/plain, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-powerpoint, application/vnd.openxmlformats-officedocument.presentationml.presentation, image/*, video/mp4, video/x-m4v, video/webm, video/x-matroska, video/*, .mkv">
    {% if documentos %}
      <input type="hidden" id="documentos" name="documentos" value="{{documento_id}}"/>
      <br><small>Arquivo atual: {% include "documentos.html" %}</small>
    {% else %}<br>
    {% endif %}
    <br>
    
    {% if configuracao.maxMB_filesize %}
      <script>
        var size = {{configuracao.maxMB_filesize}}*1048576;
        const uploadField = document.getElementById("arquivo");
        uploadField.onchange = function() {
            if(this.files && this.files[0] && this.files[0].size > size){
              alert("Tamanho do arquivo maior que o permitido de {{configuracao.maxMB_filesize}}Mb");
              this.value = "";
            }
        }
      </script>
    {% endif %}
    
    <label for="link">Link:</label> <input required type="text" style="max-width:100%;display:block" size="73" maxlength="73" id="link" name="link" placeholder="https://"><br>
    <br>

    {% if projeto %}
      <span>Projeto:</span>
      <input type="hidden" id="projeto" name="projeto" value="{{projeto.id}}"/>
      <a href="{% url 'projeto_completo' projeto.id %}">
        {{projeto.get_titulo}} ({{projeto.ano}}.{{projeto.semestre}})
      </a><br>
    {% else %}
      <label for="projeto">Projeto:</label>
      <select id="projeto" name="projeto" class="form-control">
        <option selected value> -- nenhum projeto -- </option>
        {% for proj in projetos %}
          <option value="{{proj.id}}" {% if proj.id == projeto.id %}selected="selected"{% endif %}>
            {{proj.get_titulo|slice:":90"}} ({{proj.ano}}.{{proj.semestre}})
            {% include "tipo_projeto.html" with projeto=proj %}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <br>
    {% if projeto %}
      <span for="organizacao">Organização:</span>
      <input type="hidden" id="organizacao" name="organizacao" value="{{projeto.organizacao.id}}"/>
      <a href="{% url 'organizacao_completo' projeto.organizacao.id %}">
      {{projeto.organizacao.nome}}
      </a><br>
    {% elif organizacao %}
      <span for="organizacao">Organização:</span>
      <input type="hidden" id="organizacao" name="organizacao" value="{{organizacao.id}}"/>
      <a href="{% url 'organizacao_completo' organizacao.id %}">
        {{organizacao.nome}}
      </a><br>
    {% else %}
      <label for="organizacao">Organização:</label>
      <select id="organizacao" name="organizacao" class="form-control">
        <option selected value> -- nenhuma organização -- </option>
        {% for org in organizacoes %}
          <option value="{{org.id}}" {% if org.id == organizacao.id %}selected="selected"{% endif %}>
            {{org.nome|slice:":90"}}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <br>
    {% if tipo %}
      <span for="tipo_de_documento">Tipo de documento:</span>
      <input type="hidden" id="tipo_de_documento" name="tipo_de_documento" value="{{tipo}}"/>
      {% for retorno in TIPO_DE_DOCUMENTO %}
          {% if retorno.0|slugify == tipo %}{{retorno.1}}{% endif %}
        {% endfor %}
      <br>
    {% else %}
      <label for="tipo_de_documento">Tipo de documento:</label>
      <select id="tipo_de_documento" name="tipo_de_documento" class="form-control" required="required" >
        <option disabled selected value> -- selecione tipo de documento -- </option>
        {% for retorno in TIPO_DE_DOCUMENTO %}
          <option value="{{retorno.0}}" {% if retorno.0 == tipo %}selected="selected"{% endif %}>
            {{retorno.1}}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <br>
    <label for="lingua_do_documento">Língua do documento:</label>
    <select id="lingua_do_documento" name="lingua_do_documento" class="form-control" required="required" >
      <option value="portugues" selected="selected">Português</option>
      <option value="ingles">Inglês</option>
    </select>

    <br>
    <input type="checkbox" id="confidencial" name="confidencial" value="true" checked>
    <label for="confidencial"> Confidencial</label><br>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
    <button id="atualiza" type="submit" class="btn btn-primary">Enviar</button>
  </div>

  <script>
    $('#tipo_de_documento').change(function() {
      if($(this).val()==25) { //  (25, 'Relatório Publicado'),
        $('#confidencial').prop("checked", false);
      } else {
        $('#confidencial').prop("checked", true);
      }
    });

    // Pelo menos um campo deve ser selecionado
    $('#arquivo').change(function() {
      if($(this).val()) {
        $('#link').prop('required', false);
      } else {
        $('#link').prop('required', true);
      }
    });
    //$inputs.not(this).prop('required', !$(this).val().length);

    $('#link').on('input',function(e){
      if($(this).val()) {
        $('#arquivo').prop('required', false);
      } else {
        $('#arquivo').prop('required', true);
      }
    });

  </script>

</form>

<script>
  $('#atualiza').on('submit', function(e) {
      $('#popup').modal('hide');
      $('form#meuForm').submit();
      return false;
  });
</script> 
