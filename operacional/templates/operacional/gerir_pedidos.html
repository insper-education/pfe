{% extends "base.html" %}
{% load linguas %}
{% load static %}

{% block content %}
<style>
  .pedido-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-left: 4px solid #64748b;
  }
  .pedido-card.status-pendente { border-left-color: #f59e0b; }
  .pedido-card.status-aprovado { border-left-color: #10b981; }
  .pedido-card.status-reprovado { border-left-color: #ef4444; }

  .card-header {
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .card-header:hover {
    background: #f1f5f9;
  }
  
  .card-content {
    padding: 1.5rem;
    display: none;
  }
  .card-content.open {
    display: block;
  }

  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge.pendente { background: #fef3c7; color: #b45309; }
  .badge.aprovado { background: #d1fae5; color: #047857; }
  .badge.reprovado { background: #fee2e2; color: #b91c1c; }
  
  .section-title {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: #334155;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
  }

  .btn-action {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-approve { background: #10b981; color: white; }
  .btn-approve:hover { background: #059669; }
  .btn-reject { background: #ef4444; color: white; }
  .btn-reject:hover { background: #dc2626; }
</style>

<div style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
  <h1 style="margin-bottom: 0.5rem;">{% lng "Gestão de Pedidos de Recursos" "Resource Request Management" %}</h1>
  <p class="text-muted">{% lng "Gerencie as solicitações feitas pelos grupos de projeto." "Manage requests made by project groups." %}</p>

  <h2 class="section-title">{% lng "Pendentes" "Pending" %} <span style="font-size: 0.9rem; background: #f59e0b; color: #fff; padding: 2px 8px; border-radius: 12px; vertical-align: middle;">{{ pedidos_pendentes.count }}</span></h2>
  
  {% if pedidos_pendentes %}
    {% for pedido in pedidos_pendentes %}
      <div class="pedido-card status-pendente">
        <div class="card-header" onclick="toggleCard({{ pedido.id }})">
          <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="font-size: 1.5rem;">{{ pedido.get_icone }}</div>
            <div>
              <div style="font-weight: 600; color: #1e293b;">{{ pedido.get_tipo_display }}</div>
              <div style="color: #64748b; font-size: 0.85rem;">
                 {{ pedido.projeto }} • {{ pedido.solicitante.get_full_name }} • {{ pedido.data_solicitacao|date:"d/m/Y H:i" }}
              </div>
            </div>
          </div>
          <span class="badge pendente">{% lng "PENDENTE" "PENDING" %}</span>
        </div>
        
        <div id="card-{{ pedido.id }}" class="card-content">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
               <div>
                 <h4 style="margin-top: 0; color: #475569;">{% lng "Detalhes do Pedido" "Request Details" %}</h4>
                 <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                   {{ pedido.get_detalhes_completos|safe }}
                 </div>
                 {% if pedido.observacoes %}
                   <div style="margin-top: 1rem;">
                     <strong>{% lng "Observações:" "Notes:" %}</strong> {{ pedido.observacoes|linebreaksbr }}
                   </div>
                 {% endif %}
               </div>
               
               <div>
                 <h4 style="margin-top: 0; color: #475569;">{% lng "Ação da Coordenação" "Coordination Action" %}</h4>
                 
                 <div class="form-group" style="margin-bottom: 1rem;">
                   <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{% lng "Resposta / Justificativa" "Response / Justification" %}</label>
                   <textarea name="resposta" class="form-control" rows="3" style="width: 100%; border-radius: 6px; padding: 0.5rem;" placeholder="Opcionalmente, insira uma resposta..."></textarea>
                 </div>
                 
                 <div style="display: flex; gap: 0.5rem;">
                   <button type="submit" name="acao" value="aprovar" class="btn-action btn-approve">
                     {% lng "Aprovar" "Approve" %}
                   </button>
                   <button type="submit" name="acao" value="reprovar" class="btn-action btn-reject">
                     {% lng "Reprovar" "Reject" %}
                   </button>
                 </div>
               </div>
            </div>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align: center; color: #94a3b8; padding: 2rem;">{% lng "Nenhum pedido pendente." "No pending requests." %}</p>
  {% endif %}


  <h2 class="section-title">{% lng "Processados (Aprovados / Reprovados)" "Processed (Approved / Rejected)" %}</h2>
  
  {% if pedidos_processados %}
    {% for pedido in pedidos_processados %}
      <div class="pedido-card status-{{ pedido.status }}">
        <div class="card-header" onclick="toggleCard({{ pedido.id }})">
          <div style="display: flex; gap: 1rem; align-items: center;">
            <div style="font-size: 1.5rem; opacity: 0.7;">{{ pedido.get_icone }}</div>
            <div>
              <div style="font-weight: 600; color: #1e293b;">{{ pedido.get_tipo_display }}</div>
              <div style="color: #64748b; font-size: 0.85rem;">
                 {{ pedido.projeto }} • {{ pedido.solicitante.get_full_name }} • {{ pedido.data_solicitacao|date:"d/m/Y H:i" }}
              </div>
            </div>
          </div>
          <span class="badge {{ pedido.status }}">{{ pedido.get_status_display|upper }}</span>
        </div>
        
        <div id="card-{{ pedido.id }}" class="card-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
             <div>
               <h4 style="margin-top: 0; color: #475569;">{% lng "Detalhes do Pedido" "Request Details" %}</h4>
               <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                 {{ pedido.get_detalhes_completos|safe }}
               </div>
             </div>
             <div>
               <h4 style="margin-top: 0; color: #475569;">{% lng "Histórico" "History" %}</h4>
               <div style="margin-bottom: 0.5rem;">
                  <strong>{% lng "Status:" "Status:" %}</strong> 
                  <span class="badge {{ pedido.status }}">{{ pedido.get_status_display }}</span>
               </div>
               <div style="margin-bottom: 0.5rem;">
                  <strong>{% lng "Data da Resposta:" "Response Date:" %}</strong> {{ pedido.data_resposta|date:"d/m/Y H:i" }}
               </div>
               <div style="background: #fff; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 6px;">
                 <strong>{% lng "Resposta:" "Response:" %}</strong><br>
                 {{ pedido.resposta|linebreaksbr|default:"-" }}
               </div>
               
               <form method="post" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                 {% csrf_token %}
                 <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
                 <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">{% lng "Mudar decisão:" "Change decision:" %}</div>
                 <div style="display: flex; gap: 1rem;align-items: center;">
                    <textarea name="resposta" class="form-control" rows="1" style="flex:1; border-radius: 6px; padding: 0.5rem;" placeholder="Nova resposta..."></textarea>
                    
                    {% if pedido.status != 'aprovado' %}
                    <button type="submit" name="acao" value="aprovar" class="btn-action btn-approve" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        {% lng "Aprovar" "Approve" %}
                    </button>
                    {% endif %}
                    {% if pedido.status != 'reprovado' %}
                    <button type="submit" name="acao" value="reprovar" class="btn-action btn-reject" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        {% lng "Reprovar" "Reject" %}
                    </button>
                    {% endif %}
                 </div>
               </form>

             </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align: center; color: #94a3b8; padding: 2rem;">{% lng "Nenhum pedido processado ainda." "No processed requests yet." %}</p>
  {% endif %}

</div>

<script>
  function toggleCard(id) {
    const content = document.getElementById('card-' + id);
    if (content.style.display === 'block') {
      content.style.display = 'none';
      content.parentElement.querySelector('.card-header').style.backgroundColor = '#f8fafc';
    } else {
      content.style.display = 'block';
      content.parentElement.querySelector('.card-header').style.backgroundColor = '#f1f5f9';
    }
  }
</script>

{% endblock %}
