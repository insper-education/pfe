{% extends "base.html" %}
{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 3 de Dezembro de 2019
{% endcomment %}

{% block head %}
  {% load static %}
  {% load linguas %}
  {% load get_field %}
  <link rel="stylesheet" href="{% static 'css/indexes.css' %}">
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="card-container">

      {% for group_name, cards in card_groups.items %}
        {% if cards %}
          {% if not forloop.first %}
            <div class="extra-space"></div>
          {% endif %}
          
          {% for card in cards %}
            <div class="card">
              {% if card.direct_link %}
                <a class="link_direto" href="{% url card.url %}">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="{{ card.icon }}"></i> {% lng card.title.pt card.title.en %}
                    </h5>
                  </div>
                </a>
              {% else %}
                <div class="card-body {% if card.highlight_for and user|get_attr:card.highlight_for %}c_destaque{% endif %}" 
                     onclick="loadContent(this, '{% url card.url %}')">
                  <h5 class="card-title">
                    <i class="{{ card.icon }}"></i> {% lng card.title.pt card.title.en %}
                  </h5>
                </div>
                <div class="card-content"></div>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}
      {% endfor %}

    </div>
  </div>

  <script>
    function loadContent(element, url) {
      const cardContent = element.nextElementSibling;
      const dynamicUrl = new URL(url, window.location.origin);
      dynamicUrl.searchParams.set("dynamic", "true");
    
      if (cardContent.style.display === "none" || cardContent.style.display === "") {
        fetch(dynamicUrl)
          .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.text();
          })
          .then(html => {
            cardContent.innerHTML = html;
            $(cardContent).slideDown("fast");
    
            // Extract and execute scripts
            const scripts = cardContent.querySelectorAll("script");
            scripts.forEach(script => {
              const newScript = document.createElement("script");
              if (script.src) newScript.src = script.src;
              else newScript.textContent = script.textContent;
              document.body.appendChild(newScript);
              document.body.removeChild(newScript);
            });
            esconde_lingua();
          })
          .catch(error => {
            console.error("Error loading content:", error);
            cardContent.innerHTML = '<div class="alert alert-danger">Error loading content</div>';
            $(cardContent).slideDown("fast");
          });
      } else {
        $(cardContent).slideUp("fast", () => {
          cardContent.innerHTML = "";
        });
      }
    }
  </script>

{% endblock %}