{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 20 de Janeiro de 2024
{% endcomment %}

{% load static %}
{% load l10n %}
{% load exibe_notas %}
{% load linguas %}
<link rel="stylesheet" href="{% static 'css/one_line.css' %}">

<script>
  function loc(number, locale="pt-BR", frac=1) {return number.toLocaleString(locale, {minimumFractionDigits: frac, maximumFractionDigits: frac});}
</script>

<script>
  var nota_{{alocacao.id}} = 0.0;
  var peso_{{alocacao.id}} = 0.0;
  var descontos_{{alocacao.id}} = 0.0;
</script>

{% if user.eh_admin and alocacao %}
  <a style="color:black" href="{% url 'edita_notas' alocacao.id %}">
{% endif %}

{% if notas or descontos %}

  <div style="overflow-x: auto; width: 100%;">
    <table class="one-line mb-1" style="max-width: 100%;">
      <tbody>
        <tr>
          <td><b>{% lng "Avaliações" "Evaluations" %}</b></td>
          {% for aval in notas %}
            {% if alocacao|exibe_notas:aval.sigla or user.eh_prof_a  %} <!-- Filtra certas avaliações para estudantes não verem -->
            {% if not aval.bloqueado %}
              <td style="cursor:pointer; white-space: nowrap;" data-toggle="tooltip" data-html="true" animation="true" 
              title="{{aval.nome}} | peso={% widthratio aval.peso 1 100 %}%<br>{% for o,p in aval.objetivos.items %}&bull;{{o.titulo}} = <b {% if p.0 < 5 %}class='text-danger'{% endif %}>{{p.0|floatformat:1}}</b><br>{% endfor %}">
                <span class="short">{{aval.sigla}}</span><span class="long">{{aval.nome}}</span> = {% if aval.peso > 0 or aval.sigla == "P" %}{% lng_1 aval.nota %}{% else %}{% if aval.nota >= 5 %}&#128077;{% else %}&#128078;{% endif %}{% endif %}
                {% if not forloop.last %}<span class="short">|</span>{% endif %}
                {% if aval.peso > 0 %}
                  <script>
                    nota_{{alocacao.id}} += {{aval.nota|unlocalize}} * {{aval.peso|unlocalize}};
                    peso_{{alocacao.id}} += {{aval.peso|unlocalize}};
                  </script>
                {% endif %}
              </td>
            {% endif %}
            {% endif %}
          {% endfor %}

          {% if descontos.0 > 0 %}
            <td class="td_desc" style="cursor:pointer; white-space: nowrap;" data-toggle="tooltip" data-html="true" animation="true" 
                title="{% for e in descontos.1 %}{{e}}<br>{% endfor %}">
              {% lng "Descontos" "Discounts" %} = {% lng_2 descontos.0 %}
            </td>
            <script>
              descontos_{{alocacao.id}} = {{descontos.0|unlocalize}};
            </script>
          {% endif %}
          
          <td data-toggle="tooltip" data-html="true" animation="true" title="
          A média é calculada como a soma ponderada das avaliações já realizadas.<br>
          Se houver descontos, eles já foram subtraídos da média calculada e apresentados aqui.
          ">
            <b>{% lng "Média" "Grade" %} = <span id="media{{alocacao.id}}"></span> <span id="aviso{{alocacao.id}}"></span></b>    
          </td>

        </tr>
      </tbody>
    </table>
    
    {% if rubricas %}
      <a class="btn btn-info btn-sm" style="padding: 2px; font-size: 0.75em; margin-top: 2px;"
          href="{% url 'pesos_rubricas' %}"
          target="_blank" rel="noopener noreferrer"
          aria-label="Abrir rubricas, pesos e objetivos em nova aba"
          data-toggle="tooltip" data-html="true" animation="true"
          >
        {% lng 'Rubricas e Pesos ↗' 'Rubrics and Weights ↗' %}
      </a>
    {% endif %}

    <script>

    function mostra_notas_ind_{{alocacao.id}}() {
      lingua = localStorage.getItem("lingua");
      if(peso_{{alocacao.id}} > 0.999) { {% comment %} Considerando que já fechou as notas e é a final {% endcomment %}
        {% with media=alocacao|get_media_alocacao:request %}
          {% if media %}
            {% if media.probation %}
              document.getElementById("media{{alocacao.id}}").innerHTML = "probatório";
              {% if user.eh_admin %}
                document.getElementById("aviso{{alocacao.id}}").innerHTML = "(" + loc({{media.media|unlocalize}}, lingua, 2) + ")";
              {% endif %}
            {% else %}
              document.getElementById("media{{alocacao.id}}").innerHTML = loc({{media.media|unlocalize}}, lingua, 2);
              document.getElementById("aviso{{alocacao.id}}").innerHTML = "(final)";
            {% endif %}
          {% endif %}
        {% endwith %}
      } else { {% comment %} Média provisória {% endcomment %}
        if(peso_{{alocacao.id}} > 0.001) {
          document.getElementById("media{{alocacao.id}}").innerHTML = loc( (nota_{{alocacao.id}}/peso_{{alocacao.id}}) - descontos_{{alocacao.id}}, lingua, 2 );
          document.getElementById("aviso{{alocacao.id}}").innerHTML = "<span style='white-space: nowrap;''> (parcial = " + loc(peso_{{alocacao.id}}*100, lingua, 0 ) +  "%)</span>";
        }
      }
    }
    mostra_notas_ind_{{alocacao.id}}();
    document.addEventListener("languageChanged", mostra_notas_ind_{{alocacao.id}});

    </script>
  </div>
{% endif %}

{% if user.eh_admin and alocacao %}
  </a>
{% endif %}
