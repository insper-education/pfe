{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 20 de Janeiro de 2024
{% endcomment %}

{% load static %}
{% load l10n %}
{% load exibe_notas %}
{% load linguas %}
<link rel="stylesheet" href="{% static 'css/one_line.css' %}">

<script>
  function loc(number, locale="pt-BR", frac=1) {return number.toLocaleString(locale, {minimumFractionDigits: frac, maximumFractionDigits: frac});}
</script>

<script>
  var nota = 0.0;
  var peso = 0.0;
  var descontos = 0.0;
</script>

{% if user.eh_admin and alocacao %}
  <a style="color:black" href="{% url 'edita_notas' alocacao.id %}">
{% endif %}

{% if notas or descontos %}

  <div style="overflow-x: auto; width: 100%;">
    <table class="one-line mb-1" style="max-width: 100%;">
      <tbody>
        <tr>
          <td><b>{% lng "Avaliações" "Evaluations" %}</b></td>
          {% comment %} {% for aval, nota, peso, descr in notas %} {% endcomment %}
          {% for aval in notas %}
            {% if alocacao|exibe_notas:aval.sigla or not user.eh_estud  %} <!-- Filtra certas avaliações para estudantes não verem -->
              <td style="cursor:pointer; white-space: nowrap;" data-toggle="tooltip" data-html="true" animation="true" 
              title="{{aval.nome}} | peso={% widthratio aval.peso 1 100 %}%<br>{% for o,p in aval.objetivos.items %}&bull;{{o.titulo}} = <b {% if p.0 < 5 %}class='text-danger'{% endif %}>{{p.0|floatformat:1}}</b><br>{% endfor %}">
                <span class="short">{{aval.sigla}}</span><span class="long">{{aval.nome}}</span> = {% if aval.peso > 0 or aval.sigla == "P" %}{{aval.nota|floatformat:1}}{% else %}{% if aval.nota >= 5 %}&#128077;{% else %}&#128078;{% endif %}{% endif %}
                {% if not forloop.last %}<span class="short">|</span>{% endif %}
                {% if aval.peso > 0 %}
                  <script>
                    nota += {{aval.nota|unlocalize}} * {{aval.peso|unlocalize}};
                    peso += {{aval.peso|unlocalize}};
                  </script>
                {% endif %}
              </td>
            {% endif %}
          {% endfor %}

          {% if descontos.0 > 0 %}
            <td class="td_desc" style="cursor:pointer; white-space: nowrap;" data-toggle="tooltip" data-html="true" animation="true" 
                title="{% for e in descontos.1 %}{{e}}<br>{% endfor %}">
              {% lng "Descontos" "Discounts" %} = {{descontos.0|floatformat:2}}
            </td>
            <script>
              descontos = {{descontos.0|unlocalize}};
            </script>
          {% endif %}
          
          <td>
            <b>{% lng "Média Final" "Final Grade" %} = <span id="media{{alocacao.id}}">0.0</span> <span id="aviso{{alocacao.id}}"></span></b>    
          </td>

        </tr>
      </tbody>
    </table>
    
    <a class="btn btn-info btn-sm" style="padding: 2px; font-size: 0.75em; margin-top: 2px;"
        href="{% url 'pesos_rubricas' %}"
        target="_blank" rel="noopener noreferrer"
        aria-label="Abrir rubricas, pesos e objetivos em nova aba"
        data-toggle="tooltip" data-html="true" animation="true"
        >
      {% lng 'Rubricas e Pesos ↗' 'Rubrics and Weights ↗' %}
    </a>
    

    <script>
      if(peso > 0.0) {
        {% with media=alocacao|get_media_alocacao:request %}
          {% if media %}
            {% if media.probation %}
              document.getElementById("media{{alocacao.id}}").innerHTML = "probatório";
              {% if user.eh_admin %}
                document.getElementById("media{{alocacao.id}}").innerHTML += " ({{media.media|floatformat:2}})";
              {% endif %}
            {% else %}
              document.getElementById("media{{alocacao.id}}").innerHTML = "{{media.media|floatformat:2}}";
            {% endif %}
          {% endif %}
        {% endwith %}
        if(peso < 0.99) {
            document.getElementById("aviso{{alocacao.id}}").innerHTML = "<span style='white-space: nowrap;''> (média provisória = " + loc( (nota/peso) - descontos ) +  ")</span>";
        }
      }
    </script>
  </div>
{% endif %}

{% if user.eh_admin and alocacao %}
  </a>
{% endif %}
