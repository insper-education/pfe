{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 12 de Novembro de 2020
{% endcomment %}

{% load linguas %}

<style>
  .card-perfil {
    border-radius: 8px;
    border: none;
  }
  
  .card-perfil .card-header {
    border-radius: 8px 8px 0 0 !important;
    border-bottom: none;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
  }
  
  .card-perfil .card-body {
    padding: 1rem;
    max-width: 700px;
  }
  
  .obs {
    font-size: 0.85rem;
    color: #6c757d;
    display: block;
    margin-bottom: 0.75rem;
  }
  
  .perfil-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
  }

  .perfil-table tbody td, .nome_curso {
    width: 150px;
    min-width: 150px;
    max-width: 150px;
  }

  .perfil-table tbody td.vertical-text-tab {
    white-space: nowrap;
    width: 30px;
    min-width: 30px;
    max-width: 30px;  }

  .perfil-table tbody td.row-header {
    white-space: nowrap;
    width: 30px;
    min-width: 30px;
    max-width: 30px;
  }

  .perfil-table thead th {
    background-color: #f8f9fa;
    text-align: center;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    font-weight: 600;
  }

  .perfil-table tbody td {
    text-align: center;
    padding: 0.15rem;
    border: 1px solid #dee2e6;
    transition: background-color 0.15s ease;
  }

  .perfil-table tbody td.row-header {
    background-color: #f8f9fa;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .perfil-table tbody td.vertical-text-tab {
    background-color: #f8f9fa;
    writing-mode: vertical-lr;
    font-weight: 600;
    padding: 0.75rem 0.5rem;
  }
  
  .perfil-table input[type="checkbox"] {
    cursor: pointer;
    width: 14px;
    height: 14px;
    margin: 0;
  }
  
  .perfil-table tbody tr:hover td:not(.vertical-text-tab):not(.row-header) {
    background-color: #f8f9fa;
  }
  
  .linha-vazia {
    background-color: rgba(220, 53, 69, 0.1) !important;
  }

  .perfil-table input[type="checkbox"].coluna-principal {
    cursor: pointer;
    width: 18px; /* Aumentado para 18px para mais visibilidade */
    height: 18px; /* Aumentado para 18px */
    margin: 4px 0;
    border: 2px solid #6f42c1; /* Borda roxa */
    border-radius: 4px; /* Bordas arredondadas */
    background-color: #f8f9fa; /* Fundo claro */
    transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s; /* Transição suave */
    box-shadow: 0 0 5px rgba(110, 58, 193, 0.5); /* Sombra para destaque */
  }

  .perfil-table input[type="checkbox"].coluna-principal:hover {
    background-color: #e9ecef; /* Fundo mais escuro ao passar o mouse */
    border-color: #5a32a3; /* Borda mais escura ao passar o mouse */
    box-shadow: 0 0 10px rgba(110, 58, 193, 0.8); /* Sombra mais intensa ao passar o mouse */
  }

</style>

{% if proposta %}

  <div class="card card-perfil shadow-sm mb-4">
    <div class="card-header text-white">
      <h6 class="mb-0" style="font-size: 0.95rem;">
        <i class="fas fa-users mr-2"></i>
        {% lng "Perfil de Estudantes Esperados" "Expected Student Profile" %}
      </h6>
    </div>
    <div class="card-body">
      
      <small class="obs">
        <i class="fas fa-info-circle mr-1"></i>
        {% lng "Cada linha representa uma vaga que idealmente deve ser preenchida por um estudante dos cursos marcados" "Each row represents a vacancy that should ideally be filled by a student from the marked programs" %}
      </small>
      
      <div class="table-responsive">
        <table class="perfil-table">
          <thead>
            <tr>
              <th colspan="2"></th>
              {% for curso in cursos %}
                {% if curso.curso_do_insper %}
                  <th class="nome_curso">
                    {% lng curso.nome curso.nome_en %}
                    {% if editavel %}
                      <br>
                      <input type="checkbox" id="alunos{{curso.sigla_curta}}" 
                            class="coluna-principal" 
                            data-toggle="tooltip" 
                            title="Marcar/desmarcar toda a coluna">
                    {% endif %}
                  </th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="vertical-text-tab" rowspan="4">
                {% lng "Estudante" "Student" %}
              </td>
              <td class="row-header">#1</td>
              {% for curso in cursos %}
                {% if curso.curso_do_insper %}
                <td class="linha1">
                  {% if editavel %}
                    <label style="margin: 0; cursor: pointer;">
                      <input class="alunos" type="checkbox" 
                            id="alunos{{curso.sigla_curta}}1" 
                            name="alunos{{curso.sigla_curta}}1" 
                            value="{{curso.sigla_curta}}-1" 
                            {% if curso in proposta.perfil1.all %}checked{% endif %}>
                    </label>
                  {% else %}
                    {% if curso in proposta.perfil1.all %}<i class="fas fa-check text-success"></i>{% endif %}
                  {% endif %}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
            <tr>
              <td class="row-header">#2</td>
              {% for curso in cursos %}
                {% if curso.curso_do_insper %}
                <td class="linha2">
                  {% if editavel %}
                    <label style="margin: 0; cursor: pointer;">
                      <input class="alunos" type="checkbox" 
                            id="alunos{{curso.sigla_curta}}2" 
                            name="alunos{{curso.sigla_curta}}2" 
                            value="{{curso.sigla_curta}}-2" 
                            {% if curso in proposta.perfil2.all %}checked{% endif %}>
                    </label>
                  {% else %}
                    {% if curso in proposta.perfil2.all %}<i class="fas fa-check text-success"></i>{% endif %}
                  {% endif %}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
            <tr>
              <td class="row-header">#3</td>
              {% for curso in cursos %}
                {% if curso.curso_do_insper %}
                <td class="linha3">
                  {% if editavel %}
                    <label style="margin: 0; cursor: pointer;">
                      <input class="alunos" type="checkbox" 
                            id="alunos{{curso.sigla_curta}}3" 
                            name="alunos{{curso.sigla_curta}}3" 
                            value="{{curso.sigla_curta}}-3" 
                            {% if curso in proposta.perfil3.all %}checked{% endif %}>
                    </label>
                  {% else %}
                    {% if curso in proposta.perfil3.all %}<i class="fas fa-check text-success"></i>{% endif %}
                  {% endif %}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
            <tr>
              <td class="row-header">#4</td>
              {% for curso in cursos %}
                {% if curso.curso_do_insper %}
                <td class="linha4">
                  {% if editavel %}
                    <label style="margin: 0; cursor: pointer;">
                      <input class="alunos" type="checkbox" 
                            id="alunos{{curso.sigla_curta}}4" 
                            name="alunos{{curso.sigla_curta}}4" 
                            value="{{curso.sigla_curta}}-4" 
                            {% if curso in proposta.perfil4.all %}checked{% endif %}>
                    </label>
                  {% else %}
                    {% if curso in proposta.perfil4.all %}<i class="fas fa-check text-success"></i>{% endif %}
                  {% endif %}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>


  {% if editavel %}
    <script>

      function atualiza_colunas() {
        {% for curso in cursos %}
          {% if curso.curso_do_insper %}
            if( $("#alunos{{curso.sigla_curta}}1").is(":checked") && $("#alunos{{curso.sigla_curta}}2").is(":checked") && $("#alunos{{curso.sigla_curta}}3").is(":checked") && $("#alunos{{curso.sigla_curta}}4").is(":checked") ) {
              $("#alunos{{curso.sigla_curta}}").prop("checked", true); 
              $("#alunos{{curso.sigla_curta}}").prop("indeterminate", false);
            } else if( (! $("#alunos{{curso.sigla_curta}}1").is(":checked")) && (! $("#alunos{{curso.sigla_curta}}2").is(":checked")) && (! $("#alunos{{curso.sigla_curta}}3").is(":checked")) && (! $("#alunos{{curso.sigla_curta}}4").is(":checked")) ) {
              $("#alunos{{curso.sigla_curta}}").prop("checked", false); 
              $("#alunos{{curso.sigla_curta}}").prop("indeterminate", false);
            } else {
              $("#alunos{{curso.sigla_curta}}").prop("indeterminate", true);
            }
          {% endif %}
        {% endfor %}


        if( !(
        {% for curso in cursos %}{% if curso.curso_do_insper %}
          $("#alunos{{curso.sigla_curta}}1").is(":checked")
          {% if not forloop.last %}||{% endif %}
        {% endif %}{% endfor %} 
        ) ) $(".linha1").css("background-color", "#DD111135");
        else $(".linha1").css("background-color", "#FFFFFF00");

        if( !(
        {% for curso in cursos %}{% if curso.curso_do_insper %}
          $("#alunos{{curso.sigla_curta}}2").is(":checked")
          {% if not forloop.last %}||{% endif %}
        {% endif %}{% endfor %} 
        ) ) $(".linha2").css("background-color", "#DD111135");
        else $(".linha2").css("background-color", "#FFFFFF00");

        if( !(
        {% for curso in cursos %}{% if curso.curso_do_insper %}
          $("#alunos{{curso.sigla_curta}}3").is(":checked")
          {% if not forloop.last %}||{% endif %}
        {% endif %}{% endfor %} 
        ) ) $(".linha3").css("background-color", "#DD111135");
        else $(".linha3").css("background-color", "#FFFFFF00");

        if( !(
        {% for curso in cursos %}{% if curso.curso_do_insper %}
          $("#alunos{{curso.sigla_curta}}4").is(":checked")
          {% if not forloop.last %}||{% endif %}
        {% endif %}{% endfor %} 
        ) ) $(".linha4").css("background-color", "#DD111135");
        else $(".linha4").css("background-color", "#FFFFFF00");

      }

      atualiza_colunas();

      $(".alunos").change(function() {
        atualiza_colunas();
      });

      {% for curso in cursos %}
        {% if curso.curso_do_insper %}
          $("#alunos{{curso.sigla_curta}}").change(function() {
            if( $("#alunos{{curso.sigla_curta}}").is(":checked") ) {
              $("#alunos{{curso.sigla_curta}}1").prop("checked", true).change();
              $("#alunos{{curso.sigla_curta}}2").prop("checked", true).change();
              $("#alunos{{curso.sigla_curta}}3").prop("checked", true).change();
              $("#alunos{{curso.sigla_curta}}4").prop("checked", true).change();
            } else {
              $("#alunos{{curso.sigla_curta}}1").prop("checked", false).change();
              $("#alunos{{curso.sigla_curta}}2").prop("checked", false).change();
              $("#alunos{{curso.sigla_curta}}3").prop("checked", false).change();
              $("#alunos{{curso.sigla_curta}}4").prop("checked", false).change();
            }
          });
        {% endif %}
      {% endfor %}

      $(".alunos").change(function () {
        var vaga = $(this).val();
        var checked = $(this).prop("checked");

        $.ajax({
          url: '{% url "validate_alunos" %}',
          data: {
            "proposta": {{proposta.id}},
            "vaga": vaga,
            "checked": checked,
          },
          dataType: "json",
          success: function (response) {},
          {% include "ajax_error_function.js" %}
        });
      });
    </script>
  {% endif %}

{% else %}

    <strong>Não foi possível carregar dados da Proposta!</strong>

{% endif %}