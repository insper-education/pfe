{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 20 de Junho de 2020
{% endcomment %}

{% block head %}

  {% load static %}
  {% load aderencia_aluno %}

  <script src="{% static 'js/Chart.min.js' %}"/></script>
  
  {% comment %} Para chamar os Tooltips {% endcomment %}
  <script>{% include "tooltip.js" %}</script>
  
  <style>

    body {
      line-height: normal;
    }

    .proposta {
        border: solid;
        width: 100%;
        padding-top: 2px;
        padding-bottom: 2px;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        -ms-flex-pack: distribute;
            justify-content: space-around;
    
    }

    .etiqueta_proposta {
        font-size: 1.12em;
        color: black;
        width: 99%;
        text-align: left;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        margin-bottom: 3px;
    }

    .estudante {
        font-size: 12px;
        font-family: Arial, Helvetica, sans-serif;
        padding-left: 3px;
        width: 24%;
        height: 34px;
        background-color: #F0F0F0;
        border: 2px blue solid;
        color: #000;
        text-align: left;
        -webkit-user-select: none;
        -moz-user-select: none;
            -ms-user-select: none;
                user-select: none;
        margin-bottom: 2px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;

    }

    .dragging {
        background-color: gold;
    }

    .opcao {
      padding-right: 2px;
    }

    #logotipo {
      max-height:64px;
      max-width:64px;
      height:auto;
      width:auto;
    }
    
  </style>

{% endblock %}

{% block content %}

  {% if mensagem %}
    <h2 class="red-bold">{{mensagem|linebreaks}}</h2>
    <br>
  {% endif %}

  <span class="titulo">Montar Grupos</span>

  {% if propostas %}

    {% for proposta in propostas %}   

    <div style="width: 100%; border-collapse:separate;">

      <div style="display: flex; align-items: center; align-content: center; margin-bottom: 8px;">
        
        <div style="width: 68px; vertical-align:middle; margin-right: 8px;">

            {% if proposta.organizacao.logotipo %}
              <img id="logotipo" src="{{ proposta.organizacao.logotipo.url }}" alt="{{ proposta.organizacao.sigla }}">
            {% endif %}

        </div>

        <div id="proposta{{proposta.id}}" class="proposta" data-propostaid="{{proposta.id}}">

          <div id="titulo{{proposta.id}}" class="etiqueta_proposta">

            <a target="_blank" rel="noopener noreferrer" class="ancora" href="{% url 'proposta_completa' proposta.id %}" style="color: #000062;"
            data-toggle="tooltip" data-html="true" animation="true" title="
                  {% for opcaop in proposta.opcao_set.all %}
                    {% with alocacoes=opcaop.aluno.alocacao_set %}
                      {% if alocacoes.count %}
                        {% if opcaop.proposta == alocacoes.last.proposta %}
                          <u>
                          {% if opcaop.aluno %}
                            {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                          {% endif %}
                          #{{ opcaop.prioridade }}
                          </u>
                        {% else %}
                          {% if opcaop.aluno %}
                            {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                          {% endif %}
                          #{{ opcaop.prioridade }}
                        {% endif %}
                      {% else %}
                        {% if opcaop.aluno %}
                          {{opcaop.aluno.user.get_full_name}} [{{opcaop.aluno.get_curso_display}}]
                        {% endif %}
                        #{{ opcaop.prioridade }}
                      {% endif %}
                      |{% mede_aderencia opcaop.aluno proposta %}%|<br>
                    {% endwith %}
                  {% empty %}
                    Nenhum aluno escolheu essa proposta
                  {% endfor %}
                  "            
                >
            
            {{proposta.titulo}}
            </a>&nbsp;
            {% if proposta.organizacao and proposta.organizacao.nome %}
              <a class="ancora" href="{% url 'organizacao_completo' proposta.organizacao.id %}" style="color: darkblue;">
                ({{ proposta.organizacao.nome }})
              </a>
            {% elif proposta.nome_organizacao %}
              <a  class="ancora" style="color: darkblue;">({{ proposta.nome_organizacao }})</a>
            {% else %}
              PROBLEMA EM RECUPERAR ORGANIZAÇÃO DA PROPOSTA
            {% endif %}
          </div>

        </div>

        <div style="width: 1.0em; vertical-align:middle; margin-right: 6px; margin-left: 4px;">
          <a class="ancora" style="color: #000062;" data-toggle="tooltip" data-html="true" animation="true" title=
          "{% for rec in proposta.recomendada_set.all %}
            {{rec.disciplina.nome}}<br>
          {% endfor %}">
            <tt style="display: block; font-size: smaller;">
              {% if proposta.perfil_aluno1_computacao %}C{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno1_mecanica %}M{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno1_mecatronica %}X{% else %}&nbsp;{% endif %}<br>
              {% if proposta.perfil_aluno2_computacao %}C{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno2_mecanica %}M{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno2_mecatronica %}X{% else %}&nbsp;{% endif %}<br>
              {% if proposta.perfil_aluno3_computacao %}C{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno3_mecanica %}M{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno3_mecatronica %}X{% else %}&nbsp;{% endif %}<br>
              {% if proposta.perfil_aluno4_computacao %}C{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno4_mecanica %}M{% else %}&nbsp;{% endif %}{% if proposta.perfil_aluno4_mecatronica %}X{% else %}&nbsp;{% endif %}<br>
            </tt>
          </a>
        </div>

      </div>

    </div>

    {% endfor %}

  {% else %}
    <p>Não existem propostas de projetos disponíveis.</p>
  {% endif %}

  <hr>
  <form action="" method="post"> {% csrf_token %}  
    <input type="submit" name="limpar" value="Resetar Pré Alocações" {% if user.tipo_de_usuario != 4 %}disabled{% endif %}>
    <input type="submit" name="fechar" value="Fechar Projetos" {% if user.tipo_de_usuario != 4 %}disabled{% endif %}>
  </form>

  <br><br>

  <input id="balanceada" type="checkbox" name="balanceada" checked onchange="escondePropostas()"/>
  <label for="balanceada">Propostas Balanceadas: <span id="balanceadas">-</span></label><br>
  
  <input id="desbalanceada" type="checkbox" name="desbalanceada" checked onchange="escondePropostas()"/>
  <label for="desbalanceada">Propostas Desbalanceadas: <span id="desbalanceadas">-</span></label><br>

  <input id="vazia" type="checkbox" name="vazia" checked onchange="escondePropostas()"/>
  <label for="vazia">Propostas Vazias: <span id="vazias">-</span></label><br>
  
  <br><br>
  <div class="grafico" id="canvas-holder">
    <canvas id="chart-area"></canvas>
  </div>

  <script>

    function escondePropostas(){

        var propostas = $('.proposta');
        for (var i = 0; i < propostas.length; i++) {
          qtd_estudantes = $(propostas[i]).children('div').length - 1
          if(qtd_estudantes == 0) {
              // VAZIA
              if($('#vazia').is(":checked")) {
                $(propostas[i]).parent().show();
              } else {
                $(propostas[i]).parent().hide();
              }
          } else if(qtd_estudantes > 4 || qtd_estudantes < 3) {
              // DESBAL
              if($('#desbalanceada').is(":checked")) {
                $(propostas[i]).parent().show();
              } else {
                $(propostas[i]).parent().hide();
              }
          } else {
              // BALL
              if($('#balanceada').is(":checked")) {
                $(propostas[i]).parent().show();
              } else {
                $(propostas[i]).parent().hide();
              }
          }
        }

    }

    function cor_estudante(estudante, proposta) {
      prioridades = estudante.data("prioridades")
      var opcao = "X";
      estudante.css("background-color", "#FF7090");
      if (prioridades !== undefined) {
        for (var i = 0; i < prioridades.length; ++i) {
          if(prioridades[i]==proposta) {
            opcao = i+1;
            if(i>4) { // passou da quinta opção
              estudante.css("background-color", "orange");
            } else {
              estudante.css("background-color", "#F0F0F0");
            }
            break
          }
        }
      }
      var anterior = estudante.find(".opcao > span").html();
      estudante.find(".opcao > span").html(opcao);

      return [anterior, opcao];
    }

    count_alunos = 0;
    prioridade1 = 0;
    prioridade2 = 0;
    prioridade3 = 0;
    prioridade4 = 0;
    prioridade5 = 0;
    prioridade6m = 0;
    nao_definido = 0;

    {% for estudante, opcoes in estudantes_opcoes %}
      {% if estudante.pre_alocacao %}
        $("#proposta{{estudante.pre_alocacao.id}}").append(`
      {% else %}
        $("#proposta{{opcoes.0.proposta.id}}").append(`
      {% endif %}
      <div id="estudante{{estudante.id}}" draggable="true" class="estudante" data-cr="{{estudante.cr}}"
      data-prioridades="[{% for opcao in opcoes %}{{opcao.proposta.id}}{%if not forloop.last%},{%endif%}{% endfor %}]">
      <a target="_blank" rel="noopener noreferrer" 
       class="ancora" href="{% url 'estudante_detail' estudante.id %}"
       data-toggle="tooltip" data-html="true" animation="true"
        title="
        {% for opcao in opcoes %}
          <b>#{{ opcao.prioridade }} :</b>
          {{opcao.proposta.titulo}}
          ({{opcao.proposta.organizacao.nome}})
          |{% mede_aderencia estudante opcao.proposta %}%|
          <br>
        {% empty %}
          Estudante não escolheu opções de proposta de projetos
        {% endfor %}  
        ">
        <span id="nome{{estudante.id}}">{{estudante.user.get_full_name}}</span></a>
        <span class="opcao" style="float: right;">opção #<span>1</span></span><br>
      [{{estudante.get_curso}}]&nbsp;&nbsp;&nbsp;CR:&nbsp;{{estudante.cr}}
      </div>
      `);
      {% if estudante.pre_alocacao %}
        
        opcao = cor_estudante($("#estudante{{estudante.id}}"), {{estudante.pre_alocacao.id}})

        // Para o gráfico

        if(opcao[1] == "X") nao_definido += 1;
        else if(opcao[1] == 1) prioridade1 += 1;
        else if(opcao[1] == 2) prioridade2 += 1;
        else if(opcao[1] == 3) prioridade3 += 1;
        else if(opcao[1] == 4) prioridade4 += 1;
        else if(opcao[1] == 5) prioridade5 += 1;
        else prioridade6m += 1;

      {% else %}
        // Se não pre alocado, vai para opcao 1.
        prioridade1 += 1;
      {% endif %}
      
      count_alunos += 1;

    {% endfor %}
    

    </script>

    {% comment %} Mostra gráfico de proporção de prioridades {% endcomment %}
    {% include "grafico_prioridades.html" %}
    
    <script>
    /* ------- */
    var $draggedItem;

    $(document).ready(function() {
        $('.estudante').on('dragstart', dragging);
        $('.estudante').on('dragend', draggingEnded);
        $('.proposta').on('dragenter', preventDefault);
        $('.proposta').on('dragover', preventDefault);
        $('.proposta').on('drop', dropAluno);
        $(window).on('unload', salvar_estado );


        // ORDENA CRs por Projeto
        $('.proposta').each(function(index, element) {
          ordenaCR($(this), "div");
        });

        mostra_grafico();

    });

    function ordenaCR(parent, childSelector) {
      var items = parent.children(childSelector).sort(function(a, b) {
          var obj1 = $(a).data("cr");
          var obj2 = $(b).data("cr");
          return (obj2 < obj1) ? -1 : (obj2 > obj1) ? 1 : 0;
      });
      parent.append(items);
    }

    function salvar_estado() {
      return "SALVAR ESTADO!";
    }
    
    function atualizar_count_propostas() {

      var balanceadas = 0;
      var desbalanceadas = 0;
      var vazias = 0;

      var propostas = $('.proposta');
      for (var i = 0; i < propostas.length; i++) {
        qtd_estudantes = $(propostas[i]).children('div').length - 1
        if(qtd_estudantes == 0) {
            vazias += 1;
        } else if(qtd_estudantes > 4 || qtd_estudantes < 3) {
            desbalanceadas += 1;
        } else {
            balanceadas += 1;
        }
      }

      $("#desbalanceadas").html(desbalanceadas);
      $("#balanceadas").html(balanceadas);
      $("#vazias").html(vazias);

    }

    function colorir_proposta(target) {
        qtd_estudantes = $(target).children('div').length - 1
        if(qtd_estudantes == 0) {
            $(target).css("background-color", "tomato");
        } else if(qtd_estudantes > 4 || qtd_estudantes < 3) {
            $(target).css("background-color", "yellow");
        }
        else {
            $(target).css("background-color", "lime");
        }
        atualizar_count_propostas();
    }

    var observer_proposta = new MutationObserver(function( mutations ) {
        mutations.forEach(function( mutation ) {
            target = $(mutation.target)
            colorir_proposta(target);
        });    
    });

    // Configuration of the observer:
    var config = { 
        childList: true
    };

    var propostas = $('.proposta');
    for (var i = 0; i < propostas.length; i++) {
        colorir_proposta(propostas[i]);
        observer_proposta.observe(propostas[i], config);
    }

    // observer_proposta.disconnect();


    function send_update(estudante, proposta) {
      $.ajax({
        url: '{% url "pre_alocar_estudante" %}',
        data: {
          'estudante': estudante,
          'proposta': proposta,
        },
        dataType: 'json',
        success: function (data) {
          {% comment %}
            if (data.atualizado) {
              console.log("Valor atualizado.");
            } else {
              console.log("Valor não atualizado.");
            }
          {% endcomment %}
        },
        error: function (request, status, error) {
          {% if user.tipo_de_usuario == 4 %} 
            alert(request.responseText);
            jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
            console.log('error'+request.responseText);
          {% else %}
            jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
          {% endif %}
        }
      });
    }

    function dropAluno(e) {
      
      if($draggedItem) {
        var target = $(e.target);
        var final_target = null;

        if (target.attr('class')=="proposta") {
          final_target = target;
        } else if (target.attr('class')=="etiqueta_proposta" || target.attr('class')=="estudante" ) {
          final_target = target.parent();
        } else if (target.attr('class')=="ancora") {
          final_target = target.parent().parent();
        }
        
        if(final_target != null) {
          $draggedItem.detach();
          $draggedItem.appendTo(final_target);
          send_update($draggedItem[0].id, final_target[0].id)
          
          ordenaCR(final_target, "div");

          opcao = cor_estudante($draggedItem, final_target.data("propostaid"))

          // Para o gráfico
          if(opcao[0] == "X" || opcao[0] == undefined ) nao_definido -= 1;
          else if(opcao[0] == 1) prioridade1 -= 1;
          else if(opcao[0] == 2) prioridade2 -= 1;
          else if(opcao[0] == 3) prioridade3 -= 1;
          else if(opcao[0] == 4) prioridade4 -= 1;
          else if(opcao[0] == 5) prioridade5 -= 1;
          else prioridade6m -= 1;

          
          if(opcao[1] == "X" || opcao[1] == undefined ) nao_definido += 1;
          else if(opcao[1] == 1) prioridade1 += 1;
          else if(opcao[1] == 2) prioridade2 += 1;
          else if(opcao[1] == 3) prioridade3 += 1;
          else if(opcao[1] == 4) prioridade4 += 1;
          else if(opcao[1] == 5) prioridade5 += 1;
          else prioridade6m += 1;

          dados = [
            prioridade1,
            prioridade2,
            prioridade3,
            prioridade4,
            prioridade5,
            prioridade6m,
          ];

          labels = [
            '#1 ['+parseInt(100*prioridade1/(count_alunos-nao_definido))+'%]',
            '#2 ['+parseInt(100*prioridade2/(count_alunos-nao_definido))+'%]',
            '#3 ['+parseInt(100*prioridade3/(count_alunos-nao_definido))+'%]',
            '#4 ['+parseInt(100*prioridade4/(count_alunos-nao_definido))+'%]',
            '#5 ['+parseInt(100*prioridade5/(count_alunos-nao_definido))+'%]',
            '#>=6 ['+parseInt(100*prioridade6m/(count_alunos-nao_definido))+'%]',
          ]

          window.myPie.data.datasets[0].data = dados;
          window.myPie.data.datasets[0].labels = labels;
          window.myPie.update();

        }

      }
    }

    function dragging(e) {
      var target = $(e.target);
      if (target.attr('class')=="estudante") {
        $draggedItem = target;
        $draggedItem.addClass('dragging');
      } else if (target.parent().attr('class')=="estudante") {
        $draggedItem = target.parent();
        $draggedItem.addClass('dragging');
      }
    }

    function draggingEnded(e) {
        $draggedItem.removeClass('dragging');
        $draggedItem = null
    }

    function preventDefault(e) {
        e.preventDefault();
    }

  </script>

{% endblock %}