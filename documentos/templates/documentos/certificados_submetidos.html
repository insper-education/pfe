{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 25 de Abril de 2020
{% endcomment %}

{% block head %}
  {% load static %}
  {% load escape_emails %}
  {% load nospaces %}
  <style>

    table, th, td {
    }

    table {
      border: 0px;
      border-collapse: separate;
      border-spacing: 1em;
      padding-left: 0px;
      padding-right: 0px;
    }

    td {
      padding: 1rem 1.2rem;
      border-radius: 6px;
      border: 1px solid red;
    }

    .arrow {
      border: solid black;
      border-width: 0px 2px 2px 0px;
      display: inline-block;
      padding: 2px;
      vertical-align: middle;
    }

    .right {
      transform: rotate(-45deg);
      -webkit-transform: rotate(-45deg);
    }

    #toggle {
      display:inline-block; 
    }

  </style>

{% endblock %}

{% block content %}

  <span class="titulo">Cerfificados</span>

  {% comment %} Seletor da edição da pesquisa {% endcomment %}
  {% include "edicoes.html" %}

  <script>
    $(document).on('click','#informacoes_tag',function(){
      $( "#toggle" ).toggle( "slide" );
    });
  </script>

  <span id="informacoes" style="border: 1px solid gray; border-radius: 2px; padding: 1px; margin-left: 20px;">
    <span id="informacoes_tag">&nbsp;Tipos <i class="arrow right"></i>&nbsp;</span>
    <div id="toggle" style="display: none; height: 1em;">
      <label><input id="estudantes" onchange="($(this).prop('checked') ? $('.estudantes').show() : $('.estudantes').hide())" type="checkbox" checked /> Estudantes</label>&nbsp;&nbsp;&nbsp;
      <label><input id="orientador" onchange="($(this).prop('checked') ? $('.orientador').show() : $('.orientador').hide())" type="checkbox" checked /> Orientadores</label>&nbsp;&nbsp;&nbsp;
      <label><input id="coorientador" onchange="($(this).prop('checked') ? $('.coorientador').show() : $('.coorientador').hide())" type="checkbox" checked /> Coorientadores</label>&nbsp;&nbsp;&nbsp;
      <label><input id="banca" onchange="($(this).prop('checked') ? $('.banca').show() : $('.banca').hide())" type="checkbox" checked /> Bancas</label>&nbsp;&nbsp;&nbsp;
      <label><input id="mentoria_tecnica" onchange="($(this).prop('checked') ? $('.mentoria_tecnica').show() : $('.mentoria_tecnica').hide())" type="checkbox" checked /> Mentorias Técnicas</label>&nbsp;&nbsp;&nbsp;
      <label><input id="mentoria_profissional" onchange="($(this).prop('checked') ? $('.mentoria_profissional').show() : $('.mentoria_profissional').hide())" type="checkbox" checked /> Mentorias Profissional (antiga Mentorial Falconi)</label>&nbsp;&nbsp;&nbsp;
    </div>
  </span> {% comment %} Mais elementos no carrega_pagina() {% endcomment %}
  
  <table id="certificados">

    {% if certificados %}

      {% for certificado in certificados %}

        {% if certificado.tipo_de_certificado < 100 %}
          <tr class="estudantes">
        {% elif certificado.tipo_de_certificado == 101 %}
          <tr class="orientador">
        {% elif certificado.tipo_de_certificado == 102 %}
          <tr class="coorientador">
        {% elif certificado.tipo_de_certificado == 103 or certificado.tipo_de_certificado == 104 or certificado.tipo_de_certificado == 105 %}
          <tr class="banca">
        {% elif certificado.tipo_de_certificado == 106 %}
          <tr class="mentoria_profissional">
        {% elif certificado.tipo_de_certificado == 107 %}
          <tr class="mentoria_tecnica">
        {% endif %}
        
        <td>
          <b>{{certificado.get_certificado}}</b><br>
          {% if certificado.usuario %}
            {% if certificado.usuario.tipo_de_usuario == 1 %}
              <a href="{% url 'estudante_detail' certificado.usuario.aluno.id %}">{{certificado.usuario.get_full_name}}</a><br>
            {% elif certificado.usuario.tipo_de_usuario == 2 or certificado.usuario.tipo_de_usuario == 4 %}
              <a href="{% url 'professor_detail' certificado.usuario.professor.id %}">{{certificado.usuario.get_full_name}}</a><br>
            {% else %}
              {{certificado.usuario.get_full_name}}<br>
            {% endif %}
          {% endif %}

          {% if certificado.projeto %}
            <b>Data do certificado:</b> {{certificado.data|date:"DATE_FORMAT"}}<br>
          {% endif %}

          {% if certificado.projeto %}
            <b>Projeto:</b> <a href="{% url 'projeto_completo' certificado.projeto.id %}">
              {{certificado.projeto.get_titulo}}
            </a><br>
            <b>Período de projeto:</b> {{certificado.projeto.ano}}.{{certificado.projeto.semestre}}<br>
            <b>Organização:</b> <a href="{% url 'organizacao_completo' certificado.projeto.organizacao.id %}">{{ certificado.projeto.organizacao.nome }}</a><br>
          {% endif %}

          {% if certificado.documento %}
            {% comment %} <a href="{{ certificado.documento.url }}"><img style="max-height:240px;" src="{{ certificado.documento.url }}" alt="Certificado {{ certificado.usuario }} {{ certificado.projeto }}"></a><br> {% endcomment %}
            <b>Certificado:</b> 
            <a href="{{ certificado.documento.url }}" target="_blank" rel="noopener noreferrer">{{ certificado.documento.url }}</a><br>
          {% endif %}
          
          
          {% nospaces %}
          &#x2709; Enviar certificado (
          {% with servidor='https://pfe.insper.edu.br' %}
          <a href="mailto:{{certificado.usuario.first_name|parse_quote}}%20{{certificado.usuario.last_name|parse_quote}}%20&lt;{{certificado.usuario.email|parse_quote }}&gt;?cc={{coordenacao.user.get_full_name}}&lt;{{coordenacao.user.email}}&gt;
            &amp;subject=PFE%20Insper%20:
            {% if certificado.tipo_de_certificado == 101 %}
              Orientação de Projeto
            {% elif certificado.tipo_de_certificado == 102 %}
              Coorientação de Projeto
            {% elif certificado.tipo_de_certificado == 103 %}
              Membro de Banca Intermediária
            {% elif certificado.tipo_de_certificado == 104 %}
              Membro de Banca Final
            {% elif certificado.tipo_de_certificado == 105 %}
              Membro de Banca Falconi
            {% elif certificado.tipo_de_certificado == 106 %}
              Mentoria de Projeto
            {% elif certificado.tipo_de_certificado == 107 %}
              Mentoria de Projeto
            {% endif %}
            {% with formatada=True %}
            &amp;body=
              {% include 'mensagem_certificados.html' %}
            " target="_blank" rel="noopener noreferrer">
            {% endwith %}
            formatado
          </a>
          /
          <a href="mailto:{{certificado.usuario.email|parse_quote }}{% comment %}cc=Luciano%20Pereira%20Soares&lt;lpsoares@insper.edu.br&gt;&amp;{% endcomment %}
            ?subject=PFE%20Insper%20:
            {% if certificado.tipo_de_certificado == 101 %}
              Orientação de Projeto
            {% elif certificado.tipo_de_certificado == 102 %}
              Coorientação de Projeto
            {% elif certificado.tipo_de_certificado == 103 %}
              Membro de Banca Intermediária
            {% elif certificado.tipo_de_certificado == 104 %}
              Membro de Banca Final
            {% elif certificado.tipo_de_certificado == 105 %}
              Membro de Banca Falconi
            {% elif certificado.tipo_de_certificado == 106 %}
              Mentoria de Projeto
            {% elif certificado.tipo_de_certificado == 107 %}
              Mentoria de Projeto
            {% endif %}
            {% with formatada=False %}
            &amp;body={% include 'mensagem_certificados.html' %}
            " target="_blank" rel="noopener noreferrer">
            {% endwith %}
            não formatado
          </a>
          {% endwith %}
          )
          {% endnospaces %}
          
        </td>
      </tr>

      {% endfor %}
    
    {% else %}
      <p>Não existem certificados.</p>
    {% endif %}
  
  </table>
  
  <script>

    function carrega_pagina() {
      ($("#estudantes").prop('checked') ? $('.estudantes').show() : $('.estudantes').hide());
      ($("#orientador").prop('checked') ? $('.orientador').show() : $('.orientador').hide());
      ($("#coorientador").prop('checked') ? $('.coorientador').show() : $('.coorientador').hide());
      ($("#banca").prop('checked') ? $('.banca').show() : $('.banca').hide());
      ($("#mentoria_tecnica").prop('checked') ? $('.mentoria_tecnica').show() : $('.mentoria_tecnica').hide());
      ($("#mentoria_profissional").prop('checked') ? $('.mentoria_profissional').show() : $('.mentoria_profissional').hide());
    };

    function carrega_site(){
      var filterEdicao = localStorage.getItem("filterEdicao");
      if (filterEdicao !== null && $("#filterEdicao option[value='"+filterEdicao+"']").length > 0 ) {
        $('#filterEdicao').val(filterEdicao).trigger('change');
      }
      carrega_pagina();
    };

    window.onload = carrega_site

    var request_ajax_c = null;

    var xhrCount = 0;  // Para contar as chamadas e usar somente a última

    $(".filter").change(function(){

      var seqNumber = ++xhrCount;
      
      {% comment %} if (request_ajax_c != null){ 
          request_ajax_c.abort();
          request_ajax_c = null;
      } {% endcomment %}

      $("#spinner").css("visibility", "visible");
      var edicao = $("#filterEdicao option:selected").attr("value");

      request_ajax_c = $.ajax({
        type: "POST",
        url: "{% url 'certificados_submetidos' %}",
        data: {
            edicao: edicao,
            "csrfmiddlewaretoken": "{{ csrf_token }}",
        },
        success: function(response){
          if (seqNumber === xhrCount) { {% comment %} Processando resposta {% endcomment %}
            $("#certificados").replaceWith($("#certificados",response));
            carrega_pagina()
            $("#spinner").css("visibility", "hidden");
          } // else {% comment %} Ignorando resposta {% endcomment %}
        },
        error: function (request, status, error) {
          {% if user.tipo_de_usuario == 4 %} 
            alert(request.responseText);
            jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
            console.log('error'+request.responseText);
          {% else %}
            jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
          {% endif %}
        }
    });
  });

  </script>

{% endblock %}