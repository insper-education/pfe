{% extends "base.html" %}
{% comment %}
  Desenvolvido para o Projeto Final de Engenharia
  Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
  Data: 26 de Janeiro de 2022
{% endcomment %}

{% block head %}
  {% load static %}
  {% load get_field %}
  {% load get_prazo %}
  {% load linguas %}
  <link rel="stylesheet" href="{% static 'css/tab_arrend.css' %}">
  <script src="{% static 'js/aviso_perda_edicao.js' %}"></script>

  <style>

    .relatos_antigos {
      border-collapse: separate;
      border-spacing: 0;
      border: 2px solid black;
      border-radius: 10px;
      width: 85em;
    }

    .relatos_antigos td, .relatos_antigos th {
        border-width: 1px 0px 1px 0px;
        padding: 4px;
        background-color: #F0F0F0;
    }

    .relatos_antigos th:first-child {
      border-width: 0px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    
    .relatos_antigos td:last-child {
      border-bottom-width: 0px;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    .relato {
      border: 1px solid black;
      margin: 6px 10px 8px 10px;
      padding: 4px;
    }

    .feedback-validator {
      position: absolute;
      right: 0; 
      top: -3px;
      margin: 0;
      border-radius: 7px;
      background-color: #f8f97a;
      color: #000;
      font-size: 0.7em;
    }

    .author-name {
      font-family: "Pacifico", cursive;
      font-weight: bold;
      color: #007BFF;
    }

  </style>

  <style>
    .styled-table {
      border-collapse: collapse;
      margin: 28px 0 0 0;
      font-size: 0.9em;
      min-width: 400px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }
  
    .styled-table thead tr th {
      background-color:rgb(43, 131, 204);
      color: #ffffff;
      text-align: center;
    }
  
    .styled-table th,
    .styled-table td {
      padding: 6px 4px;
    }
  
    .styled-table tbody tr {
      border-bottom: 1px solid #dddddd;
    }
  
    .bverde {background-color: #e3ffe3;}
    .bvermelho {background-color: #ffe3e3;}

  </style>

{% endblock %}

{% block content %}

  <form method="post"> {% csrf_token %}

    {% if prazo %}
      {% if fora_periodo %}
        {% lng "Fora do período para a submissão de relatos." "Out of the period for submitting reports." %}
        <br>
        {% lng "Próxima entrega será entre" "Next delivery will be between" %}
        <b style="color:green;">
          <span class="texto-longo">{{inicio_periodo|date:"DATE_FORMAT" }}</span>
          <span class="texto-curto">{{inicio_periodo|date:"d/m/y" }}</span>
        </b>
        {% lng "e" "and" %}
        <b style="color:green;">
          <span class="texto-longo">{{prazo.endDate|date:"DATE_FORMAT" }}</span>
          <span class="texto-curto">{{prazo.endDate|date:"d/m/y" }}</span>
        </b>
      {% else %}
        {% lng "Prazo para a submissão do relato:" "Deadline for submitting the report:" %}
        <b style="color:red;">
          <span class="texto-longo">{{prazo.endDate|date:"DATE_FORMAT" }}</span>
          <span class="texto-curto">{{prazo.endDate|date:"d/m/y" }}</span>
        </b>
      {% endif %}
    {% else %}
      {% lng "Não há datas para fazer relatos." "There are no dates to make reports." %}
    {% endif %}
    
    <br><br>

    <label for="relato">
      {% lng "Informe seu relato quinzenal (máximo" "Report your biweekly report (maximum" %}
      {% max_length Relato "texto" %}
      {% lng "caracteres)" "characters)" %}
    </label><br>
    <textarea id="relato" name="relato" rows="14" cols="160" maxlength="{% max_length Relato "texto" %}" {% if fora_periodo or not prazo %}disabled{% endif %} 
              placeholder="{{msg_relato_quinzenal}}" 
      >{% if texto_relato.texto %}{{texto_relato.texto}}{% endif %}</textarea>
    
    <div style="position: relative;">
      <button type="button" id="feedback-validator" class="feedback-validator">
        <i class="fas fa-check-circle" style="display: none;"></i>
        <i class="fas fa-hourglass fa-spin" style="display: none;"></i>
        Fortnightly Validator by <span class="author-name">Tiago Tavares</span>
      </button>
    </div>
    <div id="feedback-validator-message"></div>
      
    <button {% if fora_periodo or not prazo %}disabled{% endif %} {% if not user.eh_estud %}disabled{% endif %} class="btn btn-primary mb-1 mt-4" type="submit">
      {% lng "Enviar" "Send" %}
    </button>

  </form>

  {% if relatos %}

    <p>&nbsp;</p><hr><p>&nbsp;</p>

    <h4>{% lng "Relatos Anteriores" "Previous Reports" %}:</h4>

    {% for item in relatos %}
    
      {% with prazo=item|get_prazo %}
        {% ifchanged prazo %}
          {% if not forloop.first %}</tbody></table><br>{% endif %}

        <table class="relatos_antigos">
          <thead><tr><th>
            {% if prazo %}
              {{prazo}} -
              <span style="white-space: nowrap;">
                {% lng "Situação: " "Situation: " %}
                {% if item.avaliacao == -1 %}
                  {% lng "aguardando avaliação de orientador" "awaiting advisor evaluation" %}
                {% endif %}
                {% if item.avaliacao == 0 %}<span class="red-bold">
                  {% lng "desempenho abaixo do esperado" "performance below expected" %}
                </span>{% endif %}
                {% if item.avaliacao == 1 %}<span class="green-bold">
                  {% lng "desempenho dentro do esperado" "performance within expected" %}
                </span>{% endif %}
              </span>
            {% else %}
              {% lng "Prazo inválido (não visível para orientador)" "Invalid deadline (not visible to advisor)" %}
            {% endif %}
            {% if item.feedback %}
              {% if item.momento_avaliacao %}
                <i style="display: block;">
                  {% lng "Feedback do Orientador:" "Advisor Feedback:" %}
                  {{item.momento_avaliacao}}</i>
              {% endif %}
              <div id="relato{{item.id}}" class="relato">{{item.feedback|linebreaks}}</div>
            {% endif %}
          </th></tr></thead>
          <tbody><tr><td>
            <i>
              {% lng "Entregue:" "Delivered:" %}
              {{item.momento}}
            </i><br>
            <div class="relato">{{item.texto|linebreaks}}</div>
          </td></tr>
        {% else %}
          <tr><td>
            <i class="anteriores" style="display: block;">
              {% lng "Entregue:" "Delivered:" %}
              {{item.momento}}
              <span class="seta seta-cima"></span>
            </i>
            <div id="relato{{item.id}}" style="display: none;" class="relato">{{item.texto|linebreaks}}</div>
          </td></tr>
        {% endifchanged %}
      {% endwith %}
      
    {% endfor %}
    </tbody></table>
  {% endif %}

  <script>
    $(".anteriores").on("click", function() {
      $(this).siblings("div").toggle(200);
      $("span", this).toggleClass("seta-baixo seta-cima");
    });
  </script>

  <script>
    function generateTable(data) {
      let explic = `
      Esta é a informação que entendi sobre seu texto.<br>
      &bull; As tarefas sem evidêcias foram marcadas como "Não foi possível identificar evidências".<br> 
      &bull; As tarefas difusas foram marcadas como "Tarefa difusa".<br>
      &bull; As tarefas sem autoria própria ("ajudei a", "participei em", etc) foram marcadas como "Tarefa sem autoria".<br>
      Se estiver de acordo, por favor, envie o texto. Se achar que precisa de ajustes, reescreva e tente novamente.<br>
      `;
      let table = "<table class='styled-table'><thead>";
      table += "<tr><td colspan='2'>" + explic + "</td></tr>";
      table += "<tr><th>Tarefa</th><th>Evidência</th></tr>";
      table += "</thead><tbody>";
      data.forEach(row => {
        let rowClass = "";
        if (row["Status"] === "OK") {
          rowClass = "bverde";
        } else if (row["Status"] === "ERRO") {
          rowClass = "bvermelho";
        }
        table += `<tr class="${rowClass}">`;
        table += `<td>${row["Tarefa"]}</td>`;
        table += `<td>${row["Evidencia"]}</td>`;
        table += "</tr>";
      });
      table += "</tbody></table>";
      return table;
    }

    document.getElementById("feedback-validator").addEventListener("click", function() {
      const relatoText = document.getElementById("relato").value;
      document.getElementsByClassName("fa-check-circle")[0].style.display = "none";
      document.getElementsByClassName("fa-hourglass")[0].style.display = "inline-block";
      fetch("{% url 'validate_feedback' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ 
          "texto": relatoText,
          "email": "{{ user.email }}",
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log(data.response_data);
        const tableHTML = generateTable(data.response_data.tarefas);
        document.getElementById("feedback-validator-message").innerHTML = tableHTML;
        document.getElementsByClassName("fa-hourglass")[0].style.display = "none";
        document.getElementsByClassName("fa-check-circle")[0].style.display = "inline-block";
      })
      .catch(error => {
        document.getElementsByClassName("fa-hourglass")[0].style.display = "none";
        console.error("Error:", error);
      });
    });

    aviso_perda_edicao("form", "Você tem alterações não salvas. Tem certeza que deseja sair?");
  </script>

{% endblock %}