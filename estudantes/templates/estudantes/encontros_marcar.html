{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 2 de Outubro de 2019
{% endcomment %}

{% block head %}
    {% load static %}
    <script>{% include "tooltip.js" %}</script>
    {% comment %} <meta http-equiv="refresh" content="5"> {% endcomment %}
   
{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}

    <span class="titulo">Datas para encontros</span>
    
    {% if user.tipo_de_usuario == 1 %}
        <h4>Seu projeto: 
            {% if projeto %}
                {{projeto.get_titulo}} ({{projeto.organizacao}})
            {% else %}
                &lt; PROJETO NÃO ENCONTRADO &gt;
            {% endif %}
        </h4>
    {% else %}
        <h5>Somente visualização das opções de encontros (você não está registrado como estudante)</h5>
    {% endif %}
    <br><br>

    {% if aviso %}
        <h3 class="red-bold">{{aviso|linebreaks}}</h3>
        <br><br>
    {% endif %}

    <div id="horarios" class="control">
        {% for e in encontros %}
            <label class="radio" 
              {% if e.projeto and e.projeto != projeto %}
                 data-toggle="tooltip" data-placement="bottom" title="Horário já selecionado por outro grupo!"
                 style="color:lightgrey" 
              {% elif e.projeto and e.projeto == projeto %}
                 style="color:red" 
                 data-toggle="tooltip" data-placement="bottom" title="Horário selecionado por seu grupo!"
              {% endif %}>
                <input type="radio" name="selection" value="{{e.id}}" 
                {% if e.projeto == projeto %}checked{% endif %}
                {% if e.projeto and e.projeto != projeto %}disabled{% endif %}
                >
                {{e.startDate|date:"d \d\e E \d\e Y \d\a\s H:i"}} às {{e.endDate|date:"H:i"}}
            </label>
            <br>
        {% empty %}
            Sem encontros para marcar.
        {% endfor %}
    </div>

    &nbsp;&nbsp;&nbsp;<button type="submit" 
      {% if user.tipo_de_usuario != 1 or not projeto %}disabled{% endif %}>
        Agendar
    </button>

  <script>

    var refInterval = window.setInterval('update()', 120000); // 2 minutos

    var update = function() {
        $.ajax({
            type: "GET",
            url: '{% url "encontros_marcar" %}',
            data: {    
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response){

                var value = $( "input[type=radio][name=selection]:checked" ).val();

                $("#horarios").replaceWith($("#horarios",response));

                if(!$("input[type=radio][name=selection][value=" + value + "]").prop('disabled')){
                    $("input[type=radio][name=selection][value=" + value + "]").prop('checked', true);
                } 

            },
            error: function (request, status, error) {
                {% if user.tipo_de_usuario == 4 %} 
                    alert(request.responseText);
                    jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
                    console.log('error'+request.responseText);
                {% else %}
                    jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
                {% endif %}
            }
        });
    };

  </script>

</form>
{% endblock %}