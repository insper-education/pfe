{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 2 de Outubro de 2019
{% endcomment %}

{% block head %}
    {% load static %}
    <script>{% include "tooltip.js" %}</script>
    {% comment %} <meta http-equiv="refresh" content="5"> {% endcomment %}
   
{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}

    <span class="titulo">Datas para encontros</span>
    
    {% if user.tipo_de_usuario == 1 %}
        <h5>Seu projeto: 
            {% if projeto %}
                {{projeto.get_titulo}} ({{projeto.organizacao}})
            {% else %}
                &lt; PROJETO NÃO ENCONTRADO &gt;
            {% endif %}
        </h5>
    {% else %}
        <h5>Somente visualização das opções de encontros (você não está registrado como estudante)</h5>
    {% endif %}
    <br><br>

    {% if aviso %}
        <h4 class="red-bold">{{aviso|linebreaks}}</h4>
        <br><br>
    {% endif %}

    <div id="horarios" class="control">
        {% for e in encontros %}
            <label style="display: block;" class="radio" 
              {% if e.projeto and e.projeto != projeto %}
                 data-toggle="tooltip" data-placement="bottom" title="Horário já selecionado por outro grupo!"
                 style="color:lightgrey" 
              {% elif e.projeto and e.projeto == projeto %}
                 style="color:red" 
                 data-toggle="tooltip" data-placement="bottom" title="Horário selecionado por seu grupo!"
              {% endif %}>
                <input type="radio" name="selection" value="{{e.id}}" 
                {% if e.projeto == projeto %}checked{% endif %}
                {% if e.projeto and e.projeto != projeto %}disabled{% endif %}
                >
                {{e.startDate|date:"d \d\e E \d\e Y \d\a\s H:i"}} às {{e.endDate|date:"H:i"}}
            </label>
        {% empty %}
            Sem encontros para marcar.
        {% endfor %}
    </div>

    {% if encontros %}
        <br>
        &nbsp;&nbsp;&nbsp;<button class="btn btn-primary" type="submit" 
        {% if user.tipo_de_usuario != 1 or not projeto %}disabled{% endif %}>
            Agendar
        </button>
    {% endif %}

  <script>

    window.setInterval('update()', 120000); // 2 minutos

    var update = function() {
        $.ajax({
            type: "GET",
            url: '{% url "encontros_marcar" %}',
            data: {    
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response){

                var value = $( "input[type=radio][name=selection]:checked" ).val();

                $("#horarios").replaceWith($("#horarios",response));

                if(!$("input[type=radio][name=selection][value=" + value + "]").prop('disabled')){
                    $("input[type=radio][name=selection][value=" + value + "]").prop('checked', true);
                }
                $('.tooltip-inner').remove();
                $('.tooltip-arrow').remove();

            },
            error: function (request, status, error) {
                {% if user.tipo_de_usuario == 4 %} 
                    alert(request.responseText);
                    jQuery("body").html(request.responseText.replace(/\n/g,"<br>"));
                    console.log('error'+request.responseText);
                {% else %}
                    jQuery("body").html("Erro no servidor do PFE. Por favor contactar: <a href='mailto:lpsoares@insper.edu.br'>lpsoares@insper.edu.br</a>");
                {% endif %}
            }
        });
    };

  </script>

</form>
{% endblock %}