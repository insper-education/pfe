{% extends "base.html" %}
{% comment %}
    Desenvolvido para o Projeto Final de Engenharia
    Autor: Luciano Pereira Soares <lpsoares@insper.edu.br>
    Data: 15 de Maio de 2019
{% endcomment %}

{% block head %}

<style>
table { width: inherit !important; }
</style>
{% endblock %}

{% block content %}

    {% if vencido %}
      <h2 class="red-bold">Você não está cadastrado como estudante.</h2>
    {% else %}

      {% if ano != user.aluno.anoPFE or semestre != user.aluno.semestrePFE %}
        <h2 class="red-bold">Você não está registrado para o PFE em {{ano}}.{{semestre}}</h2>
        <h3 class="red-bold">Caso acredite que existe algum erro na informação, por favor contactar a coordenação do PFE</h3>
        <br>
      {% endif %}

    {% endif %}

    <style>
      .ordenar {
        box-shadow:inset 0px 1px 3px 0px #91b8b3;
        background:linear-gradient(to bottom, #768d87 5%, #6c7c7c 100%);
        background-color:#768d87;
        border-radius:5px;
        border:1px solid #566963;
        display:inline-block;
        cursor:pointer;
        color:#ffffff;
        font-family:Arial;
        font-size:13px;
        font-weight:bold;
        padding:3px 3px;
        text-decoration:none;
        text-shadow:0px -1px 0px #2b665e;
        margin-left:10px;
        margin-bottom: 3px;    
      }

      .ordenar:hover {
        background:linear-gradient(to bottom, #6c7c7c 5%, #768d87 100%);
        background-color:#6c7c7c;
      }

      .ordenar:active {
        position:relative;
        top:1px;
      }

      .alinha {
        display: flex;
        align-items: center;
      }

    </style>
    
    <div class="alinha">
      <span class="titulo">Propostas de Projetos Disponíveis</span>
      <button class="ordenar" onclick="sortTable()">Ordenar</button>
    </div>

    {% if propostas %}
      <form action="" method="post"> {% csrf_token %}
        {% if liberadas_propostas %}
          <table id="propostas" class="table table-hover table-bordered table-sm ">
            <tbody>
            {% for proposta in propostas %} 
              {% if proposta.disponivel %}
                <tr>
                  <th scope="row" class="align-middle">
                    <select id="selection{{proposta.pk}}" name="selection{{proposta.pk}}" 
                    {% if vencido %}disabled{% endif %}></select>
                    <script type="text/javascript">
                      var select = document.getElementById("selection{{proposta.pk}}");
                      select.options[select.options.length] = new Option("--", 0);
                      for(var index=1; index<={{propostas|length}}; index++){
                        select.options[select.options.length] = new Option(index, index);
                      }

                      // Para agora nao encontrei forma mais inteligente de fazer isso
                      {% for opcao in opcoes %} 
                        {% if opcao.proposta.pk == proposta.pk %}
                        select.selectedIndex = {{ opcao.prioridade }};
                        {% endif %}
                      {% endfor %}

                    </script>
                  </th>
                  <td>
                    <a href="{% url 'proposta_detalhes' proposta.pk %}">
                      {% if proposta.titulo %}
                        {{proposta.titulo}}
                      {% else %}
                        PROBLEMA EM RECUPERAR TÍTULO DA PROPOSTA
                      {% endif %}
                      <font color="darkblue">
                        {% if proposta.nome_organizacao %}
                          ({{ proposta.nome_organizacao }})
                        {% elif proposta.organizacao and proposta.organizacao.nome %}
                          ({{ proposta.organizacao.nome }})
                        {% else %}
                          PROBLEMA EM RECUPERAR ORGANIZAÇÃO DA PROPOSTA
                        {% endif %}
                      </font>
                    </a>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
          <p>&nbsp;</p>
        {% else %}
          Propostas ainda não liberadas.
        {% endif %}

        <font color="red">
          {{warnings|linebreaks}}
        </font>

        <div style="display: flex;">      
          
          <input type="submit" style="margin-right: 14px;" value="Enviar" {% if vencido or not liberadas_propostas %}disabled{% endif %}>

          <small style="float: right;"><font color="red">
            Selecione ao menos 5 propostas de projetos (1 ao 5), sendo 1 para a que você tem mais interesse.
          </font></small>
          
        </div>

        <p>&nbsp;</p>
        <p>&nbsp;</p>

      </form>

    {% else %}
      <p>Não existem Propostas de Projetos disponíveis.</p>
    {% endif %}

  <script>
    {% comment %} https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_sort_table_number {% endcomment %}
    function sortTable() {

      var rows, switching, i, x, y, shouldSwitch;
      switching = true;
      while (switching) {
        switching = false;
        rows = $('#propostas > tbody > tr');
        for (i = 0; i < (rows.length - 1); i++) {
          
          shouldSwitch = false;
          
          x = rows[i].getElementsByTagName("TH")[0].getElementsByTagName("select")[0].value;
          y = rows[i + 1].getElementsByTagName("TH")[0].getElementsByTagName("select")[0].value;

          if(x==0) x=Number.POSITIVE_INFINITY;
          if(y==0) y=Number.POSITIVE_INFINITY;

          if (Number(x) > Number(y)) {
            shouldSwitch = true;
            
            break;
          }
        }

        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }

      }
    }
  </script>

{% endblock %}